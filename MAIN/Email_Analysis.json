{
  "name": "Email_Analysis",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "analyze-email-dialog",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "01d39500-672d-41c3-a8e2-221b55d1ffd1",
      "name": "Email Analysis Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1888,
        304
      ],
      "webhookId": "analyze-email-dialog-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°\nconst data = items[0].json.body || items[0].json;\n\nconst analysisType = data.type || 'single';\nconst email = data.email;\nconst threadId = data.threadId;\nconst language = data.language;\n\nreturn [{\n    json: {\n        type: analysisType,\n        email: email,\n        threadId: threadId,\n        language: language,\n        userName: data.userName\n    }\n}];"
      },
      "id": "edfd5978-d604-4a74-a0ab-70dd7ea5883c",
      "name": "Process Analysis Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1344,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ·Ñ‹Ðº Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¸Ð· Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº\nSELECT language_code \nFROM analysis_language_settings \nORDER BY id DESC \nLIMIT 1;",
        "options": {}
      },
      "id": "f9c099c4-6342-465f-a65f-01b77685f46c",
      "name": "Get Analysis Language Setting",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1168,
        288
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑƒÐ·Ð»Ð¾Ð²\nconst requestData = $('Process Analysis Request').first().json;\nconst langSetting = items[0]?.json?.language_code || 'ru';\n\nconsole.log('Email Analysis language from DB:', langSetting);\n\n// ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð´Ð°Ð»ÑŒÑˆÐµ Ñ ÑÐ·Ñ‹ÐºÐ¾Ð¼ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\nreturn [{\n    json: {\n        type: requestData.type,\n        email: requestData.email,\n        threadId: requestData.threadId,\n        language: requestData.language,\n        userName: requestData.userName,\n        analysisLanguage: langSetting\n    }\n}];"
      },
      "id": "fd3f462c-a5c0-4339-9b2e-3d3d0a149bfe",
      "name": "Merge with Language",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ email ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·\nWITH last_analysis AS (\n    SELECT \n        email,\n        updated_at as analysis_date,\n        emotional_tone,\n        customer_needs,\n        missed_opportunities,\n        recommendations,\n        lead_scoring,\n        statistics,\n        satisfaction_percentage\n    FROM email_dialog_analysis\n    WHERE email = '{{ $('Merge with Language').first().json.email }}'\n    ORDER BY updated_at DESC\n    LIMIT 1\n),\nconversation_data AS (\n    SELECT \n        email,\n        updated_at as conversation_updated,\n        message_count\n    FROM gmail_conversations\n    WHERE email = '{{ $('Merge with Language').first().json.email }}'\n    ORDER BY updated_at DESC\n    LIMIT 1\n)\nSELECT \n    COALESCE(cd.email, '{{ $('Merge with Language').first().json.email }}') as email,\n    cd.conversation_updated,\n    cd.message_count,\n    la.analysis_date as last_analysis_date,\n    CASE \n        WHEN cd.conversation_updated IS NULL THEN false\n        WHEN la.analysis_date IS NULL THEN true\n        WHEN cd.conversation_updated > la.analysis_date THEN true \n        ELSE false \n    END as has_new_messages,\n    la.emotional_tone as prev_emotional_tone,\n    la.customer_needs as prev_customer_needs,\n    la.missed_opportunities as prev_missed_opportunities,\n    la.recommendations as prev_recommendations,\n    la.lead_scoring as prev_lead_scoring,\n    la.statistics as prev_statistics,\n    la.satisfaction_percentage as prev_satisfaction\nFROM conversation_data cd\nFULL OUTER JOIN last_analysis la ON true;",
        "options": {}
      },
      "id": "ea5d5b04-d3cb-4f6a-bc2c-8f51be47b982",
      "name": "Check for New Email Messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -832,
        288
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐœÐµÑ€Ð¶Ð¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Check for New Email Messages Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¸Ð· Merge with Language\nconst checkResult = items[0].json;\nconst mergedData = $('Merge with Language').first().json;\n\n// ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSONB Ð¿Ð¾Ð»Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\nconst parseJsonField = (field) => {\n    if (!field) return null;\n    if (typeof field === 'string') {\n        try {\n            return JSON.parse(field);\n        } catch (e) {\n            return field;\n        }\n    }\n    return field;\n};\n\n// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\nconst previousAnalysis = checkResult.last_analysis_date ? {\n    emotionalTone: parseJsonField(checkResult.prev_emotional_tone),\n    customerNeeds: parseJsonField(checkResult.prev_customer_needs),\n    missedOpportunities: parseJsonField(checkResult.prev_missed_opportunities),\n    recommendations: parseJsonField(checkResult.prev_recommendations),\n    leadScoring: parseJsonField(checkResult.prev_lead_scoring),\n    statistics: parseJsonField(checkResult.prev_statistics),\n    satisfaction: checkResult.prev_satisfaction,\n    analysisDate: checkResult.last_analysis_date\n} : null;\n\nconsole.log('ðŸ“Š Email Check result:', {\n    hasNewMessages: checkResult.has_new_messages,\n    conversationUpdated: checkResult.conversation_updated,\n    lastAnalysis: checkResult.last_analysis_date,\n    messageCount: checkResult.message_count,\n    hasPreviousAnalysis: !!previousAnalysis\n});\n\nreturn [{\n    json: {\n        // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Merge with Language\n        type: mergedData.type,\n        email: mergedData.email,\n        threadId: mergedData.threadId,\n        language: mergedData.language,\n        userName: mergedData.userName,\n        analysisLanguage: mergedData.analysisLanguage,\n        \n        // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Check for New Email Messages\n        has_new_messages: checkResult.has_new_messages,\n        conversation_updated: checkResult.conversation_updated,\n        last_analysis_date: checkResult.last_analysis_date,\n        message_count: checkResult.message_count,\n        \n        // ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ Ð² AI\n        previousAnalysis: previousAnalysis\n    }\n}];"
      },
      "id": "b3a1265f-5420-4d97-9cf5-5331da40bf6a",
      "name": "Merge Check Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-new-email-messages",
              "leftValue": "={{ $json.has_new_messages }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ca5a0d73-2f35-480e-af52-bf23a60b5dc6",
      "name": "IF: Has New Messages",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -416,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· email\nSELECT \n    email,\n    analysis_type,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    lead_scoring,\n    statistics,\n    satisfaction_percentage,\n    created_at,\n    updated_at\nFROM email_dialog_analysis\nWHERE email = '{{ $('Merge Check Data').first().json.email }}'\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "3be2e34c-477e-4369-bada-82dcad647219",
      "name": "Get Existing Email Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -208,
        512
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· email Ð´Ð»Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð°\nconst existingAnalysis = items[0].json;\nconst checkData = $('Merge Check Data').first().json;\n\nconsole.log('ðŸ“‹ Returning existing email analysis - no new messages');\nconsole.log('Last analysis date:', checkData.last_analysis_date);\nconsole.log('Conversation updated:', checkData.conversation_updated);\n\n// ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSONB Ð¿Ð¾Ð»Ñ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ¸\nconst parseJsonField = (field) => {\n    if (!field) return null;\n    if (typeof field === 'string') {\n        try {\n            return JSON.parse(field);\n        } catch (e) {\n            return field;\n        }\n    }\n    return field;\n};\n\nreturn [{\n    json: {\n        // ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\n        emotionalTone: parseJsonField(existingAnalysis.emotional_tone),\n        customerNeeds: parseJsonField(existingAnalysis.customer_needs),\n        missedOpportunities: parseJsonField(existingAnalysis.missed_opportunities),\n        recommendations: parseJsonField(existingAnalysis.recommendations),\n        leadScoring: parseJsonField(existingAnalysis.lead_scoring),\n        statistics: parseJsonField(existingAnalysis.statistics),\n        \n        // Email Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€\n        email: existingAnalysis.email || checkData.email,\n        \n        // ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ\n        _cached: true,\n        _lastAnalysisDate: checkData.last_analysis_date,\n        _conversationUpdated: checkData.conversation_updated,\n        _messageCount: checkData.message_count\n    }\n}];"
      },
      "id": "e3816139-e0d0-4bc4-ac17-23022dcbb0fb",
      "name": "Format Existing Email Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        512
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "2c8b3358-1943-43bd-abfc-4be44472ce4a",
      "name": "Return Existing Email Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        208,
        512
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.type }}",
              "rightValue": "single",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "single-analysis-check"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "75c2e9fd-dcb0-44e3-9829-4bad1a97239a",
      "name": "Check Analysis Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -208,
        96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ email Ð´Ð¸Ð°Ð»Ð¾Ð³ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·)\nSELECT \n    gc.email,\n    gc.thread_id,\n    gc.subject,\n    gc.messages,\n    gc.status,\n    gc.lead_score,\n    gc.language,\n    gc.message_count,\n    gc.created_at,\n    gc.updated_at,\n    '{{ $('Merge Check Data').first().json.last_analysis_date }}' as last_analysis_date\nFROM gmail_conversations gc\nWHERE gc.email = '{{ $('Merge Check Data').first().json.email }}'\nORDER BY gc.updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "6d81e7db-4c56-474a-9927-373aa6a23d53",
      "name": "Get Single Email Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ email Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\nSELECT \n    gc.email,\n    gc.thread_id,\n    gc.subject,\n    gc.messages,\n    gc.status,\n    gc.lead_score,\n    gc.language,\n    gc.message_count,\n    gc.created_at,\n    gc.updated_at,\n    '{{ $('Merge Check Data').first().json.last_analysis_date }}' as last_analysis_date\nFROM gmail_conversations gc\nWHERE \n    gc.created_at >= NOW() - INTERVAL '30 days'\n    {{ $('Merge Check Data').first().json.language ? \"AND gc.language = '\" + $('Merge Check Data').first().json.language + \"'\" : \"\" }}\nORDER BY gc.updated_at DESC;",
        "options": {}
      },
      "id": "4e033833-ef48-4c6f-a0d0-ec6fb19e7c2e",
      "name": "Get All Email Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        192
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ email Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\nconst dialogs = items;\nconst mergedData = $('Merge Check Data').first().json;\nconst analysisType = mergedData.type;\nconst analysisLanguage = mergedData.analysisLanguage || 'ru';\nconst lastAnalysisDate = mergedData.last_analysis_date;\nconst previousAnalysis = mergedData.previousAnalysis;\n\nconsole.log('Formatting email dialogs for language:', analysisLanguage);\nconsole.log('Last analysis date:', lastAnalysisDate);\nconsole.log('Has previous analysis:', !!previousAnalysis);\n\n// Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ email\nconst emailDialogs = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    const email = data.email;\n    \n    if (!emailDialogs[email]) {\n        // ÐŸÐ°Ñ€ÑÐ¸Ð¼ messages\n        let messages = [];\n        try {\n            messages = typeof data.messages === 'string' \n                ? JSON.parse(data.messages) \n                : data.messages || [];\n        } catch (e) {\n            console.error('Error parsing messages:', e);\n            messages = [];\n        }\n        \n        // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· - Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐÐžÐ’Ð«Ð• ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ\n        let filteredMessages = messages;\n        let allMessages = messages;\n        \n        if (lastAnalysisDate && lastAnalysisDate !== 'null' && lastAnalysisDate !== '') {\n            const lastAnalysisTime = new Date(lastAnalysisDate).getTime();\n            filteredMessages = messages.filter(msg => {\n                const msgTime = new Date(msg.date).getTime();\n                return msgTime > lastAnalysisTime;\n            });\n            console.log(`Filtered messages: ${filteredMessages.length} new out of ${messages.length} total`);\n        }\n        \n        emailDialogs[email] = {\n            email: email,\n            threadId: data.thread_id,\n            subject: data.subject,\n            language: data.language,\n            messageCount: data.message_count || messages.length,\n            newMessageCount: filteredMessages.length,\n            leadScore: data.lead_score,\n            messages: filteredMessages,\n            allMessages: allMessages\n        };\n    }\n});\n\n// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ AI Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐ°\nconst dialogsForAnalysis = Object.values(emailDialogs).map((dialog) => {\n    // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÐ·Ñ‹ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\n    const clientLabel = analysisLanguage === 'en' ? 'Client' : \n                        analysisLanguage === 'es' ? 'Cliente' : \n                        analysisLanguage === 'fr' ? 'Client' : \n                        analysisLanguage === 'de' ? 'Kunde' : \n                        analysisLanguage === 'it' ? 'Cliente' : \n                        analysisLanguage === 'pt' ? 'Cliente' : \n                        analysisLanguage === 'zh' ? 'å®¢æˆ·' : \n                        analysisLanguage === 'ja' ? 'é¡§å®¢' : \n                        analysisLanguage === 'ko' ? 'ê³ ê°' : \n                        analysisLanguage === 'ua' ? 'ÐšÐ»Ñ–Ñ”Ð½Ñ‚' : \n                        'ÐšÐ»Ð¸ÐµÐ½Ñ‚';\n    \n    const botLabel = analysisLanguage === 'en' ? 'Bot' : \n                     analysisLanguage === 'es' ? 'Bot' : \n                     analysisLanguage === 'fr' ? 'Bot' : \n                     analysisLanguage === 'de' ? 'Bot' : \n                     analysisLanguage === 'it' ? 'Bot' : \n                     analysisLanguage === 'pt' ? 'Bot' : \n                     analysisLanguage === 'zh' ? 'æœºå™¨äºº' : \n                     analysisLanguage === 'ja' ? 'ãƒœãƒƒãƒˆ' : \n                     analysisLanguage === 'ko' ? 'ë´‡' : \n                     analysisLanguage === 'ua' ? 'Ð‘Ð¾Ñ‚' : \n                     'Ð‘Ð¾Ñ‚';\n    \n    const conversation = dialog.messages.map(msg => \n        `${msg.type === 'incoming' ? clientLabel : botLabel}: ${msg.content}`\n    ).join('\\n');\n    \n    return {\n        email: dialog.email,\n        threadId: dialog.threadId,\n        subject: dialog.subject,\n        language: dialog.language,\n        conversation: conversation,\n        newMessageCount: dialog.newMessageCount,\n        totalMessageCount: dialog.allMessages.length\n    };\n});\n\n// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼, ÑÑ‚Ð¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ\nconst isUpdate = !!previousAnalysis;\n\nreturn [{\n    json: {\n        type: analysisType,\n        email: mergedData.email,\n        dialogs: dialogsForAnalysis,\n        totalDialogs: dialogsForAnalysis.length,\n        analysisLanguage: analysisLanguage,\n        isUpdate: isUpdate,\n        previousAnalysis: previousAnalysis\n    }\n}];"
      },
      "id": "40708d1b-9fc9-4a5f-9698-f7681dcc80d1",
      "name": "Format Email Dialogs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        96
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Ð¯Ð·Ñ‹Ðº Ð²Ñ‹Ð²Ð¾Ð´Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²: {{ $json.analysisLanguage || 'ru' }}\nÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž: Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð’Ð¡Ð• Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° ÑÐ·Ñ‹ÐºÐµ: {{ \n  $json.analysisLanguage === 'ru' ? 'Ð ÑƒÑÑÐºÐ¸Ð¹' : \n  $json.analysisLanguage === 'en' ? 'English' : \n  $json.analysisLanguage === 'es' ? 'EspaÃ±ol' : \n  $json.analysisLanguage === 'fr' ? 'FranÃ§ais' : \n  $json.analysisLanguage === 'de' ? 'Deutsch' : \n  $json.analysisLanguage === 'it' ? 'Italiano' : \n  $json.analysisLanguage === 'pt' ? 'PortuguÃªs' : \n  $json.analysisLanguage === 'zh' ? 'ä¸­æ–‡' : \n  $json.analysisLanguage === 'ja' ? 'æ—¥æœ¬èªž' : \n  $json.analysisLanguage === 'ko' ? 'í•œêµ­ì–´' : \n  $json.analysisLanguage === 'ua' ? 'Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°' : \n  'Ð ÑƒÑÑÐºÐ¸Ð¹' \n}}\n\nÐ¢Ð¸Ð¿ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°: {{ $json.type }}\nÐ ÐµÐ¶Ð¸Ð¼: {{ $json.isUpdate ? 'ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°' : 'ÐŸÐ•Ð Ð’Ð˜Ð§ÐÐ«Ð™ Ð°Ð½Ð°Ð»Ð¸Ð·' }}\n\n{{ $json.isUpdate && $json.previousAnalysis ? `\n========================================\nÐŸÐ Ð•Ð”Ð«Ð”Ð£Ð©Ð˜Ð™ ÐÐÐÐ›Ð˜Ð— (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ°Ðº Ð±Ð°Ð·Ñƒ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ):\n========================================\n\nÐ­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½: ${JSON.stringify($json.previousAnalysis.emotionalTone, null, 2)}\n\nÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: ${JSON.stringify($json.previousAnalysis.customerNeeds, null, 2)}\n\nÐ£Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸: ${JSON.stringify($json.previousAnalysis.missedOpportunities, null, 2)}\n\nÐ ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸: ${JSON.stringify($json.previousAnalysis.recommendations, null, 2)}\n\nLead Scoring: ${JSON.stringify($json.previousAnalysis.leadScoring, null, 2)}\n\nÐ¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°: ${JSON.stringify($json.previousAnalysis.statistics, null, 2)}\n\n========================================\nÐÐžÐ’Ð«Ð• Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð¯ Ð”Ð›Ð¯ ÐÐÐÐ›Ð˜Ð—Ð:\n========================================\n` : '========================================\\nÐ”Ð˜ÐÐ›ÐžÐ“Ð˜ Ð”Ð›Ð¯ ÐŸÐ•Ð Ð’Ð˜Ð§ÐÐžÐ“Ðž ÐÐÐÐ›Ð˜Ð—Ð:\\n========================================\\n' }}\n\n{{ $json.dialogs.map((d, i) => `\n--- Email Ð´Ð¸Ð°Ð»Ð¾Ð³ ${i+1} (${d.email}, ${d.language}) ---\nÐ¢ÐµÐ¼Ð°: ${d.subject}\n${ $json.isUpdate ? `ÐÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: ${d.newMessageCount} Ð¸Ð· ${d.totalMessageCount} Ð¾Ð±Ñ‰Ð¸Ñ…` : `Ð’ÑÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: ${d.totalMessageCount}` }\n\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "=#Ð Ð¾Ð»ÑŒ: Ð’Ñ‹ â€” ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚ Ð¿Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ñƒ email-Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸ Ð¼ÐµÐ¶Ð´Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÐµÐ¹ Cryptomator.\n\n---\n\n# ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž - Ð¯Ð—Ð«Ðš Ð’Ð«Ð’ÐžÐ”Ð\n\n**Ð’Ð¡Ð• Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð”ÐžÐ›Ð–ÐÐ« Ð±Ñ‹Ñ‚ÑŒ Ð½Ð° ÑÐ·Ñ‹ÐºÐµ, ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¼ Ð² \"Ð¯Ð·Ñ‹Ðº Ð²Ñ‹Ð²Ð¾Ð´Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²\"!**\n\nÐ­Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚:\n- Ð’ÑÐµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ð² emotionalTone (overall, overallText, description)\n- Ð’Ð¡Ð• ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð² customerNeeds, missedOpportunities, recommendations\n- Ð’ÑÐµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð² leadScoring (recommendation)\n- Ð’ÑÐµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð² statistics\n\n**ÐÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ ÑÐ·Ñ‹ÐºÐ° Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð², Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð° ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ Ð²Ñ‹Ð²Ð¾Ð´Ð°!**\n\n---\n\n# ðŸ”„ Ð Ð•Ð–Ð˜Ðœ Ð ÐÐ‘ÐžÐ¢Ð«\n\n## Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n1. **Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÐºÐ°Ðº Ð±Ð°Ð·Ñƒ** â€” Ð½Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ð¹ Ñ Ð½ÑƒÐ»Ñ\n2. **ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐÐžÐ’Ð«Ð• ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ** â€” Ð¾Ð½Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾\n3. **ÐžÐ‘ÐÐžÐ’Ð˜ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ** Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸:\n   - Lead Score Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð²Ñ‹ÑÐ¸Ñ‚ÑŒÑÑ Ð¸Ð»Ð¸ Ð¿Ð¾Ð½Ð¸Ð·Ð¸Ñ‚ÑŒÑÑ\n   - ÐœÐ¾Ð³ÑƒÑ‚ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑŒÑÑ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ (Ð´Ð¾Ð±Ð°Ð²ÑŒ Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼)\n   - Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒÑÑ\n   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒÑÑ\n4. **Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ** â€” Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÐ¹ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\n5. **ÐžÑ‚Ð¼ÐµÑ‡Ð°Ð¹ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ** â€” ÐµÑÐ»Ð¸ Lead Score Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ, Ð¾Ñ‚Ñ€Ð°Ð·Ð¸ ÑÑ‚Ð¾ Ð² recommendation\n\n## Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ ÐŸÐ•Ð Ð’Ð˜Ð§ÐÐ«Ð™ Ð°Ð½Ð°Ð»Ð¸Ð·:\n- ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð²ÐµÑÑŒ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ñ Ð½ÑƒÐ»Ñ\n- Ð¡Ð»ÐµÐ´ÑƒÐ¹ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¼ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸ÑÐ¼ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°\n\n---\n\n#Ð—Ð°Ð´Ð°Ñ‡Ð°: ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ email-Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸ Ð¸ Ð¾Ñ†ÐµÐ½Ð¸Ñ‚ÑŒ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ, Ð²Ñ‹ÑÐ²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð², Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑƒÐ¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ð´Ð°Ð¶ Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸ÑŽ.\n\n#ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:\n\n1. **Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸**:\n   - ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚Ðµ Ð¾Ð±Ñ‰Ð¸Ð¹ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½ (Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹, Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹, Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹)\n   - ÐžÑ†ÐµÐ½Ð¸Ñ‚Ðµ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑƒÐ´Ð¾Ð²Ð»ÐµÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (0-100%)\n   - ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÑƒ ÑÐ¼Ð¾Ñ†Ð¸Ð¹ Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ\n\n2. **Ð’Ñ‹ÑÐ²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°**:\n   - ÐŸÐµÑ€ÐµÑ‡Ð¸ÑÐ»Ð¸Ñ‚Ðµ ÑÐ²Ð½Ñ‹Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹\n   - ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚Ðµ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ñ‡Ð°ÑÑ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹\n   - Ð’Ñ‹ÑÐ²Ð¸Ñ‚Ðµ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸\n\n3. **Ð£Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾Ð´Ð°Ð¶**:\n   - Ð’Ñ‹Ð´ÐµÐ»Ð¸Ñ‚Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹\n   - Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½ÐµÑ€ÐµÑˆÑ‘Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹\n   - ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ Ð½ÐµÐ¿Ð¾Ð»Ð½Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²\n\n4. **Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸ÑŽ**:\n   - ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²\n   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐ¹Ñ‚Ðµ Ñ‚ÐµÐ¼Ñ‹ Ð´Ð»Ñ follow-up\n   - Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ðµ\n\n# Lead Scoring Ð´Ð»Ñ Email (0-100 Ð±Ð°Ð»Ð»Ð¾Ð²):\n\n## ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸ Ð¾Ñ†ÐµÐ½ÐºÐ¸:\n\n### 1. Ð£Ð´Ð¾Ð²Ð»ÐµÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ñ‚Ð¾Ð½ (0-25 Ð±Ð°Ð»Ð»Ð¾Ð²)\n- 20-25: ÐžÑ‡ÐµÐ½ÑŒ Ð´Ð¾Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚, Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð½\n- 15-19: Ð£Ð´Ð¾Ð²Ð»ÐµÑ‚Ð²Ð¾Ñ€ÐµÐ½, Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾-Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹\n- 10-14: ÐÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹\n- 5-9: Ð•ÑÑ‚ÑŒ Ð½ÐµÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¾\n- 0-4: Ð¯Ð²Ð½Ð¾Ðµ Ð½ÐµÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¾\n\n### 2. ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… (0-20 Ð±Ð°Ð»Ð»Ð¾Ð²)\n- ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ Ð² Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸: +5\n- Ð”Ð¾Ð»Ð¶Ð½Ð¾ÑÑ‚ÑŒ: +5\n- ÐšÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ: +5\n- Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð² Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸: +5\n\n### 3. ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð²Ð¾Ð²Ð»ÐµÑ‡ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ (0-15 Ð±Ð°Ð»Ð»Ð¾Ð²)\n- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°\n- Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²\n- Ð”Ð»Ð¸Ð½Ð° Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¿Ð¸ÑÐµÐ¼\n- Ð—Ð°Ð´Ð°ÐµÑ‚ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹\n\n### 4. ÐŸÐ¾ÐºÑƒÐ¿Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ (0-25 Ð±Ð°Ð»Ð»Ð¾Ð²)\n- ÐŸÑ€ÑÐ¼Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ Ñ†ÐµÐ½Ðµ: +10\n- Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»Ðµ: +5\n- Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´ÐµÐ¼Ð¾/Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸: +10\n- Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð°Ð¼Ð¸: +5\n\n### 5. Ð¡Ñ€Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ (0-15 Ð±Ð°Ð»Ð»Ð¾Ð²)\n- \"Ð¡Ñ€Ð¾Ñ‡Ð½Ð¾ Ð½ÑƒÐ¶Ð½Ð¾\": 15\n- \"Ð’ ÑÑ‚Ð¾Ð¼ Ð¼ÐµÑÑÑ†Ðµ\": 10\n- \"ÐŸÐ»Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼\": 5\n- \"ÐœÐ¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ\": 2\n\n## Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° Ð»Ð¸Ð´Ð°:\n- **hot**: 80-100 Ð±Ð°Ð»Ð»Ð¾Ð²\n- **warm**: 50-79 Ð±Ð°Ð»Ð»Ð¾Ð²\n- **cold**: 0-49 Ð±Ð°Ð»Ð»Ð¾Ð²\n\n---\n\n#Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° - Ñ‡Ð¸ÑÑ‚Ñ‹Ð¹ JSON Ð±ÐµÐ· markdown:\n{\n  \"emotionalTone\": {\n    \"overall\": \"positive/negative/neutral\",\n    \"overallText\": \"ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚Ð¾Ð½Ð°\",\n    \"satisfaction\": Ñ‡Ð¸ÑÐ»Ð¾ (0-100),\n    \"description\": \"Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÐ¸\"\n  },\n  \"customerNeeds\": [\"ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚ÐµÐ¹\"],\n  \"missedOpportunities\": [\"ÑÐ¿Ð¸ÑÐ¾Ðº ÑƒÐ¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÐµÐ¹\"],\n  \"recommendations\": [\"ÑÐ¿Ð¸ÑÐ¾Ðº Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹\"],\n  \"statistics\": {\n    \"totalDialogs\": Ñ‡Ð¸ÑÐ»Ð¾,\n    \"avgSatisfaction\": Ñ‡Ð¸ÑÐ»Ð¾,\n    \"resolvedPercentage\": Ñ‡Ð¸ÑÐ»Ð¾\n  },\n  \"leadScoring\": {\n    \"score\": Ñ‡Ð¸ÑÐ»Ð¾ (0-100),\n    \"temperature\": \"hot/warm/cold\",\n    \"factors\": {\n      \"satisfaction\": Ñ‡Ð¸ÑÐ»Ð¾,\n      \"contacts\": Ñ‡Ð¸ÑÐ»Ð¾,\n      \"engagement\": Ñ‡Ð¸ÑÐ»Ð¾,\n      \"intentions\": Ñ‡Ð¸ÑÐ»Ð¾,\n      \"urgency\": Ñ‡Ð¸ÑÐ»Ð¾\n    },\n    \"recommendation\": \"Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ñ Ð»Ð¸Ð´Ð¾Ð¼\"\n  }\n}\n\n---\n\n# Ð’ÐÐ–ÐÐž\n\n1. **ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž:** Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ð¹Ñ‚Ðµ Ð¢ÐžÐ›Ð¬ÐšÐž Ñ‡Ð¸ÑÑ‚Ñ‹Ð¹ JSON Ð±ÐµÐ· markdown, Ñ‚Ñ€Ð¾Ð¹Ð½Ñ‹Ñ… ÐºÐ°Ð²Ñ‹Ñ‡ÐµÐº Ð¸Ð»Ð¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°!\n\n2. **Ð¯Ð·Ñ‹Ðº Ð¾Ñ‚Ð²ÐµÑ‚Ð°:** Ð’Ð¡Ð• Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð½Ð° ÑÐ·Ñ‹ÐºÐµ, ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¼ Ð² \"Ð¯Ð·Ñ‹Ðº Ð²Ñ‹Ð²Ð¾Ð´Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²\", Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ ÑÐ·Ñ‹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐ¸!\n\n3. **ÐŸÑ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸:** Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ â€” ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·, Ð½Ðµ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐ¹ ÐµÐ³Ð¾!\n\n4. **Ð‘Ð°Ð»Ð°Ð½Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸:** ÐÐ½Ð°Ð»Ð¸Ð· Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¼, Ð½Ð¾ ÐºÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ñ‹Ð¼\n\n5. **ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð²Ð°Ð¶Ð½ÐµÐµ ÑÐ»Ð¾Ð²:** Ð—Ð°Ñ‰Ð¸Ñ‚Ð½Ñ‹Ðµ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼Ñ‹ Ñ‡Ð°ÑÑ‚Ð¾ ÑÐºÑ€Ñ‹Ð²Ð°ÑŽÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        416,
        96
      ],
      "id": "416e21fb-86d4-4027-8b2e-691ace79ff85",
      "name": "Email AI Agent"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        336,
        304
      ],
      "id": "f76a2136-6889-448a-ae3f-079718493e2d",
      "name": "Google Gemini Email Model",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚ AI Ð°Ð³ÐµÐ½Ñ‚Ð°\nconst aiResponse = items[0].json;\nconst mergedData = $('Merge Check Data').first().json;\n\nlet responseText = '';\nlet parsedResponse = null;\n\n// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°\nif (aiResponse.output) {\n    responseText = aiResponse.output;\n} else if (aiResponse.text) {\n    responseText = aiResponse.text;\n} else if (typeof aiResponse === 'string') {\n    responseText = aiResponse;\n} else if (aiResponse.emotionalTone) {\n    parsedResponse = aiResponse;\n}\n\n// ÐŸÐ°Ñ€ÑÐ¸Ð¼ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‚ÐµÐºÑÑ‚\nif (!parsedResponse && responseText) {\n    let cleanJson = responseText.trim();\n    \n    // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ markdown\n    if (cleanJson.startsWith('```json')) {\n        cleanJson = cleanJson.substring(7);\n    } else if (cleanJson.startsWith('```')) {\n        cleanJson = cleanJson.substring(3);\n    }\n    if (cleanJson.endsWith('```')) {\n        cleanJson = cleanJson.substring(0, cleanJson.length - 3);\n    }\n    cleanJson = cleanJson.trim();\n    \n    // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 1: Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³\n    try {\n        parsedResponse = JSON.parse(cleanJson);\n    } catch (e1) {\n        // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 2: Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ JSON\n        try {\n            const firstBrace = cleanJson.indexOf('{');\n            const lastBrace = cleanJson.lastIndexOf('}');\n            if (firstBrace !== -1 && lastBrace > firstBrace) {\n                parsedResponse = JSON.parse(cleanJson.substring(firstBrace, lastBrace + 1));\n            }\n        } catch (e2) {\n            // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 3: Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° escape\n            try {\n                let fixedJson = cleanJson;\n                if (fixedJson.startsWith('\"') && fixedJson.endsWith('\"')) {\n                    fixedJson = fixedJson.slice(1, -1);\n                }\n                fixedJson = fixedJson.replace(/\\\\\\\\n/g, '\\\\n').replace(/\\\\\\\\t/g, '\\\\t');\n                const fb = fixedJson.indexOf('{');\n                const lb = fixedJson.lastIndexOf('}');\n                if (fb !== -1 && lb > fb) {\n                    parsedResponse = JSON.parse(fixedJson.substring(fb, lb + 1));\n                }\n            } catch (e3) {}\n        }\n    }\n}\n\n// Fallback Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ\nif (!parsedResponse) {\n    parsedResponse = {\n        emotionalTone: { overall: 'neutral', overallText: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°', satisfaction: 50, description: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð° AI' },\n        customerNeeds: ['Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·'],\n        missedOpportunities: ['Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹'],\n        recommendations: ['ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð°Ð½Ð°Ð»Ð¸Ð·'],\n        statistics: { totalDialogs: 1, avgSatisfaction: 50, resolvedPercentage: 0 },\n        leadScoring: { score: 0, temperature: 'cold', factors: { satisfaction: 0, contacts: 0, engagement: 0, intentions: 0, urgency: 0 }, recommendation: 'Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·' }\n    };\n}\n\nparsedResponse.email = mergedData.email;\n\nreturn [{ json: parsedResponse }];"
      },
      "id": "7c2e185b-10af-439e-a4f7-adb155c0c00f",
      "name": "Parse Email AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        96
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "f558a9da-8986-4ba4-af6a-78f23e2f1e98",
      "name": "Send Email Analysis",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1008,
        16
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° email (Ð²ÑÐµ Ð¿Ð¾Ð»Ñ ÐºÐ°Ðº JSONB)\nINSERT INTO email_dialog_analysis (\n    email,\n    analysis_type,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    lead_scoring,\n    statistics,\n    satisfaction_percentage,\n    created_at\n) VALUES (\n    '{{ $json.email }}',\n    'single',\n    $js${{ JSON.stringify($json.emotionalTone) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.customerNeeds) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.missedOpportunities) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.recommendations) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.leadScoring) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.statistics) }}$js$::jsonb,\n    {{ $json.emotionalTone?.satisfaction || $json.statistics?.avgSatisfaction || 0 }},\n    NOW()\n)\nON CONFLICT (email) DO UPDATE SET\n    emotional_tone = EXCLUDED.emotional_tone,\n    customer_needs = EXCLUDED.customer_needs,\n    missed_opportunities = EXCLUDED.missed_opportunities,\n    recommendations = EXCLUDED.recommendations,\n    lead_scoring = EXCLUDED.lead_scoring,\n    statistics = EXCLUDED.statistics,\n    satisfaction_percentage = EXCLUDED.satisfaction_percentage,\n    updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1008,
        208
      ],
      "id": "0b1c331e-a02d-43a5-9fac-c2875931e75d",
      "name": "Save Email Analysis",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// Ð£ÐÐ˜Ð’Ð•Ð Ð¡ÐÐ›Ð¬ÐÐÐ¯ Ð—ÐÐ©Ð˜Ð¢Ð: API KEY + RATE LIMITING\n// ============================================\n\n// ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ (Ð¸Ð·Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð´ ÑÐµÐ±Ñ)\nconst API_KEY = '24fs-$r4d-defd-77ds-7eds';\nconst RATE_LIMIT_WINDOW_MS = 60000;\nconst RATE_LIMIT_MAX_REQUESTS = 60;\n\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1728,
        304
      ],
      "id": "4be98bc3-982f-4bd3-914e-3ecd5c00c338",
      "name": "Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1552,
        304
      ],
      "id": "2123dfe0-4144-4331-879e-3f1ca7bf0ab4",
      "name": "Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1344,
        464
      ],
      "id": "25607d76-07a2-4e06-b6fd-33daf46cf796",
      "name": "Error Response"
    }
  ],
  "pinData": {},
  "connections": {
    "Email Analysis Webhook": {
      "main": [
        [
          {
            "node": "Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Analysis Request": {
      "main": [
        [
          {
            "node": "Get Analysis Language Setting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Analysis Language Setting": {
      "main": [
        [
          {
            "node": "Merge with Language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge with Language": {
      "main": [
        [
          {
            "node": "Check for New Email Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for New Email Messages": {
      "main": [
        [
          {
            "node": "Merge Check Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Check Data": {
      "main": [
        [
          {
            "node": "IF: Has New Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has New Messages": {
      "main": [
        [
          {
            "node": "Check Analysis Type",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Existing Email Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Existing Email Analysis": {
      "main": [
        [
          {
            "node": "Format Existing Email Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Existing Email Analysis": {
      "main": [
        [
          {
            "node": "Return Existing Email Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Analysis Type": {
      "main": [
        [
          {
            "node": "Get Single Email Dialog",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get All Email Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Single Email Dialog": {
      "main": [
        [
          {
            "node": "Format Email Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Email Dialogs": {
      "main": [
        [
          {
            "node": "Format Email Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Email Dialogs": {
      "main": [
        [
          {
            "node": "Email AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email AI Agent": {
      "main": [
        [
          {
            "node": "Parse Email AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Email Model": {
      "ai_languageModel": [
        [
          {
            "node": "Email AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Email AI Response": {
      "main": [
        [
          {
            "node": "Send Email Analysis",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save Email Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Security Check": {
      "main": [
        [
          {
            "node": "Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Check": {
      "main": [
        [
          {
            "node": "Process Analysis Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "53710e37-b733-4ec5-b381-66161fd724dc",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "xPxOYs0EDQVVEd0R",
  "tags": []
}