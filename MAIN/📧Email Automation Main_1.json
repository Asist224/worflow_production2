{
  "name": "üìßEmail Automation Main_1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 3
            }
          ]
        }
      },
      "id": "f6694a9b-4b8d-4ab4-9430-931fae1a9ce9",
      "name": "Schedule Check",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -21136,
        -2448
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\nWITH recent_messages AS (\n    SELECT \n        session_id,\n        MAX(created_at) as last_message_time,\n        COUNT(*) as message_count\n    FROM (\n        SELECT session_id, created_at FROM n8n_chat_histories_ru\n        WHERE created_at > NOW() - INTERVAL '1 hours'\n        UNION ALL\n        SELECT session_id, created_at FROM n8n_chat_histories_en\n        WHERE created_at > NOW() - INTERVAL '1 hours'\n    ) all_messages\n    GROUP BY session_id\n    HAVING COUNT(*) >= 3 -- –ú–∏–Ω–∏–º—É–º 3 —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\n),\n-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –ª–∏ —É–∂–µ –ø–∏—Å—å–º–æ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏\nalready_sent AS (\n    SELECT DISTINCT session_id\n    FROM email_tracking\n    WHERE status = 'sent'\n      AND email_type IN ('welcome_pdf', 'info_request', 'pricing_info', 'setup_guide')\n      -- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π\n      AND sent_at > NOW() - INTERVAL '7 days'\n),\nnot_processed AS (\n    SELECT rm.session_id\n    FROM recent_messages rm\n    LEFT JOIN already_sent as_sent ON rm.session_id = as_sent.session_id\n    WHERE as_sent.session_id IS NULL -- –¢–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–∏ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º\n)\nSELECT \n    ac.id,\n    ac.session_id,\n    ac.message_type,\n    ac.content,\n    ac.timestamp,\n    ac.platform,\n    ac.language\nFROM (\n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'ru' as language\n    FROM n8n_chat_histories_ru\n    WHERE session_id IN (SELECT session_id FROM not_processed)\n    \n    UNION ALL\n    \n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'en' as language\n    FROM n8n_chat_histories_en\n    WHERE session_id IN (SELECT session_id FROM not_processed)\n) ac\nORDER BY ac.session_id, ac.timestamp;",
        "options": {}
      },
      "id": "62ec3e34-1de5-4979-a696-1bda47d2ecdd",
      "name": "Get Unprocessed Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -20896,
        -2496
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –ø–æ —Å–µ—Å—Å–∏—è–º\nconst dialogs = items;\nconst sessions = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    if (!sessions[data.session_id]) {\n        sessions[data.session_id] = {\n            messages: [],\n            language: data.language,\n            platform: data.platform\n        };\n    }\n    \n    sessions[data.session_id].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞\nconst dialogsForAnalysis = Object.entries(sessions).map(([sessionId, data]) => {\n    return {\n        sessionId: sessionId,\n        language: data.language,\n        platform: data.platform,\n        conversation: data.messages.map(msg => \n            `${msg.type === 'human' ? '–ö–ª–∏–µ–Ω—Ç' : '–ë–æ—Ç'}: ${msg.content}`\n        ).join('\\n'),\n        messageCount: data.messages.length,\n        lastMessage: data.messages[data.messages.length - 1]\n    };\n});\n\nreturn dialogsForAnalysis.map(d => ({json: d}));"
      },
      "id": "a4d5fc10-5275-4dba-a175-3c16d217862d",
      "name": "Format Dialogs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -20688,
        -2496
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–ê–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞:\nSession ID: {{ $json.sessionId }}\n–Ø–∑—ã–∫: {{ $json.language }}\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {{ $json.platform }}\n\n–î–∏–∞–ª–æ–≥:\n{{ $json.conversation }}",
        "options": {
          "systemMessage": "# –†–æ–ª—å: Email Marketing AI Agent\n\n–¢—ã - —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ Cryptomator.\n\n# –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–¥—É–∫—Ç–∞:\nCryptomator - —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:\n- PDF –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞\n- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–æ—Ç–∞\n- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤\n- –û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n\n# –ó–∞–¥–∞—á–∞:\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:\n\n1. **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ email**:\n   - –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n   - –ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª email –¥–ª—è —Å–≤—è–∑–∏\n   - –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–∏–ª –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–æ–¥—É–∫—Ç—É\n   - –ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—â–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞\n\n2. **–ò–∑–≤–ª–µ–∫–∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞**:\n   - Email (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)\n   - –ò–º—è (–µ—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è)\n   - –¢–µ–ª–µ—Ñ–æ–Ω (–µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏–ª)\n   - –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏\n\n3. **–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –ø–∏—Å—å–º–∞**:\n   - welcome_pdf - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å PDF –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–µ–π\n   - info_request - –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n   - pricing_info - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö\n   - setup_guide - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ\n   - followup - –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–∏—Å—å–º–æ\n\n4. **–û–ø—Ä–µ–¥–µ–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–∏—Å—å–º–∞**:\n   - –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–∏—Ç—å (–∏–∑ Google Drive)\n   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞\n   - Call-to-action\n\n# –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:\n\n1. **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–π email –µ—Å–ª–∏**:\n   - –ù–µ—Ç —è–≤–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞\n   - –ö–ª–∏–µ–Ω—Ç –Ω–µ –¥–∞–≤–∞–ª —Å–æ–≥–ª–∞—Å–∏—è\n   - –î–∏–∞–ª–æ–≥ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–µ–Ω–µ–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π)\n   - –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n   - Email —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å –≤ –±–∞–∑–µ)\n\n2. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ø—Ä–∞–≤–ª—è–π –µ—Å–ª–∏**:\n   - –ö–ª–∏–µ–Ω—Ç –ø—Ä—è–º–æ –ø–æ–ø—Ä–æ—Å–∏–ª –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n   - –ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª email —Å –ø—Ä–æ—Å—å–±–æ–π —Å–≤—è–∑–∞—Ç—å—Å—è\n   - –ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n   - Lead score > 70 –∏ –µ—Å—Ç—å email\n\n3. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**:\n   - –ò—Å–ø–æ–ª—å–∑—É–π –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ\n   - –ê–¥–∞–ø—Ç–∏—Ä—É–π —Ç–æ–Ω –ø–æ–¥ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (Telegram –±–æ–ª–µ–µ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π)\n   - –£—á–∏—Ç—ã–≤–∞–π —è–∑—ã–∫ –¥–∏–∞–ª–æ–≥–∞ (ru/en)\n   - –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞\n\n4. **–§–∞–π–ª—ã –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è**:\n   - presentation_ru.pdf / presentation_en.pdf - –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è\n   - setup_guide_ru.pdf / setup_guide_en.pdf - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞\n   - pricing_ru.pdf / pricing_en.pdf - —Ç–∞—Ä–∏—Ñ—ã\n   - faq_ru.pdf / faq_en.pdf - —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô HTML –§–û–†–ú–ê–¢ –ü–ò–°–¨–ú–ê (–°–ü–ê–ú-–ë–ï–ó–û–ü–ê–°–ù–´–ô):\n\n### –ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–û–¢ –®–ê–ë–õ–û–ù –î–õ–Ø emailContent (–†–£–°–°–ö–ê–Ø –í–ï–†–°–ò–Ø):\n\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ{{#if name}}, {{name}}{{/if}}!</p>\n        \n        <p>–ö–∞–∫ –∏ –æ–±–µ—â–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Cryptomator - —Ç–æ—Ä–≥–æ–≤–æ–º –±–æ—Ç–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏.</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            <p>–í—ã –ø—Ä–æ—Å–∏–ª–∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞.</p>\n            <p>üìé –í–æ –≤–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞, –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.</p>\n        </div>\n        \n        <div style=\"background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin: 20px 0;\">\n            <h3 style=\"color: #2c5282; margin-top: 0;\">üìä –ß—Ç–æ —É–º–µ–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç Cryptomator:</h3>\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –Ω–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –±–∏—Ä–∂–∞—Ö</li>\n                <li style=\"margin-bottom: 10px;\">üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 6 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞</li>\n                <li style=\"margin-bottom: 10px;\">üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ —Å—Ä–µ–¥—Å—Ç–≤</li>\n                <li style=\"margin-bottom: 10px;\">‚ö° –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>\n            </ul>\n        </div>\n        \n        <h3 style=\"color: #2c5282;\">üí∞ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã:</h3>\n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0;\">\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">üíö <strong>Starter:</strong> $29/–º–µ—Å—è—Ü - –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞</li>\n                <li style=\"margin-bottom: 10px;\">üíô <strong>Professional:</strong> $59/–º–µ—Å—è—Ü - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏</li>\n                <li style=\"margin-bottom: 10px;\">üíú <strong>Enterprise:</strong> $99/–º–µ—Å—è—Ü - –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>\n            </ul>\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro/?utm_source=email&utm_campaign=info#prices\"\n               style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n                üöÄ –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –Ω–∞ —Å–∞–π—Ç–µ\n            </a>\n        </div>\n        \n        <p style=\"background: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0;\">\n    <strong>üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!</strong><br>\n    –ù–∞—á–Ω–∏—Ç–µ —Å–µ–≥–æ–¥–Ω—è –∏ –ø–æ–ª—É—á–∏—Ç–µ <strong>+1 –º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π</strong> –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.\n</p>\n        \n        <p>–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —ç—Ç–æ –ø–∏—Å—å–º–æ.</p>\n        \n        <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>\n        <strong>–ö–æ–º–∞–Ω–¥–∞ Cryptomator</strong></p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n        \n        <div style=\"text-align: center; padding: 15px 0;\">\n            <p style=\"margin: 5px 0;\">\n                üìß Email: <a href=\"mailto:support@cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">support@cryptomator.pro</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üí¨ Telegram: <a href=\"https://t.me/cryptomator_support\" style=\"color: #3182ce; text-decoration: none;\">@cryptomator_support</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üåê –°–∞–π—Ç: <a href=\"https://cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">cryptomator.pro</a>\n            </p>\n        </div>\n        \n        <p style=\"font-size: 12px; color: #718096; text-align: center; margin-top: 20px;\">\n            –í—ã –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç–æ –ø–∏—Å—å–º–æ, —Ç–∞–∫ –∫–∞–∫ –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—Ä–≥–æ–≤–æ–º –±–æ—Ç–µ Cryptomator.\n        </p>\n    </div>\n</body>\n</html>\n```\n\n–î–õ–Ø –ê–ù–ì–õ–ò–ô–°–ö–û–ô –í–ï–†–°–ò–ò (–µ—Å–ª–∏ language = 'en'):\n\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>Hello{{#if name}}, {{name}}{{/if}}!</p>\n        \n        <p>As promised, we're sending you information about Cryptomator - a trading bot for automating cryptocurrency operations.</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            <p>You requested detailed information about our bot capabilities.</p>\n            <p>üìé Please find attached a presentation with functionality description, examples and usage instructions.</p>\n        </div>\n        \n        <div style=\"background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin: 20px 0;\">\n            <h3 style=\"color: #2c5282; margin-top: 0;\">üìä What Cryptomator Trading Bot Can Do:</h3>\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">‚úÖ Automated trading on cryptocurrency exchanges</li>\n                <li style=\"margin-bottom: 10px;\">üìà Uses 6 different market analysis algorithms</li>\n                <li style=\"margin-bottom: 10px;\">üîê Secure API connection without transferring funds</li>\n                <li style=\"margin-bottom: 10px;\">‚ö° Simple setup and user-friendly control interface</li>\n            </ul>\n        </div>\n        \n        <h3 style=\"color: #2c5282;\">üí∞ Available Plans:</h3>\n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0;\">\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">üíö <strong>Starter:</strong> $29/month - basic bot functionality</li>\n                <li style=\"margin-bottom: 10px;\">üíô <strong>Professional:</strong> $59/month - advanced trading features</li>\n                <li style=\"margin-bottom: 10px;\">üíú <strong>Enterprise:</strong> $99/month - full functionality and priority support</li>\n            </ul>\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro/?utm_source=email&utm_campaign=info#prices\"\n               style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n                üöÄ Learn More on Website\n            </a>\n        </div>\n        \n        <p style=\"background: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0;\">\n    <strong>üéÅ Special Offer!</strong><br>\n    Start today and get <strong>+1 month free</strong> license of your chosen plan.\n</p>\n        \n        <p>If you have any questions after reviewing the materials, just reply to this email.</p>\n        \n        <p>Best regards,<br>\n        <strong>Cryptomator Team</strong></p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n        \n        <div style=\"text-align: center; padding: 15px 0;\">\n            <p style=\"margin: 5px 0;\">\n                üìß Email: <a href=\"mailto:support@cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">support@cryptomator.pro</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üí¨ Telegram: <a href=\"https://t.me/cryptomator_support\" style=\"color: #3182ce; text-decoration: none;\">@cryptomator_support</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üåê Website: <a href=\"https://cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">cryptomator.pro</a>\n            </p>\n        </div>\n        \n        <p style=\"font-size: 12px; color: #718096; text-align: center; margin-top: 20px;\">\n            You received this email because you requested information about Cryptomator trading bot.\n        </p>\n    </div>\n</body>\n</html>\n```\n\n–í–ê–ñ–ù–û:\n–§–û–†–ú–ê–¢ –¢–ï–ú–´ –ü–ò–°–¨–ú–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –° –ò–ú–ï–ù–ï–ú):\n–î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞: \"{{name}}, –∫–∞–∫ –∏ –æ–±–µ—â–∞–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ Cryptomator\"\n–î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ: \"{{name}}, as promised, here's important information about Cryptomator\"\n–ï—Å–ª–∏ –∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ:\n–î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ: \"–ö–∞–∫ –∏ –æ–±–µ—â–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ Cryptomator\"\n–î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ: \"As promised, here's important information about Cryptomator\"\n–í–ê–ñ–ù–û:\n\n–í –ø–æ–ª–µ \"emailContent\" —Ç–≤–æ–µ–≥–æ JSON-–æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–´–ô HTML-–∫–æ–¥ –≤—ã—à–µ\n–í –ø–æ–ª–µ \"subject\" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—á–∞–ª–µ (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)\n–ü–æ–¥—Å—Ç–∞–≤–ª—è–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ {{name}}\n–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è language='ru' –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è language='en'\n–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞: –∑–∞—Ä–∞–±–æ—Ç–æ–∫, –¥–æ—Ö–æ–¥, –ø—Ä–∏–±—ã–ª—å, –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≥–æ–¥–æ–≤—ã—Ö, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞\n–ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n\n# –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON:\n{\n  \"shouldSendEmail\": true/false,\n  \"reason\": \"–ü—Ä–∏—á–∏–Ω–∞ —Ä–µ—à–µ–Ω–∏—è\",\n  \"emailData\": {\n    \"email\": \"–∫–ª–∏–µ–Ω—Ç@example.com\",\n    \"name\": \"–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ null\",\n    \"phone\": \"—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ null\",\n    \"emailType\": \"welcome_pdf/info_request/pricing_info/setup_guide/followup\",\n    \"subject\": \"–¢–µ–º–∞ –ø–∏—Å—å–º–∞\",\n    \"language\": \"ru/en\",\n    \"attachments\": [\n      {\n        \"fileName\": \"strategy_150_ru.pdf\",\n        \"driveId\": \"—Ñ–∞–π–ª_id_–∏–∑_google_drive\"\n      }\n    ],\n    \"emailContent\": \"HTML –∫–æ–Ω—Ç–µ–Ω—Ç –ø–∏—Å—å–º–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π\",\n    \"urgency\": \"high/medium/low\",\n    \"leadScore\": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100\n  },\n  \"extractedNeeds\": [\"—Å–ø–∏—Å–æ–∫ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π\"],\n  \"followUpRecommendation\": \"–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞\"\n}\n\n# –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:\n\nEmail –≤–∞–ª–∏–¥–µ–Ω (—Å–æ–¥–µ—Ä–∂–∏—Ç @ –∏ –¥–æ–º–µ–Ω)\n–ù–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ email_tracking –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏\n–ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —è–∑—ã–∫—É –∫–ª–∏–µ–Ω—Ç–∞\n–í—ã–±—Ä–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —è–∑—ã–∫–∞\n–í —Ç–µ–º–µ –ø–∏—Å—å–º–∞ –µ—Å—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)\n–ù–µ—Ç —Å–ø–∞–º-—Å–ª–æ–≤ (–∑–∞—Ä–∞–±–æ—Ç–æ–∫, –¥–æ—Ö–æ–¥, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø—Ä–∏–±—ã–ª—å)\n\n–í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -20512,
        -2512
      ],
      "id": "01730bf9-c8da-491a-b9de-89844a77271c",
      "name": "Email Decision Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -20576,
        -2336
      ],
      "id": "8315ab8e-a23f-4c4a-aac0-e9be4a922d18",
      "name": "Gemini Model",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Mapping —Ñ–∞–π–ª–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ ID –∏–∑ Google Drive\nconst FILE_MAPPINGS = {\n  'welcome_pdf': {\n    'ru': '1xVXrc_yDynRHugGa-tu7gZYB72N8uieF',\n    'en': '1Hu5FXAtGDGuoZ_h7CnoE_0rCnKpSCrNq'\n  },\n  'strategy': {\n    'ru': '1xVXrc_yDynRHugGa-tu7gZYB72N8uieF',\n    'en': '1Hu5FXAtGDGuoZ_h7CnoE_0rCnKpSCrNq'\n  }\n};\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst aiOutput = $input.first().json.output || $input.first().json;\nconst formatDialogsData = $items(\"Format Dialogs\")[0].json;\n\nlet emailDecision;\n\ntry {\n    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI\n    if (typeof aiOutput === 'string') {\n        // –û—á–∏—Å—Ç–∫–∞ JSON –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n        let cleanJson = aiOutput;\n        cleanJson = cleanJson.replace(/```json\\s*/g, '');\n        cleanJson = cleanJson.replace(/```\\s*/g, '');\n        cleanJson = cleanJson.trim();\n        \n        emailDecision = JSON.parse(cleanJson);\n    } else {\n        emailDecision = aiOutput;\n    }\n    \n    // –ï—Å–ª–∏ AI —Ä–µ—à–∏–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email\n    if (emailDecision.shouldSendEmail) {\n        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –∏ —Ç–∏–ø email\n        const language = emailDecision.emailData?.language || 'ru';\n        const emailType = emailDecision.emailData?.emailType || 'welcome_pdf';\n        \n        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID —Ñ–∞–π–ª–∞\n        const fileId = FILE_MAPPINGS[emailType]?.[language] || \n                      FILE_MAPPINGS['welcome_pdf'][language];\n        \n        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏\n        emailDecision.emailData = {\n            ...emailDecision.emailData,\n            fileId: fileId,\n            attachments: [{\n                driveId: fileId,\n                fileName: `strategy_${language}.pdf`,\n                mimeType: 'application/pdf'\n            }]\n        };\n    }\n    \n    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n    emailDecision.sessionId = formatDialogsData.sessionId;\n    emailDecision.platform = formatDialogsData.platform;\n    emailDecision.processedAt = new Date().toISOString();\n\n} catch (error) {\n    console.error('Parse error details:', error);\n    \n    emailDecision = {\n        shouldSendEmail: false,\n        reason: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ AI',\n        error: error.toString(),\n        sessionId: formatDialogsData?.sessionId || 'unknown',\n        platform: formatDialogsData?.platform || 'unknown',\n        processedAt: new Date().toISOString()\n    };\n}\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Email decision result:', emailDecision);\n\nreturn [{json: emailDecision}];"
      },
      "id": "c921f2a9-4356-4665-ad7b-2d927bdc72d5",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -20240,
        -2496
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.shouldSendEmail }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "id": "eda947b2-635d-4137-b710-1b2e4c383b66"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "05bc971e-42e9-4f62-8f32-6227980b0ff0",
      "name": "Should Send Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -19904,
        -2496
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    COUNT(*) as duplicate_count,\n    '{{ $json.sessionId }}' as session_id,\n    '{{ $json.emailData.email }}' as email,\n    MAX(sent_at) as last_sent_at,\n    STRING_AGG(email_type, ', ') as sent_types\nFROM email_tracking\nWHERE session_id = '{{ $json.sessionId }}'\n  AND status = 'sent'\n  AND (\n    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª—é–±—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π\n    (email_type IN ('welcome_pdf', 'info_request', 'pricing_info', 'setup_guide') \n     AND sent_at > NOW() - INTERVAL '7 days')\n    OR\n    -- –ò–ª–∏ —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ –ø–∏—Å—å–º–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π\n    (email = '{{ $json.emailData.email }}' \n     AND email_type = '{{ $json.emailData.emailType }}'\n     AND sent_at > NOW() - INTERVAL '30 days')\n  );",
        "options": {}
      },
      "id": "38ec1c21-bb86-44e8-ba17-10daa00494ea",
      "name": "Check Duplicate",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -19776,
        -2640
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.duplicate_count }}",
              "rightValue": "0",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "acad2f38-9ae5-4adf-b6eb-25917bb92518"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "daaccd24-a001-4bd7-b373-b30a91345f03",
      "name": "Is New Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -19376,
        -2640
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.emailData.fileId }}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "id": "dfc35098-a6b5-4e95-a1dc-635962521de8",
      "name": "Get Files from Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -19168,
        -2704
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "2ZNOKD6ZFqAfrDq2",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.emailData.email }}",
        "subject": "={{ $json.emailData.subject }}",
        "message": "={{ $json.emailData.emailContent }}",
        "options": {
          "appendAttribution": false,
          "attachmentsUi": {
            "attachmentsBinary": [
              {}
            ]
          },
          "senderName": "Cryptomator Team",
          "replyTo": "support@cryptomator.pro"
        }
      },
      "id": "802c0800-3f57-4b38-9eb1-82ea82d78644",
      "name": "Send Gmail",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -18976,
        -2704
      ],
      "webhookId": "090d73f6-561b-472b-b6cc-85cf70e39e80",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º email\nINSERT INTO email_tracking (\n    session_id,\n    email,\n    client_name,\n    email_type,\n    subject,\n    content,\n    attachments,\n    status,\n    platform,\n    language,\n    sent_at\n) VALUES (\n    '{{ $json.sessionId }}',\n    '{{ $json.email }}',\n    '{{ $json.clientName }}',\n    '{{ $json.emailType }}',\n    '{{ $json.subject }}',\n    '{{ $json.content }}',\n    '{{ $json.attachments }}'::jsonb,\n    '{{ $json.status }}',\n    '{{ $json.platform }}',\n    '{{ $json.language }}',\n    NOW()\n)\nRETURNING *;",
        "options": {}
      },
      "id": "05159d28-0e08-4d0a-85ac-19c81d9c1772",
      "name": "Save Email Record",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -18576,
        -2704
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "-1002588885971",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "019ac58a-72ac-4beb-99f8-96562e7a5027",
      "name": "Notify Manager",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -18176,
        -2704
      ],
      "webhookId": "68e9f810-a972-4f5b-9433-259b598cc8d8",
      "credentials": {
        "telegramApi": {
          "id": "bHlhE9zUMfwWqM9t",
          "name": "Manager Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –∏–∑ Parse AI Response\nconst emailData = $items(\"Parse AI Response\")[0].json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤\nconst duplicateCheck = $input.first().json;\n\n// –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–∞–ª—å—à–µ, –≤–∫–ª—é—á–∞—è duplicate_count\nreturn [{\n  json: {\n    ...emailData,\n    shouldSendEmail: emailData.shouldSendEmail,\n    emailData: emailData.emailData,\n    sessionId: emailData.sessionId,\n    platform: emailData.platform,\n    duplicate_count: duplicateCheck.duplicate_count // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ –ø–æ–ª–µ!\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -19568,
        -2640
      ],
      "id": "efcf6725-437f-424c-8126-4f30ca836019",
      "name": "Merge Email Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–∏—Å—å–º–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst emailData = $items(\"Is New Email?\")[0].json;\nconst gmailResponse = $input.first().json;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è SQL —Å—Ç—Ä–æ–∫\nfunction escapeSql(str) {\n  if (!str) return '';\n  return str.replace(/'/g, \"''\");\n}\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î\nreturn [{\n  json: {\n    sessionId: emailData.sessionId || 'test_en_001',\n    email: emailData.emailData.email,\n    clientName: escapeSql(emailData.emailData.name),\n    emailType: emailData.emailData.emailType || 'welcome_pdf',\n    subject: escapeSql(emailData.emailData.subject),\n    content: escapeSql(emailData.emailData.emailContent),\n    attachments: JSON.stringify(emailData.emailData.attachments || []),\n    status: 'sent',\n    platform: emailData.platform || 'telegram',\n    language: emailData.emailData.language || 'ru',\n    gmailId: gmailResponse.id,\n    gmailThreadId: gmailResponse.threadId,\n    sentAt: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -18768,
        -2704
      ],
      "id": "bdd71c19-b1f5-40bf-8757-8de6a62267c3",
      "name": "Save Email Record1"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞ Save Email Record\nconst saveResult = $input.first().json;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ Markdown V2\nfunction escapeMarkdown(text) {\n  if (!text) return '';\n  return String(text)\n    .replace(/\\\\/g, '\\\\\\\\')\n    .replace(/\\*/g, '\\\\*')\n    .replace(/_/g, '\\\\_')\n    .replace(/\\[/g, '\\\\[')\n    .replace(/\\]/g, '\\\\]')\n    .replace(/\\(/g, '\\\\(')\n    .replace(/\\)/g, '\\\\)')\n    .replace(/~/g, '\\\\~')\n    .replace(/`/g, '\\\\`')\n    .replace(/>/g, '\\\\>')\n    .replace(/#/g, '\\\\#')\n    .replace(/\\+/g, '\\\\+')\n    .replace(/-/g, '\\\\-')\n    .replace(/=/g, '\\\\=')\n    .replace(/\\|/g, '\\\\|')\n    .replace(/\\{/g, '\\\\{')\n    .replace(/\\}/g, '\\\\}')\n    .replace(/\\./g, '\\\\.')\n    .replace(/!/g, '\\\\!');\n}\n\n// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\nconst safeName = escapeMarkdown(saveResult.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω');\nconst safeEmail = escapeMarkdown(saveResult.email);\nconst safeSubject = escapeMarkdown(saveResult.subject);\nconst safePlatform = escapeMarkdown(saveResult.platform);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á–µ—Ç –¥–ª—è Telegram —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º\nconst report = `üìß *Email —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω\\\\!*\n\nüë§ *–ö–ª–∏–µ–Ω—Ç:* ${safeName}\nüìÆ *Email:* ${safeEmail}\nüåê *–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:* ${safePlatform}\nüó£Ô∏è *–Ø–∑—ã–∫:* ${saveResult.language === 'ru' ? 'üá∑üá∫ –†—É—Å—Å–∫–∏–π' : 'üá¨üáß English'}\n\nüìé *–¢–∏–ø –ø–∏—Å—å–º–∞:* ${escapeMarkdown(saveResult.email_type)}\nüìÑ *–¢–µ–º–∞:* ${safeSubject}\n\n‚úÖ *–°—Ç–∞—Ç—É—Å:* ${saveResult.status}\nüÜî *ID –∑–∞–ø–∏—Å–∏:* ${saveResult.id}\nüîó *Session ID:* ${escapeMarkdown(saveResult.session_id)}\n\n‚è∞ *–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:* ${escapeMarkdown(new Date().toLocaleString('ru-RU', {\n  timeZone: 'Europe/Moscow'\n}))}\n\nüíØ *Lead Score:* ${saveResult.lead_score || 0}\n\n\\\\#email\\\\_sent \\\\#${saveResult.platform} \\\\#${saveResult.language}`;\n\nreturn [{\n  json: {\n    message: report,\n    parse_mode: 'MarkdownV2',  // –ò—Å–ø–æ–ª—å–∑—É–µ–º MarkdownV2\n    chat_id: '-1002588885971'  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π ID –≥—Ä—É–ø–ø—ã\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -18368,
        -2704
      ],
      "id": "f0300a44-e1d9-4a66-880c-55a0378f8fb1",
      "name": "Prepare Telegram Report"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã\nINSERT INTO email_follow_ups (\n    email,\n    thread_id,\n    follow_up_date,\n    status,\n    notes,\n    created_at\n) \nSELECT\n    '{{ $json.to }}',  -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 'to', –Ω–µ 'email'\n    '{{ $json.threadId }}',  -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 'threadId'\n    NOW() + INTERVAL '3 days',\n    'pending',\n    'Lead Score: {{ $json.leadScore || 0 }}',\n    NOW()\nWHERE '{{ $json.to }}' != 'undefined'  -- –ó–∞—â–∏—Ç–∞ –æ—Ç undefined\n  AND '{{ $json.threadId }}' != 'undefined'\n  AND NOT EXISTS (\n    SELECT 1 FROM email_follow_ups \n    WHERE email = '{{ $json.to }}'\n    AND (\n        status = 'pending'\n        OR (status = 'sent' AND sent_at > NOW() - INTERVAL '7 days')\n    )\n);\n\nSELECT 'Follow-up processed' as status;",
        "options": {}
      },
      "id": "3d3534d5-d07b-4315-9322-6741eb433669",
      "name": "Schedule Follow-up",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -18608,
        -2928
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞\nconst inputData = $input.first().json;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö\nconst email = inputData.email || inputData.from || 'no-email';\nconst threadId = inputData.gmailThreadId || inputData.threadId || 'no-thread';\nconst leadScore = inputData.leadScore || 50;\n\n// –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Input data:', inputData);\nconsole.log('Extracted - Email:', email, 'ThreadId:', threadId, 'LeadScore:', leadScore);\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Schedule Follow-up\nreturn [{\n  json: {\n    to: email,\n    threadId: threadId,\n    leadScore: leadScore,\n    followUpDays: 3,\n    internalNote: `–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç. Lead Score: ${leadScore}`\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -18800,
        -2928
      ],
      "id": "7e1b6b4a-2121-4474-8854-82615f6ffd59",
      "name": "Prepare Follow-up Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è SendPulse OAuth\n// –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ API credentials –∏–∑ SendPulse\nconst SENDPULSE_API_ID = 'e00470078ad763936dc9578bbe148414'; \nconst SENDPULSE_API_SECRET = 'e98d876685d4779e7248fd6a9cc65e13';\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞\nreturn [{\n  json: {\n    grant_type: 'client_credentials',\n    client_id: SENDPULSE_API_ID,\n    client_secret: SENDPULSE_API_SECRET\n  }\n}];"
      },
      "id": "62da5d9a-8460-46b2-b4c8-8d27089eae26",
      "name": "Prepare SendPulse Auth",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -18368,
        -2944
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendpulse.com/oauth/access_token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "grant_type",
              "value": "={{ $json.grant_type }}"
            },
            {
              "name": "client_id",
              "value": "={{ $json.client_id }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $json.client_secret }}"
            }
          ]
        },
        "options": {}
      },
      "id": "bdfa0e8c-9322-4cfb-b606-01b691b131cd",
      "name": "Get SendPulse Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -18176,
        -2944
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –∏–∑ —É–∑–ª–∞ Save Email Record1\nconst emailData = $items(\"Save Email Record1\")[0].json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω SendPulse –∏–∑ —É–∑–ª–∞ Get SendPulse Token\nconst sendPulseToken = $items(\"Get SendPulse Token\")[0].json;\n\n// ID –∞–¥—Ä–µ—Å–Ω—ã—Ö –∫–Ω–∏–≥ –≤ SendPulse\nconst ADDRESSBOOKS = {\n  'leads_ru': 1590447,     // ID —Ä—É—Å—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'leads_en': 1591644,     // ID –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'customers_ru': 1590611, // ID –∫–Ω–∏–≥–∏ —Ä—É—Å—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n  'customers_en': 1591645  // ID –∫–Ω–∏–≥–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n};\n\n// –í—ã–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å–Ω—É—é –∫–Ω–∏–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞\nconst language = emailData.language || 'ru';\nconst addressbookId = language === 'ru' ? ADDRESSBOOKS.leads_ru : ADDRESSBOOKS.leads_en;\nconst customersBookId = language === 'ru' ? ADDRESSBOOKS.customers_ru : ADDRESSBOOKS.customers_en;\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Email data from Save Email Record1:', emailData);\nconsole.log('Token received:', sendPulseToken.access_token ? 'Yes' : 'No');\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ SendPulse\nreturn [{\n  json: {\n    token: sendPulseToken.access_token,\n    tokenType: sendPulseToken.token_type || 'Bearer',\n    addressbookId: addressbookId,\n    customersBookId: customersBookId,\n    emailData: {\n      email: emailData.email,\n      variables: {\n        name: emailData.clientName || '',\n        phone: emailData.phone || '',\n        platform: emailData.platform || 'telegram',\n        session_id: emailData.sessionId,\n        lead_score: emailData.leadScore || 50,\n        added_date: new Date().toISOString().split('T')[0]\n      }\n    },\n    language: language,\n    originalData: emailData\n  }\n}];"
      },
      "id": "33ee5fd7-d9b5-49c3-9e31-b4d54d035d83",
      "name": "Prepare Contact Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -17984,
        -2944
      ]
    },
    {
      "parameters": {
        "url": "=https://api.sendpulse.com/addressbooks/{{ $json.customersBookId }}/emails/{{ $json.emailData.email }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.tokenType }} {{ $json.token }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "99fd0191-eea8-4bcd-9056-fcec54b42577",
      "name": "Check if Customer",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -17792,
        -2944
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message }}",
              "rightValue": "Email not found",
              "operator": {
                "type": "string",
                "operation": "contains"
              },
              "id": "6fe44b79-011f-486b-9db5-95bd0caf74e0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c7db18a5-eede-4d83-a8f8-3bbf2651aefc",
      "name": "Is Not Customer?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -17600,
        -2944
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.sendpulse.com/addressbooks/{{ $items(\"Prepare Contact Data\")[0].json.addressbookId }}/emails",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $items(\"Prepare Contact Data\")[0].json.tokenType }} {{ $items(\"Prepare Contact Data\")[0].json.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"emails\": [\n    {\n      \"email\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.email) }},\n      \"variables\": {\n        \"name\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.name) }},\n        \"Phone\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.phone) }},\n        \"platform\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.platform) }},\n        \"session_id\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.session_id) }},\n        \"lead_score\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.lead_score) }},\n        \"added_date\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.added_date) }}\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "61212217-e4b0-4954-a4c4-827920153d58",
      "name": "Add to SendPulse",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -16896,
        -3136
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO sendpulse_sync (\n    email,\n    addressbook_id,\n    addressbook_name,\n    sync_status,\n    sync_date\n) VALUES (\n    '{{ $items(\"Prepare Contact Data\")[0].json.emailData.email }}',\n    {{ $items(\"Prepare Contact Data\")[0].json.addressbookId }},\n    '{{ $items(\"Prepare Contact Data\")[0].json.language === \"ru\" ? \"leads_ru\" : \"leads_en\" }}',\n    'added',\n    NOW()\n)\nON CONFLICT (email, addressbook_id) \nDO UPDATE SET \n    sync_status = 'updated',\n    sync_date = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "369f55a6-b2ef-425e-8e52-212e17c83d26",
      "name": "Log SendPulse Sync",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -16736,
        -3296
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –õ–æ–≥–∏—Ä—É–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º\nconst data = $items(\"Prepare Contact Data\")[0].json;\n\nconsole.log(`User ${data.emailData.email} is already a customer. Skipping add to leads list.`);\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nreturn [{\n  json: {\n    email: data.emailData.email,\n    status: 'already_customer',\n    message: 'User is already a customer, not added to leads list',\n    addressbookId: data.customersBookId,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "a083c1b9-cd24-4bc2-ba5c-a838c7096304",
      "name": "Log Existing Customer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -17424,
        -2848
      ]
    },
    {
      "parameters": {
        "url": "=https://api.sendpulse.com/addressbooks/{{ $json.addressbookId }}/emails/{{ $json.emailData.email }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.tokenType }} {{ $json.token }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "db13f9ee-4852-4e28-a687-ca6a015d9c0e",
      "name": "Check if Already Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -17264,
        -3104
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message }}",
              "rightValue": "Email not found",
              "operator": {
                "type": "string",
                "operation": "contains"
              },
              "id": "6fe44b79-011f-486b-9db5-95bd0caf74e0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3d7cb5b3-1cdc-46b8-9541-e269be7a6f32",
      "name": "Already in Leads?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -17088,
        -3104
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –∏–∑ —É–∑–ª–∞ Save Email Record1\nconst emailData = $items(\"Save Email Record1\")[0].json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω SendPulse –∏–∑ —É–∑–ª–∞ Get SendPulse Token\nconst sendPulseToken = $items(\"Get SendPulse Token\")[0].json;\n\n// ID –∞–¥—Ä–µ—Å–Ω—ã—Ö –∫–Ω–∏–≥ –≤ SendPulse\nconst ADDRESSBOOKS = {\n  'leads_ru': 1590447,     // ID —Ä—É—Å—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'leads_en': 1591644,     // ID –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'customers_ru': 1590611, // ID –∫–Ω–∏–≥–∏ —Ä—É—Å—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n  'customers_en': 1591645  // ID –∫–Ω–∏–≥–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n};\n\n// –í—ã–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å–Ω—É—é –∫–Ω–∏–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞\nconst language = emailData.language || 'ru';\nconst addressbookId = language === 'ru' ? ADDRESSBOOKS.leads_ru : ADDRESSBOOKS.leads_en;\nconst customersBookId = language === 'ru' ? ADDRESSBOOKS.customers_ru : ADDRESSBOOKS.customers_en;\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Email data from Save Email Record1:', emailData);\nconsole.log('Token received:', sendPulseToken.access_token ? 'Yes' : 'No');\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ SendPulse\nreturn [{\n  json: {\n    token: sendPulseToken.access_token,\n    tokenType: sendPulseToken.token_type || 'Bearer',\n    addressbookId: addressbookId,\n    customersBookId: customersBookId,\n    emailData: {\n      email: emailData.email,\n      variables: {\n        name: emailData.clientName || '',\n        phone: emailData.phone || '',\n        platform: emailData.platform || 'telegram',\n        session_id: emailData.sessionId,\n        lead_score: emailData.leadScore || 50,\n        added_date: new Date().toISOString().split('T')[0]\n      }\n    },\n    language: language,\n    originalData: emailData\n  }\n}];"
      },
      "id": "4c0a1b08-f5b7-4b1c-9853-1f9b0ed60f37",
      "name": "Prepare Contact Data1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -17440,
        -3104
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "73212611-2a14-4a98-8587-14fed2aa3c0f",
              "leftValue": "={{ $json.emailData.emailContent }}||{{ $json.reason }}",
              "rightValue": 50,
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -20096,
        -2480
      ],
      "id": "ba9cfd84-553c-4ea1-a1cc-b384abcf1be5",
      "name": "If"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Check": {
      "main": [
        [
          {
            "node": "Get Unprocessed Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unprocessed Dialogs": {
      "main": [
        [
          {
            "node": "Format Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Dialogs": {
      "main": [
        [
          {
            "node": "Email Decision Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Decision Agent": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Model": {
      "ai_languageModel": [
        [
          {
            "node": "Email Decision Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send Email?": {
      "main": [
        [
          {
            "node": "Check Duplicate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Duplicate": {
      "main": [
        [
          {
            "node": "Merge Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is New Email?": {
      "main": [
        [
          {
            "node": "Get Files from Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Files from Drive": {
      "main": [
        [
          {
            "node": "Send Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Gmail": {
      "main": [
        [
          {
            "node": "Save Email Record1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Email Record": {
      "main": [
        [
          {
            "node": "Prepare Telegram Report",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare SendPulse Auth",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Email Data": {
      "main": [
        [
          {
            "node": "Is New Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Email Record1": {
      "main": [
        [
          {
            "node": "Save Email Record",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Follow-up Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram Report": {
      "main": [
        [
          {
            "node": "Notify Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Follow-up Data": {
      "main": [
        [
          {
            "node": "Schedule Follow-up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare SendPulse Auth": {
      "main": [
        [
          {
            "node": "Get SendPulse Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get SendPulse Token": {
      "main": [
        [
          {
            "node": "Prepare Contact Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Contact Data": {
      "main": [
        [
          {
            "node": "Check if Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Customer": {
      "main": [
        [
          {
            "node": "Is Not Customer?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Not Customer?": {
      "main": [
        [
          {
            "node": "Prepare Contact Data1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Existing Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add to SendPulse": {
      "main": [
        [
          {
            "node": "Log SendPulse Sync",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Already Lead": {
      "main": [
        [
          {
            "node": "Already in Leads?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Already in Leads?": {
      "main": [
        [
          {
            "node": "Add to SendPulse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Contact Data1": {
      "main": [
        [
          {
            "node": "Check if Already Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Should Send Email?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Unprocessed Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e962ecac-3e59-4b65-976d-d8184074b04b",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "kwbiltkxVdA5HWbR",
  "tags": []
}