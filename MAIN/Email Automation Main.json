{
  "name": "Email Automation Main",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trigger-email-analysis",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "55f8bd36-a50b-4162-9f94-681c2551b56e",
      "name": "Email Trigger Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1776,
        -80
      ],
      "webhookId": "email-analysis-trigger",
      "disabled": true
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 3
            }
          ]
        }
      },
      "id": "7dd60b16-bcb2-4ac4-8c50-7ce3a56a026c",
      "name": "Schedule Check",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -2000,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\nWITH recent_messages AS (\n    SELECT \n        session_id,\n        MAX(created_at) as last_message_time,\n        COUNT(*) as message_count\n    FROM (\n        SELECT session_id, created_at FROM n8n_chat_histories_ru\n        WHERE created_at > NOW() - INTERVAL '1 hours'\n        UNION ALL\n        SELECT session_id, created_at FROM n8n_chat_histories_en\n        WHERE created_at > NOW() - INTERVAL '1 hours'\n    ) all_messages\n    GROUP BY session_id\n    HAVING COUNT(*) >= 3 -- –ú–∏–Ω–∏–º—É–º 3 —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\n),\n-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –ª–∏ —É–∂–µ –ø–∏—Å—å–º–æ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏\nalready_sent AS (\n    SELECT DISTINCT session_id\n    FROM email_tracking\n    WHERE status = 'sent'\n      AND email_type IN ('welcome_pdf', 'info_request', 'pricing_info', 'setup_guide')\n      -- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π\n      AND sent_at > NOW() - INTERVAL '7 days'\n),\nnot_processed AS (\n    SELECT rm.session_id\n    FROM recent_messages rm\n    LEFT JOIN already_sent as_sent ON rm.session_id = as_sent.session_id\n    WHERE as_sent.session_id IS NULL -- –¢–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–∏ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º\n)\nSELECT \n    ac.id,\n    ac.session_id,\n    ac.message_type,\n    ac.content,\n    ac.timestamp,\n    ac.platform,\n    ac.language\nFROM (\n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'ru' as language\n    FROM n8n_chat_histories_ru\n    WHERE session_id IN (SELECT session_id FROM not_processed)\n    \n    UNION ALL\n    \n    SELECT \n        id,\n        session_id,\n        message::json->>'type' as message_type,\n        message::json->>'content' as content,\n        created_at as timestamp,\n        platform,\n        'en' as language\n    FROM n8n_chat_histories_en\n    WHERE session_id IN (SELECT session_id FROM not_processed)\n) ac\nORDER BY ac.session_id, ac.timestamp;",
        "options": {}
      },
      "id": "c84e59b0-003c-4af6-8d18-e451564ab99d",
      "name": "Get Unprocessed Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1760,
        240
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –ø–æ —Å–µ—Å—Å–∏—è–º\nconst dialogs = items;\nconst sessions = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    if (!sessions[data.session_id]) {\n        sessions[data.session_id] = {\n            messages: [],\n            language: data.language,\n            platform: data.platform\n        };\n    }\n    \n    sessions[data.session_id].messages.push({\n        type: data.message_type,\n        content: data.content,\n        timestamp: data.timestamp\n    });\n});\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞\nconst dialogsForAnalysis = Object.entries(sessions).map(([sessionId, data]) => {\n    return {\n        sessionId: sessionId,\n        language: data.language,\n        platform: data.platform,\n        conversation: data.messages.map(msg => \n            `${msg.type === 'human' ? '–ö–ª–∏–µ–Ω—Ç' : '–ë–æ—Ç'}: ${msg.content}`\n        ).join('\\n'),\n        messageCount: data.messages.length,\n        lastMessage: data.messages[data.messages.length - 1]\n    };\n});\n\nreturn dialogsForAnalysis.map(d => ({json: d}));"
      },
      "id": "92f69a9c-a8fb-461f-a1f4-271604d48370",
      "name": "Format Dialogs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1552,
        240
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–ê–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞:\nSession ID: {{ $json.sessionId }}\n–Ø–∑—ã–∫: {{ $json.language }}\n–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {{ $json.platform }}\n\n–î–∏–∞–ª–æ–≥:\n{{ $json.conversation }}",
        "options": {
          "systemMessage": "# –†–æ–ª—å: Email Marketing AI Agent\n\n–¢—ã - —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É –∏ –∞–Ω–∞–ª–∏–∑—É –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ Cryptomator.\n\n# –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–¥—É–∫—Ç–∞:\nCryptomator - —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:\n- PDF –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞\n- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–æ—Ç–∞\n- –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤\n- –û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n\n# –ó–∞–¥–∞—á–∞:\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:\n\n1. **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ email**:\n   - –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n   - –ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª email –¥–ª—è —Å–≤—è–∑–∏\n   - –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–∏–ª –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–æ–¥—É–∫—Ç—É\n   - –ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—â–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞\n\n2. **–ò–∑–≤–ª–µ–∫–∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞**:\n   - Email (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)\n   - –ò–º—è (–µ—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è)\n   - –¢–µ–ª–µ—Ñ–æ–Ω (–µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏–ª)\n   - –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏\n\n3. **–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –ø–∏—Å—å–º–∞**:\n   - welcome_pdf - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å PDF –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–µ–π\n   - info_request - –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n   - pricing_info - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö\n   - setup_guide - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ\n   - followup - –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–∏—Å—å–º–æ\n\n4. **–û–ø—Ä–µ–¥–µ–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–∏—Å—å–º–∞**:\n   - –ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–∏—Ç—å (–∏–∑ Google Drive)\n   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞\n   - Call-to-action\n\n# –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:\n\n1. **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–π email –µ—Å–ª–∏**:\n   - –ù–µ—Ç —è–≤–Ω–æ–≥–æ email –∞–¥—Ä–µ—Å–∞\n   - –ö–ª–∏–µ–Ω—Ç –Ω–µ –¥–∞–≤–∞–ª —Å–æ–≥–ª–∞—Å–∏—è\n   - –î–∏–∞–ª–æ–≥ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–µ–Ω–µ–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π)\n   - –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n   - Email —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å –≤ –±–∞–∑–µ)\n\n2. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ø—Ä–∞–≤–ª—è–π –µ—Å–ª–∏**:\n   - –ö–ª–∏–µ–Ω—Ç –ø—Ä—è–º–æ –ø–æ–ø—Ä–æ—Å–∏–ª –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n   - –ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–≤–∏–ª email —Å –ø—Ä–æ—Å—å–±–æ–π —Å–≤—è–∑–∞—Ç—å—Å—è\n   - –ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n   - Lead score > 70 –∏ –µ—Å—Ç—å email\n\n3. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**:\n   - –ò—Å–ø–æ–ª—å–∑—É–π –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ\n   - –ê–¥–∞–ø—Ç–∏—Ä—É–π —Ç–æ–Ω –ø–æ–¥ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É (Telegram –±–æ–ª–µ–µ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π)\n   - –£—á–∏—Ç—ã–≤–∞–π —è–∑—ã–∫ –¥–∏–∞–ª–æ–≥–∞ (ru/en)\n   - –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞\n\n4. **–§–∞–π–ª—ã –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è**:\n   - presentation_ru.pdf / presentation_en.pdf - –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è\n   - setup_guide_ru.pdf / setup_guide_en.pdf - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞\n   - pricing_ru.pdf / pricing_en.pdf - —Ç–∞—Ä–∏—Ñ—ã\n   - faq_ru.pdf / faq_en.pdf - —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô HTML –§–û–†–ú–ê–¢ –ü–ò–°–¨–ú–ê (–°–ü–ê–ú-–ë–ï–ó–û–ü–ê–°–ù–´–ô):\n\n### –ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–û–¢ –®–ê–ë–õ–û–ù –î–õ–Ø emailContent (–†–£–°–°–ö–ê–Ø –í–ï–†–°–ò–Ø):\n\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ{{#if name}}, {{name}}{{/if}}!</p>\n        \n        <p>–ö–∞–∫ –∏ –æ–±–µ—â–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Cryptomator - —Ç–æ—Ä–≥–æ–≤–æ–º –±–æ—Ç–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏.</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            <p>–í—ã –ø—Ä–æ—Å–∏–ª–∏ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞.</p>\n            <p>üìé –í–æ –≤–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞, –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.</p>\n        </div>\n        \n        <div style=\"background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin: 20px 0;\">\n            <h3 style=\"color: #2c5282; margin-top: 0;\">üìä –ß—Ç–æ —É–º–µ–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç Cryptomator:</h3>\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –Ω–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –±–∏—Ä–∂–∞—Ö</li>\n                <li style=\"margin-bottom: 10px;\">üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 6 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞</li>\n                <li style=\"margin-bottom: 10px;\">üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ —Å—Ä–µ–¥—Å—Ç–≤</li>\n                <li style=\"margin-bottom: 10px;\">‚ö° –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>\n            </ul>\n        </div>\n        \n        <h3 style=\"color: #2c5282;\">üí∞ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã:</h3>\n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0;\">\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">üíö <strong>Starter:</strong> $29/–º–µ—Å—è—Ü - –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞</li>\n                <li style=\"margin-bottom: 10px;\">üíô <strong>Professional:</strong> $59/–º–µ—Å—è—Ü - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏</li>\n                <li style=\"margin-bottom: 10px;\">üíú <strong>Enterprise:</strong> $99/–º–µ—Å—è—Ü - –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>\n            </ul>\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro/?utm_source=email&utm_campaign=info#prices\"\n               style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n                üöÄ –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –Ω–∞ —Å–∞–π—Ç–µ\n            </a>\n        </div>\n        \n        <p style=\"background: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0;\">\n    <strong>üéÅ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!</strong><br>\n    –ù–∞—á–Ω–∏—Ç–µ —Å–µ–≥–æ–¥–Ω—è –∏ –ø–æ–ª—É—á–∏—Ç–µ <strong>+1 –º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π</strong> –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.\n</p>\n        \n        <p>–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —ç—Ç–æ –ø–∏—Å—å–º–æ.</p>\n        \n        <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>\n        <strong>–ö–æ–º–∞–Ω–¥–∞ Cryptomator</strong></p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n        \n        <div style=\"text-align: center; padding: 15px 0;\">\n            <p style=\"margin: 5px 0;\">\n                üìß Email: <a href=\"mailto:support@cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">support@cryptomator.pro</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üí¨ Telegram: <a href=\"https://t.me/cryptomator_support\" style=\"color: #3182ce; text-decoration: none;\">@cryptomator_support</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üåê –°–∞–π—Ç: <a href=\"https://cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">cryptomator.pro</a>\n            </p>\n        </div>\n        \n        <p style=\"font-size: 12px; color: #718096; text-align: center; margin-top: 20px;\">\n            –í—ã –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç–æ –ø–∏—Å—å–º–æ, —Ç–∞–∫ –∫–∞–∫ –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—Ä–≥–æ–≤–æ–º –±–æ—Ç–µ Cryptomator.\n        </p>\n    </div>\n</body>\n</html>\n```\n\n–î–õ–Ø –ê–ù–ì–õ–ò–ô–°–ö–û–ô –í–ï–†–°–ò–ò (–µ—Å–ª–∏ language = 'en'):\n\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>Hello{{#if name}}, {{name}}{{/if}}!</p>\n        \n        <p>As promised, we're sending you information about Cryptomator - a trading bot for automating cryptocurrency operations.</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            <p>You requested detailed information about our bot capabilities.</p>\n            <p>üìé Please find attached a presentation with functionality description, examples and usage instructions.</p>\n        </div>\n        \n        <div style=\"background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin: 20px 0;\">\n            <h3 style=\"color: #2c5282; margin-top: 0;\">üìä What Cryptomator Trading Bot Can Do:</h3>\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">‚úÖ Automated trading on cryptocurrency exchanges</li>\n                <li style=\"margin-bottom: 10px;\">üìà Uses 6 different market analysis algorithms</li>\n                <li style=\"margin-bottom: 10px;\">üîê Secure API connection without transferring funds</li>\n                <li style=\"margin-bottom: 10px;\">‚ö° Simple setup and user-friendly control interface</li>\n            </ul>\n        </div>\n        \n        <h3 style=\"color: #2c5282;\">üí∞ Available Plans:</h3>\n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0;\">\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">üíö <strong>Starter:</strong> $29/month - basic bot functionality</li>\n                <li style=\"margin-bottom: 10px;\">üíô <strong>Professional:</strong> $59/month - advanced trading features</li>\n                <li style=\"margin-bottom: 10px;\">üíú <strong>Enterprise:</strong> $99/month - full functionality and priority support</li>\n            </ul>\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro/?utm_source=email&utm_campaign=info#prices\"\n               style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n                üöÄ Learn More on Website\n            </a>\n        </div>\n        \n        <p style=\"background: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0;\">\n    <strong>üéÅ Special Offer!</strong><br>\n    Start today and get <strong>+1 month free</strong> license of your chosen plan.\n</p>\n        \n        <p>If you have any questions after reviewing the materials, just reply to this email.</p>\n        \n        <p>Best regards,<br>\n        <strong>Cryptomator Team</strong></p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n        \n        <div style=\"text-align: center; padding: 15px 0;\">\n            <p style=\"margin: 5px 0;\">\n                üìß Email: <a href=\"mailto:support@cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">support@cryptomator.pro</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üí¨ Telegram: <a href=\"https://t.me/cryptomator_support\" style=\"color: #3182ce; text-decoration: none;\">@cryptomator_support</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üåê Website: <a href=\"https://cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">cryptomator.pro</a>\n            </p>\n        </div>\n        \n        <p style=\"font-size: 12px; color: #718096; text-align: center; margin-top: 20px;\">\n            You received this email because you requested information about Cryptomator trading bot.\n        </p>\n    </div>\n</body>\n</html>\n```\n\n–í–ê–ñ–ù–û:\n–§–û–†–ú–ê–¢ –¢–ï–ú–´ –ü–ò–°–¨–ú–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –° –ò–ú–ï–ù–ï–ú):\n–î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞: \"{{name}}, –∫–∞–∫ –∏ –æ–±–µ—â–∞–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ Cryptomator\"\n–î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ: \"{{name}}, as promised, here's important information about Cryptomator\"\n–ï—Å–ª–∏ –∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ:\n–î–ª—è —Ä—É—Å—Å–∫–æ–≥–æ: \"–ö–∞–∫ –∏ –æ–±–µ—â–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ Cryptomator\"\n–î–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ: \"As promised, here's important information about Cryptomator\"\n–í–ê–ñ–ù–û:\n\n–í –ø–æ–ª–µ \"emailContent\" —Ç–≤–æ–µ–≥–æ JSON-–æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–´–ô HTML-–∫–æ–¥ –≤—ã—à–µ\n–í –ø–æ–ª–µ \"subject\" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—á–∞–ª–µ (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)\n–ü–æ–¥—Å—Ç–∞–≤–ª—è–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ {{name}}\n–ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è language='ru' –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–ª—è language='en'\n–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞: –∑–∞—Ä–∞–±–æ—Ç–æ–∫, –¥–æ—Ö–æ–¥, –ø—Ä–∏–±—ã–ª—å, –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≥–æ–¥–æ–≤—ã—Ö, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞\n–ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n\n# –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON:\n{\n  \"shouldSendEmail\": true/false,\n  \"reason\": \"–ü—Ä–∏—á–∏–Ω–∞ —Ä–µ—à–µ–Ω–∏—è\",\n  \"emailData\": {\n    \"email\": \"–∫–ª–∏–µ–Ω—Ç@example.com\",\n    \"name\": \"–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ null\",\n    \"phone\": \"—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ null\",\n    \"emailType\": \"welcome_pdf/info_request/pricing_info/setup_guide/followup\",\n    \"subject\": \"–¢–µ–º–∞ –ø–∏—Å—å–º–∞\",\n    \"language\": \"ru/en\",\n    \"attachments\": [\n      {\n        \"fileName\": \"strategy_150_ru.pdf\",\n        \"driveId\": \"—Ñ–∞–π–ª_id_–∏–∑_google_drive\"\n      }\n    ],\n    \"emailContent\": \"HTML –∫–æ–Ω—Ç–µ–Ω—Ç –ø–∏—Å—å–º–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π\",\n    \"urgency\": \"high/medium/low\",\n    \"leadScore\": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100\n  },\n  \"extractedNeeds\": [\"—Å–ø–∏—Å–æ–∫ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π\"],\n  \"followUpRecommendation\": \"–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞\"\n}\n\n# –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:\n\nEmail –≤–∞–ª–∏–¥–µ–Ω (—Å–æ–¥–µ—Ä–∂–∏—Ç @ –∏ –¥–æ–º–µ–Ω)\n–ù–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ email_tracking –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏\n–ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —è–∑—ã–∫—É –∫–ª–∏–µ–Ω—Ç–∞\n–í—ã–±—Ä–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —è–∑—ã–∫–∞\n–í —Ç–µ–º–µ –ø–∏—Å—å–º–∞ –µ—Å—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)\n–ù–µ—Ç —Å–ø–∞–º-—Å–ª–æ–≤ (–∑–∞—Ä–∞–±–æ—Ç–æ–∫, –¥–æ—Ö–æ–¥, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø—Ä–∏–±—ã–ª—å)\n\n–í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1376,
        224
      ],
      "id": "a2bf0df5-e51c-430d-a880-9e6687f37bfd",
      "name": "Email Decision Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1440,
        400
      ],
      "id": "b312dced-8394-4740-b404-8d26f7b4e69f",
      "name": "Gemini Model",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Mapping —Ñ–∞–π–ª–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ ID –∏–∑ Google Drive\nconst FILE_MAPPINGS = {\n  'welcome_pdf': {\n    'ru': '1xVXrc_yDynRHugGa-tu7gZYB72N8uieF',\n    'en': '1Hu5FXAtGDGuoZ_h7CnoE_0rCnKpSCrNq'\n  },\n  'strategy': {\n    'ru': '1xVXrc_yDynRHugGa-tu7gZYB72N8uieF',\n    'en': '1Hu5FXAtGDGuoZ_h7CnoE_0rCnKpSCrNq'\n  }\n};\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst aiOutput = $input.first().json.output || $input.first().json;\nconst formatDialogsData = $items(\"Format Dialogs\")[0].json;\n\nlet emailDecision;\n\ntry {\n    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI\n    if (typeof aiOutput === 'string') {\n        // –û—á–∏—Å—Ç–∫–∞ JSON –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n        let cleanJson = aiOutput;\n        cleanJson = cleanJson.replace(/```json\\s*/g, '');\n        cleanJson = cleanJson.replace(/```\\s*/g, '');\n        cleanJson = cleanJson.trim();\n        \n        emailDecision = JSON.parse(cleanJson);\n    } else {\n        emailDecision = aiOutput;\n    }\n    \n    // –ï—Å–ª–∏ AI —Ä–µ—à–∏–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email\n    if (emailDecision.shouldSendEmail) {\n        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –∏ —Ç–∏–ø email\n        const language = emailDecision.emailData?.language || 'ru';\n        const emailType = emailDecision.emailData?.emailType || 'welcome_pdf';\n        \n        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID —Ñ–∞–π–ª–∞\n        const fileId = FILE_MAPPINGS[emailType]?.[language] || \n                      FILE_MAPPINGS['welcome_pdf'][language];\n        \n        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏\n        emailDecision.emailData = {\n            ...emailDecision.emailData,\n            fileId: fileId,\n            attachments: [{\n                driveId: fileId,\n                fileName: `strategy_${language}.pdf`,\n                mimeType: 'application/pdf'\n            }]\n        };\n    }\n    \n    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n    emailDecision.sessionId = formatDialogsData.sessionId;\n    emailDecision.platform = formatDialogsData.platform;\n    emailDecision.processedAt = new Date().toISOString();\n\n} catch (error) {\n    console.error('Parse error details:', error);\n    \n    emailDecision = {\n        shouldSendEmail: false,\n        reason: '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ AI',\n        error: error.toString(),\n        sessionId: formatDialogsData?.sessionId || 'unknown',\n        platform: formatDialogsData?.platform || 'unknown',\n        processedAt: new Date().toISOString()\n    };\n}\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Email decision result:', emailDecision);\n\nreturn [{json: emailDecision}];"
      },
      "id": "9fa108a2-4a3b-4afb-ab60-0cd871f09cb0",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1104,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.shouldSendEmail }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "id": "eda947b2-635d-4137-b710-1b2e4c383b66"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "086a480c-d086-41a9-9f5b-22d92516bfbc",
      "name": "Should Send Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -768,
        240
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    COUNT(*) as duplicate_count,\n    '{{ $json.sessionId }}' as session_id,\n    '{{ $json.emailData.email }}' as email,\n    MAX(sent_at) as last_sent_at,\n    STRING_AGG(email_type, ', ') as sent_types\nFROM email_tracking\nWHERE session_id = '{{ $json.sessionId }}'\n  AND status = 'sent'\n  AND (\n    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª—é–±—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π\n    (email_type IN ('welcome_pdf', 'info_request', 'pricing_info', 'setup_guide') \n     AND sent_at > NOW() - INTERVAL '7 days')\n    OR\n    -- –ò–ª–∏ —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ –ø–∏—Å—å–º–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π\n    (email = '{{ $json.emailData.email }}' \n     AND email_type = '{{ $json.emailData.emailType }}'\n     AND sent_at > NOW() - INTERVAL '30 days')\n  );",
        "options": {}
      },
      "id": "d0a34dcf-4c2c-4cb2-abd8-1c0766c17f2a",
      "name": "Check Duplicate",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -640,
        96
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.duplicate_count }}",
              "rightValue": "0",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "acad2f38-9ae5-4adf-b6eb-25917bb92518"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "7be6cfac-7723-45ce-aafc-1c8eed91b76b",
      "name": "Is New Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -240,
        96
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.emailData.fileId }}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "id": "ccbafda3-9758-46f8-8743-f8048e61f0ec",
      "name": "Get Files from Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -32,
        32
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "2ZNOKD6ZFqAfrDq2",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.emailData.email }}",
        "subject": "={{ $json.emailData.subject }}",
        "message": "={{ $json.emailData.emailContent }}",
        "options": {
          "appendAttribution": false,
          "attachmentsUi": {
            "attachmentsBinary": [
              {}
            ]
          },
          "senderName": "Cryptomator Team",
          "replyTo": "support@cryptomator.pro"
        }
      },
      "id": "6406375e-02de-4691-a2b1-ce8ed3e52579",
      "name": "Send Gmail",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        160,
        32
      ],
      "webhookId": "090d73f6-561b-472b-b6cc-85cf70e39e80",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º email\nINSERT INTO email_tracking (\n    session_id,\n    email,\n    client_name,\n    email_type,\n    subject,\n    content,\n    attachments,\n    status,\n    platform,\n    language,\n    sent_at\n) VALUES (\n    '{{ $json.sessionId }}',\n    '{{ $json.email }}',\n    '{{ $json.clientName }}',\n    '{{ $json.emailType }}',\n    '{{ $json.subject }}',\n    '{{ $json.content }}',\n    '{{ $json.attachments }}'::jsonb,\n    '{{ $json.status }}',\n    '{{ $json.platform }}',\n    '{{ $json.language }}',\n    NOW()\n)\nRETURNING *;",
        "options": {}
      },
      "id": "0d397a2e-5018-44cf-ab62-5c430f89cc65",
      "name": "Save Email Record",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        32
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "-1002588885971",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "16dbaa07-d525-4c47-9b13-890f1764b8da",
      "name": "Notify Manager",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        960,
        32
      ],
      "webhookId": "68e9f810-a972-4f5b-9433-259b598cc8d8",
      "credentials": {
        "telegramApi": {
          "id": "bHlhE9zUMfwWqM9t",
          "name": "Manager Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({status: 'success', message: 'Workflow executed', processed: $json.processed || 0}) }}",
        "options": {}
      },
      "id": "a8ca8481-9149-4c97-89a0-f9e7b1193839",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1152,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –∏–∑ Parse AI Response\nconst emailData = $items(\"Parse AI Response\")[0].json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤\nconst duplicateCheck = $input.first().json;\n\n// –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–∞–ª—å—à–µ, –≤–∫–ª—é—á–∞—è duplicate_count\nreturn [{\n  json: {\n    ...emailData,\n    shouldSendEmail: emailData.shouldSendEmail,\n    emailData: emailData.emailData,\n    sessionId: emailData.sessionId,\n    platform: emailData.platform,\n    duplicate_count: duplicateCheck.duplicate_count // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ –ø–æ–ª–µ!\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -432,
        96
      ],
      "id": "afac6186-d11d-4e9c-80e7-6662bcdec4a8",
      "name": "Merge Email Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–∏—Å—å–º–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst emailData = $items(\"Is New Email?\")[0].json;\nconst gmailResponse = $input.first().json;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è SQL —Å—Ç—Ä–æ–∫\nfunction escapeSql(str) {\n  if (!str) return '';\n  return str.replace(/'/g, \"''\");\n}\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î\nreturn [{\n  json: {\n    sessionId: emailData.sessionId || 'test_en_001',\n    email: emailData.emailData.email,\n    clientName: escapeSql(emailData.emailData.name),\n    emailType: emailData.emailData.emailType || 'welcome_pdf',\n    subject: escapeSql(emailData.emailData.subject),\n    content: escapeSql(emailData.emailData.emailContent),\n    attachments: JSON.stringify(emailData.emailData.attachments || []),\n    status: 'sent',\n    platform: emailData.platform || 'telegram',\n    language: emailData.emailData.language || 'ru',\n    gmailId: gmailResponse.id,\n    gmailThreadId: gmailResponse.threadId,\n    sentAt: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        32
      ],
      "id": "5663d3b1-b8ea-41c8-9c79-c9cf3e74850e",
      "name": "Save Email Record1"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞ Save Email Record\nconst saveResult = $input.first().json;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ Markdown V2\nfunction escapeMarkdown(text) {\n  if (!text) return '';\n  return String(text)\n    .replace(/\\\\/g, '\\\\\\\\')\n    .replace(/\\*/g, '\\\\*')\n    .replace(/_/g, '\\\\_')\n    .replace(/\\[/g, '\\\\[')\n    .replace(/\\]/g, '\\\\]')\n    .replace(/\\(/g, '\\\\(')\n    .replace(/\\)/g, '\\\\)')\n    .replace(/~/g, '\\\\~')\n    .replace(/`/g, '\\\\`')\n    .replace(/>/g, '\\\\>')\n    .replace(/#/g, '\\\\#')\n    .replace(/\\+/g, '\\\\+')\n    .replace(/-/g, '\\\\-')\n    .replace(/=/g, '\\\\=')\n    .replace(/\\|/g, '\\\\|')\n    .replace(/\\{/g, '\\\\{')\n    .replace(/\\}/g, '\\\\}')\n    .replace(/\\./g, '\\\\.')\n    .replace(/!/g, '\\\\!');\n}\n\n// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\nconst safeName = escapeMarkdown(saveResult.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω');\nconst safeEmail = escapeMarkdown(saveResult.email);\nconst safeSubject = escapeMarkdown(saveResult.subject);\nconst safePlatform = escapeMarkdown(saveResult.platform);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á–µ—Ç –¥–ª—è Telegram —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º\nconst report = `üìß *Email —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω\\\\!*\n\nüë§ *–ö–ª–∏–µ–Ω—Ç:* ${safeName}\nüìÆ *Email:* ${safeEmail}\nüåê *–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:* ${safePlatform}\nüó£Ô∏è *–Ø–∑—ã–∫:* ${saveResult.language === 'ru' ? 'üá∑üá∫ –†—É—Å—Å–∫–∏–π' : 'üá¨üáß English'}\n\nüìé *–¢–∏–ø –ø–∏—Å—å–º–∞:* ${escapeMarkdown(saveResult.email_type)}\nüìÑ *–¢–µ–º–∞:* ${safeSubject}\n\n‚úÖ *–°—Ç–∞—Ç—É—Å:* ${saveResult.status}\nüÜî *ID –∑–∞–ø–∏—Å–∏:* ${saveResult.id}\nüîó *Session ID:* ${escapeMarkdown(saveResult.session_id)}\n\n‚è∞ *–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:* ${escapeMarkdown(new Date().toLocaleString('ru-RU', {\n  timeZone: 'Europe/Moscow'\n}))}\n\nüíØ *Lead Score:* ${saveResult.lead_score || 0}\n\n\\\\#email\\\\_sent \\\\#${saveResult.platform} \\\\#${saveResult.language}`;\n\nreturn [{\n  json: {\n    message: report,\n    parse_mode: 'MarkdownV2',  // –ò—Å–ø–æ–ª—å–∑—É–µ–º MarkdownV2\n    chat_id: '-1002588885971'  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π ID –≥—Ä—É–ø–ø—ã\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        32
      ],
      "id": "b47ea576-5761-4799-9b3f-70123b7a7134",
      "name": "Prepare Telegram Report"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã\nINSERT INTO email_follow_ups (\n    email,\n    thread_id,\n    follow_up_date,\n    status,\n    notes,\n    created_at\n) \nSELECT\n    '{{ $json.to }}',  -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 'to', –Ω–µ 'email'\n    '{{ $json.threadId }}',  -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 'threadId'\n    NOW() + INTERVAL '3 days',\n    'pending',\n    'Lead Score: {{ $json.leadScore || 0 }}',\n    NOW()\nWHERE '{{ $json.to }}' != 'undefined'  -- –ó–∞—â–∏—Ç–∞ –æ—Ç undefined\n  AND '{{ $json.threadId }}' != 'undefined'\n  AND NOT EXISTS (\n    SELECT 1 FROM email_follow_ups \n    WHERE email = '{{ $json.to }}'\n    AND (\n        status = 'pending'\n        OR (status = 'sent' AND sent_at > NOW() - INTERVAL '7 days')\n    )\n);\n\nSELECT 'Follow-up processed' as status;",
        "options": {}
      },
      "id": "ef0da003-1883-4b7b-9fdb-0d215624289d",
      "name": "Schedule Follow-up",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        528,
        -192
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "b142612c-8717-43b5-a814-8bde252502b1",
      "name": "Check Twice Daily",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -2016,
        1392
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º follow-ups –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è\nWITH pending_followups AS (\n    SELECT \n        f.*,\n        gc.messages,\n        gc.lead_score,\n        gc.language,\n        gc.subject,\n        gc.message_count,\n        -- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞\n        CASE \n            WHEN gc.message_count IS NULL OR gc.message_count = 0 THEN 'no_response'\n            WHEN gc.lead_score >= 70 THEN 'high_interest'\n            WHEN gc.message_count >= 2 THEN 'active_discussion'  -- –ò–∑–º–µ–Ω–µ–Ω–æ —Å 3 –Ω–∞ 2\n            WHEN gc.lead_score >= 50 THEN 'standard'\n            ELSE 'low_interest'\n        END as followup_type\n    FROM email_follow_ups f\n    LEFT JOIN gmail_conversations gc ON f.thread_id = gc.thread_id\n    WHERE f.status = 'pending'\n      AND f.follow_up_date <= NOW()\n      AND f.follow_up_date > NOW() - INTERVAL '24 hours'\n)\nSELECT * FROM pending_followups\nORDER BY follow_up_date ASC\nLIMIT 20;",
        "options": {}
      },
      "id": "fa31c508-99eb-4c22-930a-5f169f8f20f2",
      "name": "Get Pending Follow-ups",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1840,
        1392
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.lead_score }}",
              "rightValue": 50,
              "operator": {
                "type": "number",
                "operation": "gte"
              },
              "id": "9199afa8-e9b6-41a9-9867-ec632dbd6765"
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "765f23f6-c831-48ac-8bc5-5b9c739a2232",
      "name": "Check Follow-up Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1648,
        1392
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Email: {{ $json.email }}\n–Ø–∑—ã–∫: {{ $json.language }}\nLead Score: {{ $json.lead_score }}\n–¢–∏–ø follow-up: {{ $json.followup_type }}\n–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–µ–º–∞: {{ $json.subject }}\n–ò—Å—Ç–æ—Ä–∏—è: {{ $json.messages }}",
        "options": {
          "systemMessage": "–¢—ã - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º Cryptomator. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ follow-up –ø–∏—Å—å–º–æ.\n\n# –¢–ò–ü–´ FOLLOW-UP:\n\n## no_response (–∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ)\n–ù–µ –ø–∏—à–∏! –í–æ–∑–≤—Ä–∞—â–∞–π shouldSend: false. –û–¥–Ω–æ–≥–æ –ø–∏—Å—å–º–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.\n\n## high_interest (lead_score >= 70)\n–û—Ç–ø—Ä–∞–≤—å –ø–∏—Å—å–º–æ —Å:\n- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º\n- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–∫–∏–¥–∫–æ–π 15%\n- –°—Å—ã–ª–∫–æ–π –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –∑–≤–æ–Ω–∫–∞\n\n## active_discussion (–∞–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞)\n–û—Ç–ø—Ä–∞–≤—å –ø–∏—Å—å–º–æ —Å:\n- –û—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–º–Ω–µ–Ω–∏—è\n- –ö–µ–π—Å–∞–º–∏ —É—Å–ø–µ—à–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º\n\n## standard\n–û—Ü–µ–Ω–∏–≤–∞–π –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π.\n\n# –ü–†–ê–í–ò–õ–ê:\n1. –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–π follow-up –µ—Å–ª–∏:\n   - –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ (no_response)\n   - Lead score < 30\n   - –ü—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 7 –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞\n   \n2. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ø—Ä–∞–≤–ª—è–π –µ—Å–ª–∏:\n   - Lead score >= 70\n   - –ë—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ (3+ —Å–æ–æ–±—â–µ–Ω–∏—è)\n\n# –®–ê–ë–õ–û–ù –ü–ò–°–¨–ú–ê:\n\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>{–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ}</p>\n        \n        <p>{–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ}</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            {–æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–º–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ}\n        </div>\n        \n        <div style=\"background: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0;\">\n            <strong>üíé –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</strong><br>\n            {—Å–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –¥–µ–¥–ª–∞–π–Ω–æ–º}\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro/?utm_source=email&utm_campaign=followup&lang={—è–∑—ã–∫}#prices\" \n               style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n                {–ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é}\n            </a>\n        </div>\n        \n        <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>\n        <strong>–ö–æ–º–∞–Ω–¥–∞ Cryptomator</strong></p>\n    </div>\n</body>\n</html>\n```\n\n# JSON –û–¢–í–ï–¢ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞ —è–∑—ã–∫–µ –∏–∑ –ø–æ–ª—è language):\n```json\n{\n  \"shouldSend\": true/false,\n  \"reason\": \"–ï—Å–ª–∏ language='ru' - –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ language='en' - reason in English\",\n  \"emailContent\": \"HTML –ø–∏—Å—å–º–∞ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ (ru/en)\",\n  \"subject\": \"–ï—Å–ª–∏ language='ru' - —Ç–µ–º–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ï—Å–ª–∏ language='en' - subject in English\",\n  \"discount\": \"—Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å / discount amount if any\",\n  \"urgency\": \"high/medium/low\"\n}\n```\n\n–í–ê–ñ–ù–û:\n\n–ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–æ language='ru' - –í–°–ï –ø–æ–ª—è (reason, emailContent, subject) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ\n–ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–æ language='en' - –í–°–ï –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –ê–ù–ì–õ–ò–ô–°–ö–û–ú —è–∑—ã–∫–µ\n–ü–æ–ª–µ reason –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞\n\n–ü—Ä–∏–º–µ—Ä—ã:\n–î–ª—è language='ru':\n{\n  \"shouldSend\": true,\n  \"reason\": \"Lead score 70, –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å. –ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–≤–∞–ª –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–∞—Ä–∏—Ñ–∞—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ —Å–∫–∏–¥–∫–æ–π 15%\",\n  \"emailContent\": \"<html>...</html>\",\n  \"subject\": \"–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞—Å - —Å–∫–∏–¥–∫–∞ 15%\",\n  \"discount\": \"15%\",\n  \"urgency\": \"high\"\n}\n\n–î–ª—è language='en':\n\n{\n  \"shouldSend\": true,\n  \"reason\": \"Lead score 70, high interest type. Client has shown significant interest after presentation. Sending personalized offer with discount\",\n  \"emailContent\": \"<html>...</html>\",\n  \"subject\": \"Special offer for you - 15% discount\",\n  \"discount\": \"15%\",\n  \"urgency\": \"high\"\n}"
        }
      },
      "id": "47fc6db1-7c75-4be2-836f-46541b053f97",
      "name": "Generate Follow-up",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1376,
        1168
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI\nconst aiResponse = $input.first().json;\nconst originalData = $items(\"Check Follow-up Type\")[0].json;\n\nlet decision;\ntry {\n    if (typeof aiResponse.output === 'string') {\n        const cleanJson = aiResponse.output\n            .replace(/```json\\n?/g, '')\n            .replace(/```\\n?/g, '')\n            .trim();\n        decision = JSON.parse(cleanJson);\n    } else {\n        decision = aiResponse.output;\n    }\n} catch (error) {\n    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º\n    decision = {\n        shouldSend: false,\n        reason: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞'\n    };\n}\n\n// –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\nreturn [{\n    json: {\n        ...originalData,\n        ...decision,\n        followup_id: originalData.id\n    }\n}];"
      },
      "id": "cc73b543-da95-4581-ac02-377b791f7b52",
      "name": "Parse Decision",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        1184
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.shouldSend }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "id": "81343c75-40af-4fbe-8071-b3b55779e19b"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9b0bc603-9121-4efa-b056-21d253e22b82",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -816,
        1248
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.emailContent }}",
        "options": {
          "appendAttribution": false,
          "senderName": "Cryptomator Team",
          "replyTo": "support@cryptomator.pro"
        }
      },
      "id": "6cf97c19-1d1d-47d5-9ea6-b96b273c7312",
      "name": "Send Follow-up Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -608,
        1232
      ],
      "webhookId": "e2bf2b84-361a-4aa3-be4a-995f48c02372",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å follow-up\nUPDATE email_follow_ups\nSET \n    status = 'sent',\n    sent_at = NOW(),\n    notes = CONCAT(notes, ' | Sent: ', NOW()::text)\nWHERE id = {{ $json.followup_id }};\n\n-- –û–±–Ω–æ–≤–ª—è–µ–º gmail_conversations\nUPDATE gmail_conversations\nSET \n    message_count = message_count + 1\nWHERE thread_id = '{{ $json.thread_id }}';\n\nSELECT 'Follow-up sent' as status;",
        "options": {}
      },
      "id": "867d182a-21ee-484a-9c8b-2409df73f644",
      "name": "Update Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -224,
        1232
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π\nUPDATE email_follow_ups\nSET \n    status = 'skipped',\n    notes = CONCAT(notes, ' | Skipped: ', '{{ $json.reason.replace(/'/g, \"''\") }}')\nWHERE id = {{ $json.followup_id }};\n\nSELECT 'Skipped' as status;",
        "options": {}
      },
      "id": "af7c6a35-97a6-461f-9930-33ea2de0d902",
      "name": "Mark as Skipped",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -304,
        1488
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "ead364a6-a921-4d9b-abe7-632c595d62c8",
      "name": "Gemini Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1424,
        1328
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "-1002588885971",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "61385941-7b8c-402b-bf5e-b498fd0b97b5",
      "name": "Notify Telegram1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        256,
        1408
      ],
      "webhookId": "984ce731-decd-4600-a4e1-6841c6db60c9",
      "credentials": {
        "telegramApi": {
          "id": "bHlhE9zUMfwWqM9t",
          "name": "Manager Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞\nconst inputData = $input.first().json;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö\nconst email = inputData.email || inputData.from || 'no-email';\nconst threadId = inputData.gmailThreadId || inputData.threadId || 'no-thread';\nconst leadScore = inputData.leadScore || 50;\n\n// –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Input data:', inputData);\nconsole.log('Extracted - Email:', email, 'ThreadId:', threadId, 'LeadScore:', leadScore);\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Schedule Follow-up\nreturn [{\n  json: {\n    to: email,\n    threadId: threadId,\n    leadScore: leadScore,\n    followUpDays: 3,\n    internalNote: `–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç. Lead Score: ${leadScore}`\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        -192
      ],
      "id": "765c1115-39a3-49d7-b575-f37099f52713",
      "name": "Prepare Follow-up Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst parseDecision = $items(\"Parse Decision\")[0].json;\nconst pendingData = $items(\"Get Pending Follow-ups\")[0].json;\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Update Status\nreturn [{\n  json: {\n    followup_id: pendingData.id,\n    email: pendingData.email,\n    thread_id: pendingData.thread_id,\n    lead_score: pendingData.lead_score,\n    emailContent: parseDecision.emailContent ? \n                  parseDecision.emailContent.substring(0, 500) : \n                  'Follow-up sent'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        1232
      ],
      "id": "a49faf33-2648-44e2-8f26-64204143d24d",
      "name": "Prepare Update Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö follow-ups\nconst parseDecision = $items(\"Parse Decision\")[0].json;\nconst pendingData = $items(\"Get Pending Follow-ups\")[0].json;\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Mark as Skipped\nreturn [{\n  json: {\n    followup_id: pendingData.id,\n    reason: parseDecision.reason || '–ù–∏–∑–∫–∏–π lead score –∏–ª–∏ no_response'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        1376
      ],
      "id": "3d18513e-735d-4183-9495-249f63ec58bd",
      "name": "Prepare Skip Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞\nconst sqlResult = $input.first().json;\nconst pendingData = $items(\"Get Pending Follow-ups\")[0]?.json || {};\nconst parseDecision = $items(\"Parse Decision\")[0]?.json || {};\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å\nlet status = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';\nif (sqlResult?.status === 'Follow-up sent') {\n  status = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';\n} else if (sqlResult?.status === 'Skipped') {\n  status = '–ü—Ä–æ–ø—É—â–µ–Ω–æ';\n}\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ\nconst email = pendingData.email || '–ù–µ —É–∫–∞–∑–∞–Ω';\nconst leadScore = pendingData.lead_score || 0;\n\n// –û—á–∏—â–∞–µ–º reason –æ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è Telegram\nlet reason = parseDecision.reason || '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞';\n// –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã\nreason = reason\n  .replace(/'/g, '')\n  .replace(/\"/g, '')\n  .replace(/`/g, '')\n  .replace(/\\n/g, ' ')\n  .substring(0, 200); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤\nconst icon = status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' ? '‚úÖ' : '‚è≠Ô∏è';\nconst message = `üìä Follow-up Report\n\n${icon} –°—Ç–∞—Ç—É—Å: ${status}\nüìß Email: ${email}\nüíØ Lead Score: ${leadScore}\nüìù –ü—Ä–∏—á–∏–Ω–∞: ${reason}`;\n\nreturn [{\n  json: {\n    message: message\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        1408
      ],
      "id": "911bb64e-866a-46d5-b30f-f77b5b8e862e",
      "name": "Prepare Telegram Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å SendPulse\nCREATE TABLE IF NOT EXISTS sendpulse_sync (\n    id SERIAL PRIMARY KEY,\n    email VARCHAR(255) NOT NULL,\n    addressbook_id INTEGER NOT NULL,\n    addressbook_name VARCHAR(100) NOT NULL,\n    sync_status VARCHAR(50) NOT NULL,\n    sync_date TIMESTAMP DEFAULT NOW(),\n    error_message TEXT,\n    UNIQUE(email, addressbook_id)\n);\n\nCREATE TABLE IF NOT EXISTS sendpulse_addressbooks (\n    id INTEGER PRIMARY KEY,\n    name VARCHAR(100) NOT NULL,\n    type VARCHAR(50) NOT NULL, -- 'leads' or 'customers'\n    language VARCHAR(10) NOT NULL,\n    last_sync TIMESTAMP\n);\n\n-- –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥—Ä–µ—Å–Ω—ã—Ö –∫–Ω–∏–≥–∞—Ö (–∑–∞–º–µ–Ω–∏—Ç–µ ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ)\nINSERT INTO sendpulse_addressbooks (id, name, type, language)\nVALUES \n    (123456, 'leads_ru', 'leads', 'ru'),\n    (123457, 'leads_en', 'leads', 'en'),\n    (123458, 'customers_ru', 'customers', 'ru'),\n    (123459, 'customers_en', 'customers', 'en')\nON CONFLICT (id) DO NOTHING;\n\nSELECT 'Tables created successfully' as status;",
        "options": {}
      },
      "id": "81e6c890-148b-4c9e-870d-c0377c4e66c2",
      "name": "Initialize SendPulse Tables",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2000,
        -80
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è SendPulse OAuth\n// –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ API credentials –∏–∑ SendPulse\nconst SENDPULSE_API_ID = 'e00470078ad763936dc9578bbe148414'; \nconst SENDPULSE_API_SECRET = 'e98d876685d4779e7248fd6a9cc65e13';\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞\nreturn [{\n  json: {\n    grant_type: 'client_credentials',\n    client_id: SENDPULSE_API_ID,\n    client_secret: SENDPULSE_API_SECRET\n  }\n}];"
      },
      "id": "7527c788-87fd-4750-b115-502880c162d8",
      "name": "Prepare SendPulse Auth",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        -208
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendpulse.com/oauth/access_token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "grant_type",
              "value": "={{ $json.grant_type }}"
            },
            {
              "name": "client_id",
              "value": "={{ $json.client_id }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $json.client_secret }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1a88054f-c41b-4054-8c69-589cdfdbed27",
      "name": "Get SendPulse Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        960,
        -208
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –∏–∑ —É–∑–ª–∞ Save Email Record1\nconst emailData = $items(\"Save Email Record1\")[0].json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω SendPulse –∏–∑ —É–∑–ª–∞ Get SendPulse Token\nconst sendPulseToken = $items(\"Get SendPulse Token\")[0].json;\n\n// ID –∞–¥—Ä–µ—Å–Ω—ã—Ö –∫–Ω–∏–≥ –≤ SendPulse\nconst ADDRESSBOOKS = {\n  'leads_ru': 1590447,     // ID —Ä—É—Å—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'leads_en': 1591644,     // ID –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'customers_ru': 1590611, // ID –∫–Ω–∏–≥–∏ —Ä—É—Å—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n  'customers_en': 1591645  // ID –∫–Ω–∏–≥–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n};\n\n// –í—ã–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å–Ω—É—é –∫–Ω–∏–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞\nconst language = emailData.language || 'ru';\nconst addressbookId = language === 'ru' ? ADDRESSBOOKS.leads_ru : ADDRESSBOOKS.leads_en;\nconst customersBookId = language === 'ru' ? ADDRESSBOOKS.customers_ru : ADDRESSBOOKS.customers_en;\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Email data from Save Email Record1:', emailData);\nconsole.log('Token received:', sendPulseToken.access_token ? 'Yes' : 'No');\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ SendPulse\nreturn [{\n  json: {\n    token: sendPulseToken.access_token,\n    tokenType: sendPulseToken.token_type || 'Bearer',\n    addressbookId: addressbookId,\n    customersBookId: customersBookId,\n    emailData: {\n      email: emailData.email,\n      variables: {\n        name: emailData.clientName || '',\n        phone: emailData.phone || '',\n        platform: emailData.platform || 'telegram',\n        session_id: emailData.sessionId,\n        lead_score: emailData.leadScore || 50,\n        added_date: new Date().toISOString().split('T')[0]\n      }\n    },\n    language: language,\n    originalData: emailData\n  }\n}];"
      },
      "id": "154bf010-e17e-4017-a1d5-1145174918ff",
      "name": "Prepare Contact Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        -208
      ]
    },
    {
      "parameters": {
        "url": "=https://api.sendpulse.com/addressbooks/{{ $json.customersBookId }}/emails/{{ $json.emailData.email }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.tokenType }} {{ $json.token }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "c220054d-c249-4a8d-8523-2f6bc66bcca3",
      "name": "Check if Customer",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1344,
        -208
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message }}",
              "rightValue": "Email not found",
              "operator": {
                "type": "string",
                "operation": "contains"
              },
              "id": "6fe44b79-011f-486b-9db5-95bd0caf74e0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9333463f-947a-4fcb-a483-a7ae2064cdef",
      "name": "Is Not Customer?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1536,
        -208
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.sendpulse.com/addressbooks/{{ $items(\"Prepare Contact Data\")[0].json.addressbookId }}/emails",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $items(\"Prepare Contact Data\")[0].json.tokenType }} {{ $items(\"Prepare Contact Data\")[0].json.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"emails\": [\n    {\n      \"email\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.email) }},\n      \"variables\": {\n        \"name\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.name) }},\n        \"Phone\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.phone) }},\n        \"platform\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.platform) }},\n        \"session_id\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.session_id) }},\n        \"lead_score\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.lead_score) }},\n        \"added_date\": {{ JSON.stringify($items(\"Prepare Contact Data\")[0].json.emailData.variables.added_date) }}\n      }\n    }\n  ]\n}",
        "options": {}
      },
      "id": "1284cfd9-9af4-4560-a2aa-e2a630eeefad",
      "name": "Add to SendPulse",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2240,
        -400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO sendpulse_sync (\n    email,\n    addressbook_id,\n    addressbook_name,\n    sync_status,\n    sync_date\n) VALUES (\n    '{{ $items(\"Prepare Contact Data\")[0].json.emailData.email }}',\n    {{ $items(\"Prepare Contact Data\")[0].json.addressbookId }},\n    '{{ $items(\"Prepare Contact Data\")[0].json.language === \"ru\" ? \"leads_ru\" : \"leads_en\" }}',\n    'added',\n    NOW()\n)\nON CONFLICT (email, addressbook_id) \nDO UPDATE SET \n    sync_status = 'updated',\n    sync_date = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "ab90c5f0-76fc-4d1e-b6e4-31e61367684b",
      "name": "Log SendPulse Sync",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2400,
        -560
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –õ–æ–≥–∏—Ä—É–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º\nconst data = $items(\"Prepare Contact Data\")[0].json;\n\nconsole.log(`User ${data.emailData.email} is already a customer. Skipping add to leads list.`);\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nreturn [{\n  json: {\n    email: data.emailData.email,\n    status: 'already_customer',\n    message: 'User is already a customer, not added to leads list',\n    addressbookId: data.customersBookId,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "fdbb7f9c-ccd8-4e33-bb4f-0425007c3fa7",
      "name": "Log Existing Customer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1712,
        -112
      ]
    },
    {
      "parameters": {
        "url": "=https://api.sendpulse.com/addressbooks/{{ $json.addressbookId }}/emails/{{ $json.emailData.email }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.tokenType }} {{ $json.token }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "f25ac454-23f7-4cc2-9331-469e5e77cd65",
      "name": "Check if Already Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1872,
        -368
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message }}",
              "rightValue": "Email not found",
              "operator": {
                "type": "string",
                "operation": "contains"
              },
              "id": "6fe44b79-011f-486b-9db5-95bd0caf74e0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "279e8b6a-a155-4b7d-b3aa-9e4880e76866",
      "name": "Already in Leads?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2048,
        -368
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –∏–∑ —É–∑–ª–∞ Save Email Record1\nconst emailData = $items(\"Save Email Record1\")[0].json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω SendPulse –∏–∑ —É–∑–ª–∞ Get SendPulse Token\nconst sendPulseToken = $items(\"Get SendPulse Token\")[0].json;\n\n// ID –∞–¥—Ä–µ—Å–Ω—ã—Ö –∫–Ω–∏–≥ –≤ SendPulse\nconst ADDRESSBOOKS = {\n  'leads_ru': 1590447,     // ID —Ä—É—Å—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'leads_en': 1591644,     // ID –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –∫–Ω–∏–≥–∏ –ª–∏–¥–æ–≤\n  'customers_ru': 1590611, // ID –∫–Ω–∏–≥–∏ —Ä—É—Å—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n  'customers_en': 1591645  // ID –∫–Ω–∏–≥–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n};\n\n// –í—ã–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å–Ω—É—é –∫–Ω–∏–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞\nconst language = emailData.language || 'ru';\nconst addressbookId = language === 'ru' ? ADDRESSBOOKS.leads_ru : ADDRESSBOOKS.leads_en;\nconst customersBookId = language === 'ru' ? ADDRESSBOOKS.customers_ru : ADDRESSBOOKS.customers_en;\n\n// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nconsole.log('Email data from Save Email Record1:', emailData);\nconsole.log('Token received:', sendPulseToken.access_token ? 'Yes' : 'No');\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ SendPulse\nreturn [{\n  json: {\n    token: sendPulseToken.access_token,\n    tokenType: sendPulseToken.token_type || 'Bearer',\n    addressbookId: addressbookId,\n    customersBookId: customersBookId,\n    emailData: {\n      email: emailData.email,\n      variables: {\n        name: emailData.clientName || '',\n        phone: emailData.phone || '',\n        platform: emailData.platform || 'telegram',\n        session_id: emailData.sessionId,\n        lead_score: emailData.leadScore || 50,\n        added_date: new Date().toISOString().split('T')[0]\n      }\n    },\n    language: language,\n    originalData: emailData\n  }\n}];"
      },
      "id": "10cf3b30-2a35-47a3-882a-21223c58bb6e",
      "name": "Prepare Contact Data1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1696,
        -368
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "9083b0f0-dfaf-4956-ab55-a023f38304a0",
      "name": "SendPulse Sync Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -2016,
        1728
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ leads –∫–Ω–∏–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏\nSELECT DISTINCT \n    ss.email,\n    ss.addressbook_id,\n    ss.addressbook_name,\n    CASE \n        WHEN ss.addressbook_name LIKE '%_ru' THEN 'ru'\n        ELSE 'en'\n    END as language\nFROM sendpulse_sync ss\nWHERE ss.sync_status IN ('added', 'updated')\n  AND ss.addressbook_name IN ('leads_ru', 'leads_en')\n  AND ss.sync_date > NOW() - INTERVAL '30 days'\nLIMIT 100;",
        "options": {}
      },
      "id": "276bc794-099d-4d17-8a0f-06f8f745f101",
      "name": "Get Leads to Check",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1472,
        1728
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "78fd219a-d817-4d57-9d1c-9b9ab5385a32",
      "name": "Split Leads Batch",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1280,
        1728
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏\nconst currentItem = $input.first().json;\nconst sendPulseToken = $items(\"Get SendPulse Token1\")[0].json;\n\n// ID –∞–¥—Ä–µ—Å–Ω—ã—Ö –∫–Ω–∏–≥\nconst ADDRESSBOOKS = {\n  'customers_ru': 1590611,\n  'customers_en': 1591645\n};\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –∫–Ω–∏–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞\nconst customersBookId = currentItem.language === 'ru' ? \n  ADDRESSBOOKS.customers_ru : ADDRESSBOOKS.customers_en;\n\nconsole.log('Checking email:', currentItem.email);\nconsole.log('Customer book ID:', customersBookId);\nconsole.log('Lead book ID:', currentItem.addressbook_id);\n\nreturn [{\n  json: {\n    ...currentItem,\n    token: sendPulseToken.access_token,\n    tokenType: sendPulseToken.token_type || 'Bearer',\n    customersBookId: customersBookId\n  }\n}];"
      },
      "id": "580302a8-0174-4dce-b21d-a03a08e8cc81",
      "name": "Prepare Check Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        1696
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞\nconst response = $input.first().json;\nconst checkData = $items(\"Prepare Check Data\")[0].json;\n\nconsole.log('Check response:', JSON.stringify(response, null, 2));\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–µ–Ω—Ç–æ–º\nlet isCustomer = false;\n\n// –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–∏–º—è, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç.–¥.) - –∑–Ω–∞—á–∏—Ç email –Ω–∞–π–¥–µ–Ω\nif (response && response.email === checkData.email) {\n  isCustomer = true;\n} else if (response.variables && Array.isArray(response.variables)) {\n  // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å–ª–∏ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö\n  isCustomer = true;\n} else if (response.abook_id) {\n  // –ò–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å ID –∞–¥—Ä–µ—Å–Ω–æ–π –∫–Ω–∏–≥–∏\n  isCustomer = true;\n}\n\nconsole.log(`Email ${checkData.email} is customer: ${isCustomer}`);\n\nreturn [{\n  json: {\n    ...checkData,\n    isCustomer: isCustomer,\n    checkResponse: response\n  }\n}];"
      },
      "id": "6cab623f-ae06-46c3-8d1e-fbcd5e24b7fa",
      "name": "Process Check Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        1696
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.isCustomer }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "id": "29e0950c-37f1-422c-9986-afc9f9b588a4"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0ca54629-12bd-4c4f-97ea-806cc1e5d3c7",
      "name": "Became Customer?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -352,
        1696
      ]
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://api.sendpulse.com/addressbooks/{{ $json.addressbook_id }}/emails",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.tokenType }} {{ $json.token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"emails\": [\"{{ $json.email }}\"]\n}",
        "options": {}
      },
      "id": "11762f96-92d4-418b-a934-5b706b9f9947",
      "name": "Remove from Leads",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -176,
        1632
      ]
    },
    {
      "parameters": {
        "jsCode": "// –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∫–ª–∏–µ–Ω—Ç\nconst data = $input.first().json;\n\nconsole.log(`Email ${data.email} is still a lead, keeping in leads list`);\n\n// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Split Batch –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ü–∏–∫–ª–∞\nreturn [{\n  json: {\n    processed: true,\n    email: data.email,\n    stillLead: true\n  }\n}];"
      },
      "id": "8972582b-3f0d-4c7e-8404-39063af3bee1",
      "name": "Log Still Lead",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        1792
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è SendPulse OAuth\nconst SENDPULSE_API_ID = 'e00470078ad763936dc9578bbe148414';\nconst SENDPULSE_API_SECRET = 'e98d876685d4779e7248fd6a9cc65e13';\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞\nreturn [{\n  json: {\n    grant_type: 'client_credentials',\n    client_id: SENDPULSE_API_ID,\n    client_secret: SENDPULSE_API_SECRET\n  }\n}];"
      },
      "id": "4bdbd0aa-56ff-4747-bdb1-dfbfe1b3b2a1",
      "name": "Prepare SendPulse Auth1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1840,
        1728
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendpulse.com/oauth/access_token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "grant_type",
              "value": "={{ $json.grant_type }}"
            },
            {
              "name": "client_id",
              "value": "={{ $json.client_id }}"
            },
            {
              "name": "client_secret",
              "value": "={{ $json.client_secret }}"
            }
          ]
        },
        "options": {}
      },
      "id": "b0c8ad99-3fa3-420d-b9a2-4cbd8c852ce9",
      "name": "Get SendPulse Token1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1664,
        1728
      ]
    },
    {
      "parameters": {
        "jsCode": "// –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—á–∏—Å—Ç–∫—É\nconst result = $input.first().json;\n\nconsole.log(`Successfully moved to customers: ${result.email}`);\nconsole.log(`Removed from addressbook: ${result.addressbook_id}`);\nconsole.log(`Status updated at: ${result.sync_date}`);\n\n// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ Split Batch –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ü–∏–∫–ª–∞\nreturn [{\n  json: {\n    processed: true,\n    email: result.email,\n    movedAt: result.sync_date\n  }\n}];"
      },
      "id": "92d4b8b1-4dbc-4e82-a47f-8c7b2530dfca",
      "name": "Log Success1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        1632
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏\nconst totalProcessed = $items(\"Get Leads to Check\").length;\n\n// –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)\nconst summary = {\n  status: 'completed',\n  totalProcessed: totalProcessed,\n  completedAt: new Date().toISOString(),\n  message: `SendPulse sync completed. Processed ${totalProcessed} lead(s).`\n};\n\nconsole.log('=== SYNC COMPLETE ===');\nconsole.log(summary.message);\nconsole.log('====================');\n\nreturn [{json: summary}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        1552
      ],
      "id": "cc478dc1-c381-40cd-9f78-43e90045b89a",
      "name": "Sync Complete Report"
    },
    {
      "parameters": {
        "url": "=https://api.sendpulse.com/addressbooks/{{ $json.customersBookId }}/emails/{{ $json.email }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $json.tokenType }} {{ $json.token }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "0ec67ccb-ce88-4641-bf41-1b22bc4a1e62",
      "name": "Check Customer Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -752,
        1696
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE sendpulse_sync\nSET \n    sync_status = 'moved_to_customers',\n    sync_date = NOW()\nWHERE email = '{{ $json.email }}'\n  AND addressbook_id = {{ $json.addressbook_id }}\nRETURNING *;",
        "options": {}
      },
      "id": "b68f71b2-9d7e-488d-a452-30ef559c04d5",
      "name": "Remove from Leads2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        192,
        1632
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤\nconst checkData = $items(\"Process Check Result\")[0].json;\nconst removeResult = $input.first().json;\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Update Sync Status\nreturn [{\n  json: {\n    email: checkData.email,\n    addressbook_id: checkData.addressbook_id,\n    removeResult: removeResult.result || true,\n    status: 'moved_to_customers'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        1632
      ],
      "id": "cd07d3e1-783b-4922-8571-43f9f8797378",
      "name": "Prepare Update Data1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "73212611-2a14-4a98-8587-14fed2aa3c0f",
              "leftValue": "={{ $json.emailData.emailContent }}||{{ $json.reason }}",
              "rightValue": 50,
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -960,
        256
      ],
      "id": "9202d0c9-e06e-4da3-863b-0602322f7ca6",
      "name": "If"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1088,
        768
      ],
      "id": "b65afaa3-e3dc-4533-a5e8-0c6b88fcd274",
      "name": "Gemini Model Reply",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI –∞–≥–µ–Ω—Ç–∞\nconst aiResponse = $input.first().json;\nconst historyData = $json;\nconst clientEmail = $('Get History').first().json.email;\n\nconst retryCount = historyData.retryCount || 0;\nif (retryCount > 2) {\n  return []; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫\n}\n\nlet emailContent = '';\nlet shouldSendReply = true;\nlet replyData = {};\n\ntry {\n  // –ü–æ–ª—É—á–∞–µ–º output –æ—Ç AI\n  let output = aiResponse.output;\n  \n  if (typeof output === 'string') {\n    const trimmedOutput = output.trim();\n    \n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å HTML —Ç–µ–≥–æ–≤\n    if (trimmedOutput.startsWith('<!DOCTYPE') || \n        trimmedOutput.startsWith('<html')) {\n      // –≠—Ç–æ —á–∏—Å—Ç—ã–π HTML\n      emailContent = trimmedOutput;\n    } else {\n      // –≠—Ç–æ JSON - –Ω—É–∂–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å\n      try {\n        // –û—á–∏—â–∞–µ–º –æ—Ç markdown –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞\n        const cleanJson = trimmedOutput\n          .replace(/```json\\n?/g, '')\n          .replace(/```\\n?/g, '')\n          .trim();\n        \n        // –ü–∞—Ä—Å–∏–º JSON\n        const parsedData = JSON.parse(cleanJson);\n        \n        // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ\n        if (parsedData.replyData && parsedData.replyData.emailContent) {\n          emailContent = parsedData.replyData.emailContent;\n          replyData = parsedData;\n        } else if (parsedData.emailContent) {\n          emailContent = parsedData.emailContent;\n          replyData = parsedData;\n        } else {\n          // –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π JSON –≤ —Å—Ç—Ä–æ–∫–µ?\n          // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å emailContent –µ—Å–ª–∏ –æ–Ω —Å—Ç—Ä–æ–∫–∞ —Å JSON\n          if (typeof parsedData === 'string' && parsedData.includes('emailContent')) {\n            const innerParsed = JSON.parse(parsedData);\n            if (innerParsed.replyData && innerParsed.replyData.emailContent) {\n              emailContent = innerParsed.replyData.emailContent;\n              replyData = innerParsed;\n            }\n          }\n        }\n        \n        // –ü—Ä–æ–≤–µ—Ä—è–µ–º shouldReply\n        if (parsedData.shouldReply === false) {\n          shouldSendReply = false;\n        }\n        \n      } catch (parseError) {\n        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);\n        // –ú–æ–∂–µ—Ç –±—ã—Ç—å HTML –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Å—Ç—Ä–æ–∫—É\n        if (trimmedOutput.includes('<!DOCTYPE') || trimmedOutput.includes('<html')) {\n          // –ü–æ–ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å HTML –∏–∑ —Å—Ç—Ä–æ–∫–∏\n          const htmlMatch = trimmedOutput.match(/<!DOCTYPE[\\s\\S]*<\\/html>/);\n          if (htmlMatch) {\n            emailContent = htmlMatch[0];\n          }\n        }\n      }\n    }\n  } else if (typeof output === 'object') {\n    replyData = output;\n    if (replyData.replyData && replyData.replyData.emailContent) {\n      emailContent = replyData.replyData.emailContent;\n    } else if (replyData.emailContent) {\n      emailContent = replyData.emailContent;\n    }\n  }\n  \n} catch (e) {\n  console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI –æ—Ç–≤–µ—Ç–∞:', e);\n  return [];\n}\n\n// –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å\nif (!shouldSendReply) {\n  console.log('AI —Ä–µ—à–∏–ª –Ω–µ –æ—Ç–≤–µ—á–∞—Ç—å');\n  return [];\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å HTML –∫–æ–Ω—Ç–µ–Ω—Ç\nif (!emailContent || !emailContent.includes('<')) {\n  console.error('HTML –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π:', emailContent.substring(0, 100));\n  return [];\n}\n\n// –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞\nif (!emailContent || emailContent.length < 50) {\n  return [{\n    json: {\n      needsRetry: true,\n      email: clientEmail,\n      retryCount: retryCount + 1,  // –ó–î–ï–°–¨ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫\n      ...historyData\n    }\n  }];\n}\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏\nreturn [{\n  json: {\n    to: clientEmail,\n    subject: $('Loop Over Items').first().json.subject,\n    emailContent: emailContent, // –¢–æ–ª—å–∫–æ HTML!\n    language: replyData.replyData?.language || historyData.language || 'ru',\n    attachments: replyData.replyData?.attachments || [],\n    threadId: historyData.thread_id,\n    messageId: historyData.messageId,\n    originalBody: historyData.conversation_history || '',\n    senderName: historyData.full_name || 'Client',\n    urgency: replyData.replyData?.urgency || 'medium',\n    leadScore: replyData.clientData?.leadScore || historyData.lead_score || 0,\n    intent: replyData.clientData?.intent || 'information',\n    internalNote: replyData.internalNote || '',\n    followUpDays: replyData.replyData?.followUpDays || 3\n  }\n}];"
      },
      "id": "ba46e865-e71c-4a9f-b94b-37f8c4efa864",
      "name": "Parse AI Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        576
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.emailContent }}",
        "options": {
          "appendAttribution": false,
          "bccList": "",
          "ccList": "",
          "senderName": "Cryptomator Team",
          "replyTo": "={{ $json.to }}"
        }
      },
      "id": "b52cae22-e085-4668-8f77-b86097be15b1",
      "name": "Send Gmail Reply",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -1984,
        912
      ],
      "webhookId": "8eb71c68-b6e1-41b8-b35d-cb51b60a4b61",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "markAsRead",
        "messageId": "={{ $items('Process Incoming')[0].json.messageId }}"
      },
      "id": "8e1a90fa-a100-461a-af4d-d0fbe1902f77",
      "name": "Mark as Read",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -1600,
        912
      ],
      "webhookId": "3a5b53fc-89d0-4694-a5b3-4bd8fe1bd679",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ì–æ—Ç–æ–≤–∏–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á–µ—Ç –¥–ª—è Telegram —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º\nconst emailData = $input.first().json;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¢–û–õ–¨–ö–û –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è Markdown v2\nfunction escapeMarkdown(text) {\n  if (!text) return '';\n  // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–º–∞—é—Ç Markdown\n  return String(text)\n    .replace(/\\\\/g, '\\\\\\\\')  // –û–±—Ä–∞—Ç–Ω—ã–π —Å–ª–µ—à\n    .replace(/\\*/g, '\\\\*')   // –ó–≤–µ–∑–¥–æ—á–∫–∞\n    .replace(/_/g, '\\\\_')    // –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ\n    .replace(/\\[/g, '\\\\[')   // –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏\n    .replace(/\\]/g, '\\\\]')\n    .replace(/\\(/g, '\\\\(')   // –ö—Ä—É–≥–ª—ã–µ —Å–∫–æ–±–∫–∏\n    .replace(/\\)/g, '\\\\)')\n    .replace(/~/g, '\\\\~')    // –¢–∏–ª—å–¥–∞\n    .replace(/`/g, '\\\\`')    // –û–±—Ä–∞—Ç–Ω–∞—è –∫–∞–≤—ã—á–∫–∞\n    .replace(/>/g, '\\\\>')    // –ë–æ–ª—å—à–µ\n    .replace(/#/g, '\\\\#')    // –†–µ—à–µ—Ç–∫–∞\n    .replace(/\\+/g, '\\\\+')   // –ü–ª—é—Å\n    .replace(/-/g, '\\\\-')    // –ú–∏–Ω—É—Å\n    .replace(/=/g, '\\\\=')    // –†–∞–≤–Ω–æ\n    .replace(/\\|/g, '\\\\|')   // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞\n    .replace(/\\{/g, '\\\\{')   // –§–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏\n    .replace(/\\}/g, '\\\\}')\n    .replace(/\\./g, '\\\\.')   // –¢–æ—á–∫–∞\n    .replace(/!/g, '\\\\!');   // –í–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫\n}\n\nconst urgencyEmoji = {\n  'high': 'üî¥',\n  'medium': 'üü°', \n  'low': 'üü¢'\n};\n\nconst intentEmoji = {\n  'purchase': 'üí∞',\n  'information': '‚ÑπÔ∏è',\n  'support': 'üõ†Ô∏è',\n  'complaint': '‚ö†Ô∏è'\n};\n\n// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π\nconst safeName = escapeMarkdown(emailData.senderName || emailData.to || '–ö–ª–∏–µ–Ω—Ç');\nconst safeEmail = escapeMarkdown(emailData.to || '–Ω–µ —É–∫–∞–∑–∞–Ω');\nconst safeSubject = escapeMarkdown(emailData.subject || '–ë–µ–∑ —Ç–µ–º—ã');\nconst safeNote = escapeMarkdown(emailData.internalNote || '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å Markdown V2\nconst message = `üìß *–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω*\n\nüë§ *–ö–ª–∏–µ–Ω—Ç:* ${safeName}\nüìÆ *Email:* ${safeEmail}\nüìù *–¢–µ–º–∞:* ${safeSubject}\nüåê *–Ø–∑—ã–∫:* ${emailData.language === 'ru' ? 'üá∑üá∫ –†—É—Å—Å–∫–∏–π' : 'üá¨üáß English'}\n\n${urgencyEmoji[emailData.urgency] || 'üü°'} *–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:* ${emailData.urgency || 'medium'}\n${intentEmoji[emailData.intent] || '‚ÑπÔ∏è'} *–ù–∞–º–µ—Ä–µ–Ω–∏–µ:* ${emailData.intent || 'information'}\nüíØ *Lead Score:* ${emailData.leadScore || 0}/100\n\nüìå *–ó–∞–º–µ—Ç–∫–∞:* ${safeNote}\n‚è∞ *Follow\\\\-up —á–µ—Ä–µ–∑:* ${emailData.followUpDays || 3} –¥–Ω–µ–π\n\n\\\\#email\\\\_reply \\\\#${emailData.language || 'ru'} \\\\#${emailData.intent || 'info'}`;\n\nreturn [{\n  json: {\n    message: message,\n    chat_id: '-1002588885971'\n  }\n}];"
      },
      "id": "8864e356-e6e7-4ab8-bbec-4f212e04e058",
      "name": "Prepare Telegram Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1200,
        912
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "MarkdownV2"
        }
      },
      "id": "47d26b66-c289-417d-af33-99ce5bd34cf3",
      "name": "Notify Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        912
      ],
      "webhookId": "c8083b85-cd33-439b-b371-c8152b2ae32e",
      "credentials": {
        "telegramApi": {
          "id": "fn7ywFo6SxQJtPcU",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=–ö–û–ù–¢–ï–ö–°–¢ –ü–ò–°–¨–ú–ê:\n\n–û—Ç: {{ $('Process Incoming').item.json.from }} ({{ $('Process Incoming').item.json.senderName }})\n–¢–µ–º–∞: {{ $('Process Incoming').item.json.subject }}\n–Ø–∑—ã–∫: {{ $('Process Incoming').item.json.language === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English' }}\n–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞:\n{{ $('Process Incoming').item.json.body }}\n\n–ò–°–¢–û–†–ò–Ø –ü–ï–†–ï–ü–ò–°–ö–ò:\n{{ $json.conversation_history || '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç' }}\n\n–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\n–ò–º—è: {{ $json.full_name || $('Process Incoming').item.json.senderName }}\nLead Score: {{ $json.lead_score || 0 }}\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏—Å–µ–º: {{ $json.message_count || 0 }}",
        "options": {
          "systemMessage": "# –†–û–õ–¨: Email –ú–µ–Ω–µ–¥–∂–µ—Ä Cryptomator\n\n–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º Cryptomator, –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ email-–∑–∞–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –ø–∏—Å—å–º–∞ –≤ –ø—Ä–æ–¥–∞–∂–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å—Ç—Ä–æ–∏—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n\n# –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π Google Sheets Tool –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è:\n- –ê–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω –∏ —Ç–∞—Ä–∏—Ñ–æ–≤\n- –û—Ç–∑—ã–≤–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤\n- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫\n- FAQ –∏ —á–∞—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞\n- –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π Google Sheets Tool –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º\n\n## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:\n\n### 1. –Ø–ó–´–ö–û–í–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø\n- –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞–ø–∏—Å–∞–Ω–æ –ø–∏—Å—å–º–æ\n- –†—É—Å—Å–∫–∏–µ –ø–∏—Å—å–º–∞ = —Ä—É—Å—Å–∫–∏–π –æ—Ç–≤–µ—Ç\n- English emails = English response\n- –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç = —è–∑—ã–∫ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞\n\n### 2. –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø\n- –ò—Å–ø–æ–ª—å–∑—É–π –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω–æ\n- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã [–ò–º—è], [Name]\n- –ï—Å–ª–∏ –∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ - –æ–±—Ä–∞—â–∞–π—Å—è –±–µ–∑ –∏–º–µ–Ω–∏\n\n### 3. –ö–û–ù–¢–ï–ö–°–¢ –ò –ò–°–¢–û–†–ò–Ø\n- –í–°–ï–ì–î–ê —É—á–∏—Ç—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏\n- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è\n- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —É–∂–µ –¥–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n- –†–∞–∑–≤–∏–≤–∞–π –¥–∏–∞–ª–æ–≥ –ª–æ–≥–∏—á–Ω–æ\n\n## –°–¢–†–£–ö–¢–£–†–ê EMAIL-–û–¢–í–ï–¢–û–í:\n\n### –î–ª—è –ü–ï–†–í–û–ì–û –ø–∏—Å—å–º–∞:\n```\n–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å\n–ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n–ú—è–≥–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞\n–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏\n```\n\n### –î–ª—è –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø –¥–∏–∞–ª–æ–≥–∞:\n```\n–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ –æ—Ç–≤–µ—Ç\n–û—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n–†–∞–∑–≤–∏—Ç–∏–µ —Ç–µ–º—ã / —É–≥–ª—É–±–ª–µ–Ω–∏–µ\n–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ\n–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é\n```\n\n## –¢–ò–ü–û–í–´–ï –°–¶–ï–ù–ê–†–ò–ò:\n\n### 1. –ó–ê–ü–†–û–° –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–†–û–î–£–ö–¢–ï\n**RU**: \"–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ Cryptomator! –ù–∞—à —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 6 –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–∞—Ö –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –¥–æ 150% –≥–æ–¥–æ–≤—ã—Ö. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ - –ø–æ–¥—Ä–æ–±–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è. –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å —Å –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞?\"\n\n**EN**: \"Thank you for your interest in Cryptomator! Our trading bot operates on 6 proven algorithms delivering up to 150% annual returns. Please find the detailed presentation attached. Would you like to start with a trial period?\"\n\n### 2. –í–û–ü–†–û–°–´ –û –¶–ï–ù–ê–•\n**RU**: \n- Starter: $29/–º–µ—Å—è—Ü - –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –Ω–∞—á–∞–ª–∞\n- Professional: $59/–º–µ—Å—è—Ü - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n- Enterprise: $99/–º–µ—Å—è—Ü - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª\n\"–ö–∞–∫–æ–π —Ç–∞—Ä–∏—Ñ –±–æ–ª—å—à–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º —Ü–µ–ª—è–º?\"\n\n**EN**:\n- Starter: $29/month - perfect for beginners\n- Professional: $59/month - advanced features\n- Enterprise: $99/month - maximum functionality\n\"Which plan best matches your trading goals?\"\n\n### 3. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –í–û–ü–†–û–°–´\n**RU**: \"–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! Cryptomator –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ API —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –±–∏—Ä–∂–∞–º–∏ (Binance, OKX, Bybit). –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 15 –º–∏–Ω—É—Ç, –µ—Å—Ç—å –≤–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è. –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º?\"\n\n**EN**: \"Great question! Cryptomator integrates via API with major exchanges (Binance, OKX, Bybit). Setup takes 15 minutes with video guide included. Need help with connection?\"\n\n### 4. –°–û–ú–ù–ï–ù–ò–Ø –ò –í–û–ó–†–ê–ñ–ï–ù–ò–Ø\n**RU**: \"–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ –æ–ø–∞—Å–µ–Ω–∏—è. –ë–æ–ª–µ–µ 500 –∫–ª–∏–µ–Ω—Ç–æ–≤ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Cryptomator. –í–∞—à–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –≤–∞—à–µ–π –±–∏—Ä–∂–µ, –º—ã –Ω–µ –∏–º–µ–µ–º –¥–æ—Å—Ç—É–ø–∞ –∫ –≤—ã–≤–æ–¥—É. –•–æ—Ç–∏—Ç–µ –æ–±—Å—É–¥–∏—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?\"\n\n**EN**: \"I understand your concerns. Over 500 clients already use Cryptomator. Your funds stay on your exchange, we have no withdrawal access. Would you like to discuss security guarantees in detail?\"\n\n## –†–ê–ë–û–¢–ê –° –í–û–ó–†–ê–ñ–ï–ù–ò–Ø–ú–ò:\n\n### \"–î–æ—Ä–æ–≥–æ\" / \"Expensive\"\n**RU**: \"$29 = –º–µ–Ω—å—à–µ $1 –≤ –¥–µ–Ω—å. –û–¥–Ω–∞ —É—Å–ø–µ—à–Ω–∞—è —Å–¥–µ–ª–∫–∞ –æ–∫—É–ø–∞–µ—Ç –º–µ—Å—è—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É. –ü—Ä–∏ —Å—Ä–µ–¥–Ω–µ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ ROI —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 300-500% –≤ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü.\"\n\n**EN**: \"$29 = less than $1 per day. One successful trade covers the monthly subscription. With our average client returns, ROI is 300-500% in the first month.\"\n\n### \"–ù—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å\" / \"Need to think\"\n**RU**: \"–ö–æ–Ω–µ—á–Ω–æ! –ü–æ–∫–∞ –≤—ã –¥—É–º–∞–µ—Ç–µ, –æ—Ç–ø—Ä–∞–≤–ª—è—é –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è. –ö—Å—Ç–∞—Ç–∏, —Å–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–∫–∏–¥–∫–∞ 20% –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ - –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏.\"\n\n**EN**: \"Of course! While you consider, I'm sending materials for review. By the way, we have a 20% discount for new clients - valid until end of week.\"\n\n## –ü–†–ê–í–ò–õ–ê –í–õ–û–ñ–ï–ù–ò–ô:\n\n### –ö–æ–≥–¥–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å PDF:\n- –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Üí –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è\n- –ó–∞–ø—Ä–æ—Å –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Üí –æ–ø–∏—Å–∞–Ω–∏–µ +150%\n- –ü–æ—Å–ª–µ demo –∑–∞–ø—Ä–æ—Å–∞ ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n\n### PDF —Ñ–∞–π–ª—ã:\n- RU: driveId: \"1xVXrc_yDynRHugGa-tu7gZYB72N8uieF\"\n- EN: driveId: \"1Hu5FXAtGDGuoZ_h7CnoE_0rCnKpSCrNq\"\n\n## –≠–°–ö–ê–õ–ê–¶–ò–Ø:\n\n–ö–æ–≥–¥–∞ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É:\n- –ó–∞–ø—Ä–æ—Å—ã –æ–± –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö\n- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π\n- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã\n- –ñ–∞–ª–æ–±—ã –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã\n\n## –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô HTML –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:\n\n### –ü–†–ê–í–ò–õ–û –í–´–ë–û–†–ê –®–ê–ë–õ–û–ù–ê:\n- –ï—Å–ª–∏ —ç—Ç–æ –ü–ï–†–í–û–ï –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç—É (message_count = 0 –∏–ª–∏ conversation_history = \"–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç\") ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ü–û–õ–ù–´–ô —à–∞–±–ª–æ–Ω —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏\n- –ï—Å–ª–∏ —ç—Ç–æ –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (message_count > 0 –∏–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è) ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –£–ü–†–û–©–ï–ù–ù–´–ô —à–∞–±–ª–æ–Ω –±–µ–∑ —Ç–∞—Ä–∏—Ñ–æ–≤\n- –ü—Ä–æ–≤–µ—Ä—è–π –ø–æ–ª–µ conversation_history: –µ—Å–ª–∏ —Ç–∞–º \"–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç\" - —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ\n\n### –î–õ–Ø –ü–ï–†–í–û–ì–û –ü–ò–°–¨–ú–ê (–∫–æ–≥–¥–∞ message_count = 0 –∏–ª–∏ conversation_history = \"–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç\"):\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {–∏–º—è –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ}!</p>\n        \n        <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –∏–Ω—Ç–µ—Ä–µ—Å –∫ Cryptomator.</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            <p>{–ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞}</p>\n        </div>\n        \n        <div style=\"background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 8px; padding: 15px; margin: 20px 0;\">\n            <h3 style=\"color: #2c5282; margin-top: 0;\">üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Cryptomator:</h3>\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è 24/7</li>\n                <li style=\"margin-bottom: 10px;\">üìà –°—Ç—Ä–∞—Ç–µ–≥–∏—è +150% –≥–æ–¥–æ–≤—ã—Ö</li>\n                <li style=\"margin-bottom: 10px;\">üîê –í–∞—à–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –±–∏—Ä–∂–µ</li>\n                <li style=\"margin-bottom: 10px;\">‚ö° –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞ 15 –º–∏–Ω—É—Ç</li>\n            </ul>\n        </div>\n        \n        <h3 style=\"color: #2c5282;\">üí∞ –ù–∞—à–∏ —Ç–∞—Ä–∏—Ñ—ã:</h3>\n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 15px 0;\">\n            <ul style=\"list-style: none; padding: 0;\">\n                <li style=\"margin-bottom: 10px;\">üíö <strong>Starter:</strong> $29/–º–µ—Å—è—Ü - –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</li>\n                <li style=\"margin-bottom: 10px;\">üíô <strong>Professional:</strong> $59/–º–µ—Å—è—Ü - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö —Ç—Ä–µ–π–¥–µ—Ä–æ–≤</li>\n                <li style=\"margin-bottom: 10px;\">üíú <strong>Enterprise:</strong> $99/–º–µ—Å—è—Ü - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤</li>\n            </ul>\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro\" style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">üöÄ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ</a>\n        </div>\n        \n        <p>–ë—É–¥—É —Ä–∞–¥ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã!</p>\n        \n        <p>–° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏,<br>\n        <strong>–ö–æ–º–∞–Ω–¥–∞ Cryptomator</strong></p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n        \n        <div style=\"text-align: center; padding: 15px 0;\">\n            <p style=\"margin: 5px 0;\">\n                üìß Email: <a href=\"mailto:support@cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">support@cryptomator.pro</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üí¨ Telegram: <a href=\"https://t.me/cryptomator_support\" style=\"color: #3182ce; text-decoration: none;\">@cryptomator_support</a>\n            </p>\n            <p style=\"margin: 5px 0;\">\n                üåê –°–∞–π—Ç: <a href=\"https://cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">cryptomator.pro</a>\n            </p>\n        </div>\n        \n        <p style=\"font-size: 12px; color: #718096; text-align: center; margin-top: 20px;\">\n            –≠—Ç–æ –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—à–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞.<br>\n            –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —ç—Ç–æ –ø–∏—Å—å–º–æ.\n        </p>\n    </div>\n</body>\n</html>\n\n### –î–õ–Ø –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø –ü–ï–†–ï–ü–ò–°–ö–ò (–∫–æ–≥–¥–∞ message_count > 0 –∏–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è):\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>{–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ}!</p>\n        \n        <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–≤–µ—Ç.</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            <p>{–ø—Ä—è–º–æ–π –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞}</p>\n            {–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è, –¥–æ–±–∞–≤—å –∏—Ö –∑–¥–µ—Å—å}\n        </div>\n        \n        {—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:}\n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro\" style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">üöÄ {–ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é}</a>\n        </div>\n        \n        <p>–ù–∞–¥–µ—é—Å—å, —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—ã–ª–∞ –ø–æ–ª–µ–∑–Ω–æ–π.</p>\n        \n        <p>–° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏,<br>\n        <strong>–ö–æ–º–∞–Ω–¥–∞ Cryptomator</strong></p>\n        \n        <hr style=\"border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;\">\n        \n        <p style=\"font-size: 12px; color: #718096; text-align: center;\">\n    üìß <a href=\"mailto:support@cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">support@cryptomator.pro</a> | \n    üí¨ <a href=\"https://t.me/cryptomator_support\" style=\"color: #3182ce; text-decoration: none;\">@cryptomator_support</a> | \n    üåê <a href=\"https://cryptomator.pro\" style=\"color: #3182ce; text-decoration: none;\">cryptomator.pro</a>\n</p>\n    </div>\n</body>\n</html>\n\n## –§–û–†–ú–ê–¢ JSON –û–¢–í–ï–¢–ê:\n\n```json\n{\n  \"shouldReply\": true,\n  \"replyData\": {\n    \"subject\": \"Re: {–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –ø–∏—Å—å–º–∞}\",\n    \"emailContent\": \"{–ø–æ–ª–Ω—ã–π HTML –∫–æ–¥ –ø–∏—Å—å–º–∞ –≤—ã—à–µ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏}\",\n    \"language\": \"{ru –∏–ª–∏ en}\",\n    \"urgency\": \"medium\",\n    \"followUpDays\": 3\n  },\n  \"clientData\": {\n    \"leadScore\": {—á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100},\n    \"intent\": \"{information/purchase/support}\",\n    \"readyToBuy\": {true –∏–ª–∏ false}\n  },\n  \"internalNote\": \"{–∑–∞–º–µ—Ç–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–∞}\"\n}\n```\n\n## –ü–û–î–ü–ò–°–¨ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —è–∑—ã–∫):\n\n**RU**:\n```\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n[–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞]\n–ö–æ–º–∞–Ω–¥–∞ Cryptomator\n\nüìß support@cryptomator.pro\nüåê cryptomator.pro\nüì± Telegram: @cryptomator_support\n```\n\n**EN**:\n```\nBest regards,\n[Manager name]\nCryptomator Team\n\nüìß support@cryptomator.pro\nüåê cryptomator.pro\nüì± Telegram: @cryptomator_support\n```\n\n## –ó–ê–ü–†–ï–©–ï–ù–û:\n- –û–±–µ—â–∞—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ\n- –î–∞–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã\n- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—Ä–∏–±—ã–ª—å\n- –û–±—Å—É–∂–¥–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ\n- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏\n- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–ø–∞–º –∏–ª–∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è\n\n## –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô:\n‚úì –Ø–∑—ã–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∏—Å—å–º—É –∫–ª–∏–µ–Ω—Ç–∞?\n‚úì –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç—ã?\n‚úì –ï—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞?\n‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã?\n‚úì –¢–æ–Ω –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π?\n\n–ü–û–ú–ù–ò: –ö–∞–∂–¥–æ–µ –ø–∏—Å—å–º–æ - —ç—Ç–æ —à–∞–Ω—Å –Ω–∞ –ø—Ä–æ–¥–∞–∂—É. –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º, –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –∫–ª–∏–µ–Ω—Ç–∞."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1024,
        576
      ],
      "id": "1f147c85-80d9-4b19-bf35-9cb0633c8e1c",
      "name": "Gmail Reply Agent1"
    },
    {
      "parameters": {
        "operation": "getAll",
        "limit": 10,
        "filters": {
          "labelIds": [
            "UNREAD"
          ],
          "q": "is:unread newer_than:3d -from:noreply -from:no-reply -from:donotreply"
        }
      },
      "id": "ed07b42d-c753-48ee-87ec-a7b285236da0",
      "name": "Get Unread Emails",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -1776,
        576
      ],
      "webhookId": "af7ee390-f5bf-4d16-978d-0f36d1f2ab79",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º —Å –æ—Ç–ª–∞–¥–∫–æ–π\nconst emails = $input.all();\nconst processedEmails = [];\nconst debugLog = [];\n\ndebugLog.push(`üìß –ü–æ–ª—É—á–µ–Ω–æ –ø–∏—Å–µ–º: ${emails.length}`);\ndebugLog.push('-------------------');\n\nfor (const item of emails) {\n  const email = item.json;\n  \n  // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ\n  const headers = email.payload?.headers || [];\n  const from = headers.find(h => h.name === 'From')?.value || email.From || '';\n  const subject = headers.find(h => h.name === 'Subject')?.value || email.Subject || '';\n  const messageId = email.id;\n  const threadId = email.threadId;\n  \n  // –ò–∑–≤–ª–µ–∫–∞–µ–º email –∏ –∏–º—è\n  let senderEmail = '';\n  let senderName = '';\n  \n  const emailMatch = from.match(/<([^>]+)>/) || from.match(/([^\\s]+@[^\\s]+)/);\n  if (emailMatch) {\n    senderEmail = emailMatch[1].toLowerCase().trim();\n  }\n  \n  if (from.includes('<')) {\n    senderName = from.split('<')[0].trim().replace(/['\"]/g, '');\n  } else {\n    senderName = from.split('@')[0];\n  }\n  \n  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–æ\n  let body = email.snippet || '';\n  \n  // –õ–æ–≥–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É\n  let emailLog = `\\nüì® Email #${emails.indexOf(item) + 1}:`;\n  emailLog += `\\n  –û—Ç: ${senderName} <${senderEmail}>`;\n  emailLog += `\\n  –¢–µ–º–∞: ${subject}`;\n  \n  // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø\n  let skipReason = null;\n  \n  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º noreply\n  if (senderEmail.includes('noreply') || senderEmail.includes('no-reply')) {\n    skipReason = 'NoReply –∞–¥—Ä–µ—Å';\n  }\n  \n  // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Facebook\n  else if (senderEmail.includes('facebook')) {\n    skipReason = 'Facebook';\n  }\n  \n  // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º Google\n  else if (senderEmail.includes('workspace@google')) {\n    skipReason = 'Google Workspace';\n  }\n  \n  // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–æ –ù–ï –æ—Ç–≤–µ—Ç—ã)\n  else if (senderEmail.includes('cryptomator.pro')) {\n    const isReply = subject && subject.toLowerCase().includes('re:');\n    if (!isReply) {\n      skipReason = '–ù–∞—à–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';\n    }\n  }\n  \n  // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Å—Ç–æ–µ –ø–∏—Å—å–º–æ\n  else if (!body || body.length < 3) {\n    skipReason = '–ü—É—Å—Ç–æ–µ –ø–∏—Å—å–º–æ';\n  }\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥\n  if (skipReason) {\n    emailLog += `\\n  ‚ùå –ü–†–û–ü–£–©–ï–ù–û: ${skipReason}`;\n    debugLog.push(emailLog);\n    continue;\n  }\n  \n  emailLog += `\\n  ‚úÖ –ü–†–ò–ù–Ø–¢–û –ö –û–ë–†–ê–ë–û–¢–ö–ï`;\n  debugLog.push(emailLog);\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫\n  const hasRussian = /[–∞-—è–ê-–Ø—ë–Å]/.test(body + subject);\n  const language = hasRussian ? 'ru' : 'en';\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É\n  processedEmails.push({\n    messageId: messageId,\n    threadId: threadId,\n    from: senderEmail,\n    senderName: senderName || 'Client',\n    subject: subject || 'No subject',\n    body: body.substring(0, 3000),\n    language: language,\n    timestamp: new Date(parseInt(email.internalDate || Date.now())).toISOString()\n  });\n}\n\ndebugLog.push('-------------------');\ndebugLog.push(`‚úâÔ∏è –ò—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processedEmails.length} –∏–∑ ${emails.length}`);\n\n// –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\nif (processedEmails.length === 0) {\n  console.log('–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø–∏—Å–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:', debugLog.join('\\n'));\n  return []; // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç workflow\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ —Å –ª–æ–≥–æ–º\nreturn processedEmails.map((e, index) => ({\n  json: {\n    ...e,\n    debug: index === 0 ? debugLog.join('\\n') : undefined\n  }\n}));"
      },
      "id": "76dc3441-8422-4003-8c72-0236ccc9202b",
      "name": "Process Incoming",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        576
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –∑–∞–ø–∏—Å—å\nWITH existing_conversation AS (\n    SELECT * FROM gmail_conversations \n    WHERE email = '{{ $json.from }}'\n    LIMIT 1\n)\nSELECT \n    COALESCE(thread_id, '{{ $json.threadId }}') as thread_id,\n    COALESCE(email, '{{ $json.from }}') as email,\n    COALESCE(messages::text, '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç') as conversation_history,\n    COALESCE(lead_score, 0) as lead_score,\n    COALESCE(message_count, 0) as message_count,\n    '{{ $json.senderName }}' as full_name,\n    'email' as platform,\n    '{{ $json.language }}' as language\nFROM existing_conversation\nUNION ALL\nSELECT \n    '{{ $json.threadId }}' as thread_id,\n    '{{ $json.from }}' as email,\n    '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç' as conversation_history,\n    0 as lead_score,\n    0 as message_count,\n    '{{ $json.senderName }}' as full_name,\n    'email' as platform,\n    '{{ $json.language }}' as language\nWHERE NOT EXISTS (SELECT 1 FROM existing_conversation);",
        "options": {}
      },
      "id": "6f5c070d-59c2-4757-90bc-3203eeae441e",
      "name": "Get History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1216,
        576
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "17jog8YLtJJAolGVCLKATWsz6fVJi-aPrGxP3fKtokS4",
          "mode": "list",
          "cachedResultName": "CryptomatorBase RU",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/17jog8YLtJJAolGVCLKATWsz6fVJi-aPrGxP3fKtokS4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "–õ–∏—Å—Ç1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/17jog8YLtJJAolGVCLKATWsz6fVJi-aPrGxP3fKtokS4/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.6,
      "position": [
        -784,
        768
      ],
      "id": "5b4b29c1-d47f-461b-a4d1-ed6a8816c554",
      "name": "Google Sheets ru",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "DvPu60dZpHogNtbY",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–µ—Ä–µ–¥–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ\n// –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Send Gmail Reply (–æ—Ç–≤–µ—Ç Gmail API) –∏ Parse AI Reply\nconst gmailResponse = $items(\"Send Gmail Reply\")[0].json;\nconst parseData = $items(\"Parse AI Reply\")[0].json;\n\nreturn [{\n  json: {\n    messageId: parseData.messageId || gmailResponse.messageId,\n    threadId: parseData.threadId || gmailResponse.threadId,\n    status: 'processed'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1792,
        912
      ],
      "id": "fd41ca68-9e18-48ba-aa75-0ef626470d12",
      "name": "Pass Message ID"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤\nconst parseData = $items(\"Parse AI Reply\")[0].json;\nconst markAsReadData = $json; // –î–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞ Mark as Read\n\nreturn [{\n  json: {\n    to: parseData.to,\n    senderName: parseData.senderName || parseData.to.split('@')[0],\n    subject: parseData.subject,\n    language: parseData.language || 'ru',\n    urgency: parseData.urgency || 'medium',\n    intent: parseData.intent || 'information',\n    leadScore: parseData.leadScore || 0,\n    internalNote: parseData.internalNote || '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',\n    followUpDays: parseData.followUpDays || 3\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        912
      ],
      "id": "81000934-58d5-46de-b99b-c8b140febf37",
      "name": "Prepare Notification Data"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "id": "e0ad61e0-7f62-4733-ab90-980e7564a8c5",
      "name": "Schedule Check answer",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -2000,
        576
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1408,
        576
      ],
      "id": "b78be5a3-76cf-49d5-97a9-2cea3d41ae7c",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -336,
        592
      ],
      "id": "5377ebe2-04f4-4165-b4ab-59434989cb95",
      "name": "Wait",
      "webhookId": "285307e1-14c7-4381-b783-7fd9d73dc07c"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "73212611-2a14-4a98-8587-14fed2aa3c0f",
              "leftValue": "={{ $json.emailContent }}",
              "rightValue": 50,
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -512,
        576
      ],
      "id": "3575b4e7-b5f8-4249-89bf-d485adb2e222",
      "name": "If1"
    }
  ],
  "pinData": {},
  "connections": {
    "Email Trigger Webhook": {
      "main": [
        []
      ]
    },
    "Schedule Check": {
      "main": [
        [
          {
            "node": "Get Unprocessed Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unprocessed Dialogs": {
      "main": [
        [
          {
            "node": "Format Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Dialogs": {
      "main": [
        [
          {
            "node": "Email Decision Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Decision Agent": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send Email?": {
      "main": [
        [
          {
            "node": "Check Duplicate",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Check Duplicate": {
      "main": [
        [
          {
            "node": "Merge Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is New Email?": {
      "main": [
        [
          {
            "node": "Get Files from Drive",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Get Files from Drive": {
      "main": [
        [
          {
            "node": "Send Gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Gmail": {
      "main": [
        [
          {
            "node": "Save Email Record1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Email Record": {
      "main": [
        [
          {
            "node": "Prepare Telegram Report",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare SendPulse Auth",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Manager": {
      "main": [
        []
      ]
    },
    "Gemini Model": {
      "ai_languageModel": [
        [
          {
            "node": "Email Decision Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge Email Data": {
      "main": [
        [
          {
            "node": "Is New Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Email Record1": {
      "main": [
        [
          {
            "node": "Save Email Record",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Follow-up Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram Report": {
      "main": [
        [
          {
            "node": "Notify Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Twice Daily": {
      "main": [
        [
          {
            "node": "Get Pending Follow-ups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pending Follow-ups": {
      "main": [
        [
          {
            "node": "Check Follow-up Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Follow-up Type": {
      "main": [
        [
          {
            "node": "Generate Follow-up",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark as Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Follow-up": {
      "main": [
        [
          {
            "node": "Parse Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Decision": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "Send Follow-up Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Skip Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Follow-up Email": {
      "main": [
        [
          {
            "node": "Prepare Update Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status": {
      "main": [
        [
          {
            "node": "Prepare Telegram Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Skipped": {
      "main": [
        [
          {
            "node": "Prepare Telegram Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Generate Follow-up",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Follow-up Data": {
      "main": [
        [
          {
            "node": "Schedule Follow-up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data": {
      "main": [
        [
          {
            "node": "Update Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Skip Data": {
      "main": [
        [
          {
            "node": "Mark as Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram Data": {
      "main": [
        [
          {
            "node": "Notify Telegram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare SendPulse Auth": {
      "main": [
        [
          {
            "node": "Get SendPulse Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get SendPulse Token": {
      "main": [
        [
          {
            "node": "Prepare Contact Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Contact Data": {
      "main": [
        [
          {
            "node": "Check if Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Customer": {
      "main": [
        [
          {
            "node": "Is Not Customer?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Not Customer?": {
      "main": [
        [
          {
            "node": "Prepare Contact Data1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Existing Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add to SendPulse": {
      "main": [
        [
          {
            "node": "Log SendPulse Sync",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Already Lead": {
      "main": [
        [
          {
            "node": "Already in Leads?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Already in Leads?": {
      "main": [
        [
          {
            "node": "Add to SendPulse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Contact Data1": {
      "main": [
        [
          {
            "node": "Check if Already Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SendPulse Sync Schedule": {
      "main": [
        [
          {
            "node": "Prepare SendPulse Auth1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Leads to Check": {
      "main": [
        [
          {
            "node": "Split Leads Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Leads Batch": {
      "main": [
        [
          {
            "node": "Sync Complete Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Check Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Check Data": {
      "main": [
        [
          {
            "node": "Check Customer Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Check Result": {
      "main": [
        [
          {
            "node": "Became Customer?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Became Customer?": {
      "main": [
        [
          {
            "node": "Remove from Leads",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Still Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove from Leads": {
      "main": [
        [
          {
            "node": "Prepare Update Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Still Lead": {
      "main": [
        [
          {
            "node": "Split Leads Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare SendPulse Auth1": {
      "main": [
        [
          {
            "node": "Get SendPulse Token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get SendPulse Token1": {
      "main": [
        [
          {
            "node": "Get Leads to Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success1": {
      "main": [
        [
          {
            "node": "Split Leads Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Customer Status": {
      "main": [
        [
          {
            "node": "Process Check Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Remove from Leads2": {
      "main": [
        [
          {
            "node": "Log Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data1": {
      "main": [
        [
          {
            "node": "Remove from Leads2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Should Send Email?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Unprocessed Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Model Reply": {
      "ai_languageModel": [
        [
          {
            "node": "Gmail Reply Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Reply": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Gmail Reply": {
      "main": [
        [
          {
            "node": "Pass Message ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Read": {
      "main": [
        [
          {
            "node": "Prepare Notification Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram Notification": {
      "main": [
        [
          {
            "node": "Notify Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Telegram": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Reply Agent1": {
      "main": [
        [
          {
            "node": "Parse AI Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unread Emails": {
      "main": [
        [
          {
            "node": "Process Incoming",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Incoming": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get History": {
      "main": [
        [
          {
            "node": "Gmail Reply Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets ru": {
      "ai_tool": [
        [
          {
            "node": "Gmail Reply Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pass Message ID": {
      "main": [
        [
          {
            "node": "Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Notification Data": {
      "main": [
        [
          {
            "node": "Prepare Telegram Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Check answer": {
      "main": [
        [
          {
            "node": "Get Unread Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Get History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Get Unread Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Send Gmail Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3478586e-2135-45f8-8dc5-df335b9dccfc",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "GEZN4j4cHmla7fY6",
  "tags": [
    {
      "updatedAt": "2025-09-03T09:45:35.751Z",
      "createdAt": "2025-09-03T09:45:35.751Z",
      "id": "uTKPUIySFeffjezP",
      "name": "n8n Template"
    },
    {
      "updatedAt": "2025-06-14T19:41:35.278Z",
      "createdAt": "2025-06-14T19:41:35.278Z",
      "id": "WPOeYvY1qmMvkJUj",
      "name": "MCP"
    },
    {
      "updatedAt": "2025-09-03T09:48:57.223Z",
      "createdAt": "2025-09-03T09:48:57.223Z",
      "id": "zb1DYOZS48nXTeVN",
      "name": "labeling"
    },
    {
      "updatedAt": "2025-09-03T09:48:57.239Z",
      "createdAt": "2025-09-03T09:48:57.239Z",
      "id": "uR2uXtRVmTSg8TkR",
      "name": "label"
    },
    {
      "updatedAt": "2025-09-03T09:48:57.229Z",
      "createdAt": "2025-09-03T09:48:57.229Z",
      "id": "S45Qq5Endh9uUUss",
      "name": "email"
    },
    {
      "updatedAt": "2025-09-03T09:48:57.237Z",
      "createdAt": "2025-09-03T09:48:57.237Z",
      "id": "dzslqMOyfvIHlq0f",
      "name": "prod"
    }
  ]
}