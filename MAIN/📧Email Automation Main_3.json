{
  "name": "üìßEmail Automation Main_3",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "29601cb8-73b4-4d29-b334-bdbf8563adc4",
      "name": "Check Twice Daily",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -19152,
        -3376
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–ª—É—á–∞–µ–º follow-ups –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è\nWITH pending_followups AS (\n    SELECT \n        f.*,\n        gc.messages,\n        gc.lead_score,\n        gc.language,\n        gc.subject,\n        gc.message_count,\n        -- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞\n        CASE \n            WHEN gc.message_count IS NULL OR gc.message_count = 0 THEN 'no_response'\n            WHEN gc.lead_score >= 70 THEN 'high_interest'\n            WHEN gc.message_count >= 2 THEN 'active_discussion'  -- –ò–∑–º–µ–Ω–µ–Ω–æ —Å 3 –Ω–∞ 2\n            WHEN gc.lead_score >= 50 THEN 'standard'\n            ELSE 'low_interest'\n        END as followup_type\n    FROM email_follow_ups f\n    LEFT JOIN gmail_conversations gc ON f.thread_id = gc.thread_id\n    WHERE f.status = 'pending'\n      AND f.follow_up_date <= NOW()\n      AND f.follow_up_date > NOW() - INTERVAL '24 hours'\n)\nSELECT * FROM pending_followups\nORDER BY follow_up_date ASC\nLIMIT 20;",
        "options": {}
      },
      "id": "e105af0c-f22d-41b0-bb17-5a84c7d985d6",
      "name": "Get Pending Follow-ups",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -18976,
        -3376
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.lead_score }}",
              "rightValue": 50,
              "operator": {
                "type": "number",
                "operation": "gte"
              },
              "id": "9199afa8-e9b6-41a9-9867-ec632dbd6765"
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "7ff995f1-4dd1-47a4-9132-f3ae667afac6",
      "name": "Check Follow-up Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -18784,
        -3376
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Email: {{ $json.email }}\n–Ø–∑—ã–∫: {{ $json.language }}\nLead Score: {{ $json.lead_score }}\n–¢–∏–ø follow-up: {{ $json.followup_type }}\n–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–µ–º–∞: {{ $json.subject }}\n–ò—Å—Ç–æ—Ä–∏—è: {{ $json.messages }}",
        "options": {
          "systemMessage": "–¢—ã - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º Cryptomator. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ follow-up –ø–∏—Å—å–º–æ.\n\n# –¢–ò–ü–´ FOLLOW-UP:\n\n## no_response (–∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ)\n–ù–µ –ø–∏—à–∏! –í–æ–∑–≤—Ä–∞—â–∞–π shouldSend: false. –û–¥–Ω–æ–≥–æ –ø–∏—Å—å–º–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.\n\n## high_interest (lead_score >= 70)\n–û—Ç–ø—Ä–∞–≤—å –ø–∏—Å—å–º–æ —Å:\n- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º\n- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–∫–∏–¥–∫–æ–π 15%\n- –°—Å—ã–ª–∫–æ–π –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –∑–≤–æ–Ω–∫–∞\n\n## active_discussion (–∞–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞)\n–û—Ç–ø—Ä–∞–≤—å –ø–∏—Å—å–º–æ —Å:\n- –û—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–º–Ω–µ–Ω–∏—è\n- –ö–µ–π—Å–∞–º–∏ —É—Å–ø–µ—à–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º\n\n## standard\n–û—Ü–µ–Ω–∏–≤–∞–π –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π.\n\n# –ü–†–ê–í–ò–õ–ê:\n1. –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–π follow-up –µ—Å–ª–∏:\n   - –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ (no_response)\n   - Lead score < 30\n   - –ü—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 7 –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞\n   \n2. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–ø—Ä–∞–≤–ª—è–π –µ—Å–ª–∏:\n   - Lead score >= 70\n   - –ë—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ (3+ —Å–æ–æ–±—â–µ–Ω–∏—è)\n\n# –®–ê–ë–õ–û–ù –ü–ò–°–¨–ú–ê:\n\n```html\n<!DOCTYPE html>\n<html>\n<body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <p>{–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ}</p>\n        \n        <p>{–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ}</p>\n        \n        <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;\">\n            {–æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–º–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ}\n        </div>\n        \n        <div style=\"background: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0;\">\n            <strong>üíé –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</strong><br>\n            {—Å–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –¥–µ–¥–ª–∞–π–Ω–æ–º}\n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://cryptomator.pro/?utm_source=email&utm_campaign=followup&lang={—è–∑—ã–∫}#prices\" \n               style=\"background-color: #3182ce; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block;\">\n                {–ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é}\n            </a>\n        </div>\n        \n        <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>\n        <strong>–ö–æ–º–∞–Ω–¥–∞ Cryptomator</strong></p>\n    </div>\n</body>\n</html>\n```\n\n# JSON –û–¢–í–ï–¢ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞ —è–∑—ã–∫–µ –∏–∑ –ø–æ–ª—è language):\n```json\n{\n  \"shouldSend\": true/false,\n  \"reason\": \"–ï—Å–ª–∏ language='ru' - –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ language='en' - reason in English\",\n  \"emailContent\": \"HTML –ø–∏—Å—å–º–∞ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ (ru/en)\",\n  \"subject\": \"–ï—Å–ª–∏ language='ru' - —Ç–µ–º–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ï—Å–ª–∏ language='en' - subject in English\",\n  \"discount\": \"—Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å / discount amount if any\",\n  \"urgency\": \"high/medium/low\"\n}\n```\n\n–í–ê–ñ–ù–û:\n\n–ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–æ language='ru' - –í–°–ï –ø–æ–ª—è (reason, emailContent, subject) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ\n–ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–æ language='en' - –í–°–ï –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –ê–ù–ì–õ–ò–ô–°–ö–û–ú —è–∑—ã–∫–µ\n–ü–æ–ª–µ reason –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞\n\n–ü—Ä–∏–º–µ—Ä—ã:\n–î–ª—è language='ru':\n{\n  \"shouldSend\": true,\n  \"reason\": \"Lead score 70, –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å. –ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–≤–∞–ª –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–∞—Ä–∏—Ñ–∞—Ö, –æ—Ç–ø—Ä–∞–≤–ª—è—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ —Å–∫–∏–¥–∫–æ–π 15%\",\n  \"emailContent\": \"<html>...</html>\",\n  \"subject\": \"–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞—Å - —Å–∫–∏–¥–∫–∞ 15%\",\n  \"discount\": \"15%\",\n  \"urgency\": \"high\"\n}\n\n–î–ª—è language='en':\n\n{\n  \"shouldSend\": true,\n  \"reason\": \"Lead score 70, high interest type. Client has shown significant interest after presentation. Sending personalized offer with discount\",\n  \"emailContent\": \"<html>...</html>\",\n  \"subject\": \"Special offer for you - 15% discount\",\n  \"discount\": \"15%\",\n  \"urgency\": \"high\"\n}"
        }
      },
      "id": "3548af8a-f370-4c1a-a4fa-a892c1fe8f83",
      "name": "Generate Follow-up",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -18512,
        -3600
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç AI\nconst aiResponse = $input.first().json;\nconst originalData = $items(\"Check Follow-up Type\")[0].json;\n\nlet decision;\ntry {\n    if (typeof aiResponse.output === 'string') {\n        const cleanJson = aiResponse.output\n            .replace(/```json\\n?/g, '')\n            .replace(/```\\n?/g, '')\n            .trim();\n        decision = JSON.parse(cleanJson);\n    } else {\n        decision = aiResponse.output;\n    }\n} catch (error) {\n    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º\n    decision = {\n        shouldSend: false,\n        reason: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞'\n    };\n}\n\n// –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\nreturn [{\n    json: {\n        ...originalData,\n        ...decision,\n        followup_id: originalData.id\n    }\n}];"
      },
      "id": "3d774d20-0fc5-4b12-a7d6-d6a8f825bf46",
      "name": "Parse Decision",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -18176,
        -3584
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.shouldSend }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              },
              "id": "81343c75-40af-4fbe-8071-b3b55779e19b"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c397ba2d-77d4-42e1-8440-9e8e61d30c41",
      "name": "Should Send?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -17952,
        -3520
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.emailContent }}",
        "options": {
          "appendAttribution": false,
          "senderName": "Cryptomator Team",
          "replyTo": "support@cryptomator.pro"
        }
      },
      "id": "c83a000d-b03a-4bc9-9a8c-ef2c4d17200f",
      "name": "Send Follow-up Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -17744,
        -3536
      ],
      "webhookId": "e2bf2b84-361a-4aa3-be4a-995f48c02372",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å follow-up\nUPDATE email_follow_ups\nSET \n    status = 'sent',\n    sent_at = NOW(),\n    notes = CONCAT(notes, ' | Sent: ', NOW()::text)\nWHERE id = {{ $json.followup_id }};\n\n-- –û–±–Ω–æ–≤–ª—è–µ–º gmail_conversations\nUPDATE gmail_conversations\nSET \n    message_count = message_count + 1\nWHERE thread_id = '{{ $json.thread_id }}';\n\nSELECT 'Follow-up sent' as status;",
        "options": {}
      },
      "id": "5ccdfb27-646b-4bb4-a94c-a5c3995c190c",
      "name": "Update Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -17360,
        -3536
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π\nUPDATE email_follow_ups\nSET \n    status = 'skipped',\n    notes = CONCAT(notes, ' | Skipped: ', '{{ $json.reason.replace(/'/g, \"''\") }}')\nWHERE id = {{ $json.followup_id }};\n\nSELECT 'Skipped' as status;",
        "options": {}
      },
      "id": "0a5c6f86-eede-4416-8810-835cfdb1412a",
      "name": "Mark as Skipped",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -17440,
        -3280
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "e9d3e9a6-99ba-49ef-80a3-06b55fe81d4f",
      "name": "Gemini Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -18560,
        -3440
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "-1002588885971",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "id": "e2392f6b-9122-4801-813f-73b695ddcb67",
      "name": "Notify Telegram1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -16880,
        -3360
      ],
      "webhookId": "984ce731-decd-4600-a4e1-6841c6db60c9",
      "credentials": {
        "telegramApi": {
          "id": "bHlhE9zUMfwWqM9t",
          "name": "Manager Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É–∑–ª–æ–≤\nconst parseDecision = $items(\"Parse Decision\")[0].json;\nconst pendingData = $items(\"Get Pending Follow-ups\")[0].json;\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Update Status\nreturn [{\n  json: {\n    followup_id: pendingData.id,\n    email: pendingData.email,\n    thread_id: pendingData.thread_id,\n    lead_score: pendingData.lead_score,\n    emailContent: parseDecision.emailContent ? \n                  parseDecision.emailContent.substring(0, 500) : \n                  'Follow-up sent'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -17536,
        -3536
      ],
      "id": "dc1f568d-d9e0-4186-864a-47fd71467a17",
      "name": "Prepare Update Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö follow-ups\nconst parseDecision = $items(\"Parse Decision\")[0].json;\nconst pendingData = $items(\"Get Pending Follow-ups\")[0].json;\n\n// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Mark as Skipped\nreturn [{\n  json: {\n    followup_id: pendingData.id,\n    reason: parseDecision.reason || '–ù–∏–∑–∫–∏–π lead score –∏–ª–∏ no_response'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -17792,
        -3392
      ],
      "id": "1c866ea1-e565-40ff-b389-eda677a4bd8f",
      "name": "Prepare Skip Data"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞\nconst sqlResult = $input.first().json;\nconst pendingData = $items(\"Get Pending Follow-ups\")[0]?.json || {};\nconst parseDecision = $items(\"Parse Decision\")[0]?.json || {};\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å\nlet status = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';\nif (sqlResult?.status === 'Follow-up sent') {\n  status = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';\n} else if (sqlResult?.status === 'Skipped') {\n  status = '–ü—Ä–æ–ø—É—â–µ–Ω–æ';\n}\n\n// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ\nconst email = pendingData.email || '–ù–µ —É–∫–∞–∑–∞–Ω';\nconst leadScore = pendingData.lead_score || 0;\n\n// –û—á–∏—â–∞–µ–º reason –æ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è Telegram\nlet reason = parseDecision.reason || '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞';\n// –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã\nreason = reason\n  .replace(/'/g, '')\n  .replace(/\"/g, '')\n  .replace(/`/g, '')\n  .replace(/\\n/g, ' ')\n  .substring(0, 200); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤\nconst icon = status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' ? '‚úÖ' : '‚è≠Ô∏è';\nconst message = `üìä Follow-up Report\n\n${icon} –°—Ç–∞—Ç—É—Å: ${status}\nüìß Email: ${email}\nüíØ Lead Score: ${leadScore}\nüìù –ü—Ä–∏—á–∏–Ω–∞: ${reason}`;\n\nreturn [{\n  json: {\n    message: message\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -17056,
        -3360
      ],
      "id": "a1649f81-b901-44a2-9e5f-c157fbd04f49",
      "name": "Prepare Telegram Data"
    }
  ],
  "pinData": {},
  "connections": {
    "Check Twice Daily": {
      "main": [
        [
          {
            "node": "Get Pending Follow-ups",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pending Follow-ups": {
      "main": [
        [
          {
            "node": "Check Follow-up Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Follow-up Type": {
      "main": [
        [
          {
            "node": "Generate Follow-up",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark as Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Follow-up": {
      "main": [
        [
          {
            "node": "Parse Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Decision": {
      "main": [
        [
          {
            "node": "Should Send?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Send?": {
      "main": [
        [
          {
            "node": "Send Follow-up Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Skip Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Follow-up Email": {
      "main": [
        [
          {
            "node": "Prepare Update Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status": {
      "main": [
        [
          {
            "node": "Prepare Telegram Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Skipped": {
      "main": [
        [
          {
            "node": "Prepare Telegram Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Generate Follow-up",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data": {
      "main": [
        [
          {
            "node": "Update Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Skip Data": {
      "main": [
        [
          {
            "node": "Mark as Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Telegram Data": {
      "main": [
        [
          {
            "node": "Notify Telegram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ffc4d05f-5e64-4a3b-bb95-b8b061a43835",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "kwbiltkxVdA5HWbR",
  "tags": []
}