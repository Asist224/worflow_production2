{
  "name": "üìß Email System Coordinator [Production]",
  "nodes": [
    {
      "parameters": {
        "content": "# ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê WORKFLOW\n\n---\n\n## –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:\n\n### 1. –û—Ç–∫—Ä–æ–π—Ç–µ —É–∑–µ–ª ¬´‚öôÔ∏è CONFIG¬ª\n–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:\n\n| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |\n|----------|----------|\n| `company_domain` | –î–æ–º–µ–Ω –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ |\n| `company_name` | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ |\n| `company_email` | Email –ø–æ–¥–¥–µ—Ä–∂–∫–∏ |\n| `api_key` | –í–∞—à API –∫–ª—é—á |\n| `webhook_base_url` | URL –≤–∞—à–µ–≥–æ n8n |\n| `table_*` | –ù–∞–∑–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –ë–î |\n\n---\n\n### 2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Credentials\n\n**Gmail OAuth2** ‚Üí —É–∑–µ–ª ¬´Get Recent Emails¬ª\n\n**PostgreSQL** ‚Üí –≤—Å–µ SQL —É–∑–ª—ã:\n‚Ä¢ Check Processed Emails\n‚Ä¢ Log Email Processing\n‚Ä¢ Save Conversation\n‚Ä¢ Save to Email Monitoring\n‚Ä¢ Update Metrics After Analysis\n\n---\n\n### 3. Sub-workflows\n\n–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:\n‚Ä¢ `/webhook/extract-email-contact`\n‚Ä¢ `/webhook/analyze-email-dialog`\n\n---\n\n### 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è\n\n–ù–∞–∂–º–∏—Ç–µ **Active** –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.\nWorkflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç.",
        "height": 1244,
        "width": 480,
        "color": 6
      },
      "id": "966a9474-7f47-417f-aa55-60131d164119",
      "name": "üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -528,
        -256
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"company_domain\": \"your-company.com\",\n  \"company_name\": \"Your Company\",\n  \"company_email\": \"support@your-company.com\",\n  \"api_key\": \"YOUR-API-KEY-CHANGE-ME\",\n  \"webhook_base_url\": \"https://your-n8n.com\",\n  \n  \"table_processing_log\": \"email_processing_log\",\n  \"table_conversations\": \"gmail_conversations\",\n  \"table_monitoring\": \"email_monitoring\",\n  \"table_analysis\": \"email_dialog_analysis\"\n}",
        "options": {}
      },
      "id": "e773bbc5-a17b-486c-85ff-e93bfe7b817b",
      "name": "‚öôÔ∏è CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        144,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "simple": false,
        "filters": {
          "q": "=newer_than:5d -from:noreply -from:no-reply -from:donotreply -from:notification"
        },
        "options": {}
      },
      "id": "51eef9f8-a34f-4cb6-a378-adc3530066fa",
      "name": "üì•Get Recent Emails",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        304,
        -48
      ],
      "webhookId": "92e92da3-2b91-46e4-b567-e8a64ffded96",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìß EXTRACT EMAIL DATA\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ —É–∑–ª–∞ CONFIG –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é\nconst config = $('‚öôÔ∏è CONFIG').item.json;\nconst COMPANY_DOMAIN = config.company_domain;\n\n// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ email –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏\nconst emails = $input.all();\nconst processedEmails = [];\nconst logs = [];\n\nlogs.push(`–ü–æ–ª—É—á–µ–Ω–æ ${emails.length} –ø–∏—Å–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏`);\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ email\nfunction cleanEmailText(text) {\n  if (!text) return '';\n  \n  // –°–ù–ê–ß–ê–õ–ê —É–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞—Ç–∞–º–∏ –∏ –∏–º–µ–Ω–∞–º–∏\n  text = text.replace(/^.*\\d{1,2}\\s+(—è–Ω–≤|—Ñ–µ–≤|–º–∞—Ä|–∞–ø—Ä|–º–∞—è|–∏—é–Ω|–∏—é–ª|–∞–≤–≥|—Å–µ–Ω|–æ–∫—Ç|–Ω–æ—è|–¥–µ–∫)\\w*\\.?\\s+\\d{4}\\s+–≥\\.\\s+–≤\\s+\\d{1,2}:\\d{2}.*$/gmi, '');\n  text = text.replace(/^.*\\d{1,2}\\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\w*\\s+\\d{4}\\s+at\\s+\\d{1,2}:\\d{2}.*$/gmi, '');\n  \n  // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥–Ω—è–º–∏ –Ω–µ–¥–µ–ª–∏\n  text = text.replace(/^.*(–ü–Ω|–í—Ç|–°—Ä|–ß—Ç|–ü—Ç|–°–±|–í—Å|–ø–Ω|–≤—Ç|—Å—Ä|—á—Ç|–ø—Ç|—Å–±|–≤—Å|Mon|Tue|Wed|Thu|Fri|Sat|Sun),\\s+\\d{1,2}\\s+.*$/gmi, '');\n  \n  // –£–¥–∞–ª—è–µ–º —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Gmail\n  text = text.replace(/^>+.*$/gm, '');\n  \n  // –£–¥–∞–ª—è–µ–º email –∞–¥—Ä–µ—Å–∞ –∏ –∏–º–µ–Ω–∞ —Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º\n  text = text.replace(/^.*[A-Za-z\\s]+\\s*<[^>]+@[^>]+>.*:$/gm, '');\n  text = text.replace(/^.*Cryptomator Team.*:$/gmi, '');\n  text = text.replace(/^.*CityBike.*:$/gmi, '');\n  \n  // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å \"–Ω–∞–ø–∏—Å–∞–ª(–∞):\" –∏–ª–∏ \"wrote:\"\n  text = text.replace(/^.*\\s+(–Ω–∞–ø–∏—Å–∞–ª[–∞]?|wrote|–ø–∏—à–µ—Ç|writes).*:.*$/gmi, '');\n  \n  // –£–¥–∞–ª—è–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ\n  text = text.replace(/\\[([^\\]]*)\\]/g, '$1'); // –û—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–µ–∑ —Å–∫–æ–±–æ–∫\n  text = text.replace(/\\[\"/g, ''); // –£–¥–∞–ª—è–µ–º –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É —Å –∫–∞–≤—ã—á–∫–æ–π\n  text = text.replace(/\"\\]/g, ''); // –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É —Å –∫–∞–≤—ã—á–∫–æ–π\n  text = text.replace(/\\[|\\]/g, ''); // –£–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏\n  \n  // –£–¥–∞–ª—è–µ–º —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏\n  text = text.replace(/\\{|\\}/g, '');\n  \n  // –£–¥–∞–ª—è–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫\n  text = text.replace(/^\"|\"$/gm, '');\n  \n  // –£–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏\n  text = text.replace(/^(-{3,}|_{3,}|\\*{3,})[\\s\\S]*$/m, '');\n  \n  // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —ç–º–æ–¥–∑–∏\n  text = text.replace(/üìß.*$/gm, '');\n  text = text.replace(/üí¨.*$/gm, '');\n  text = text.replace(/üåê.*$/gm, '');\n  text = text.replace(/\\|/g, '');\n  \n  // –£–¥–∞–ª—è–µ–º URL –∏ email\n  text = text.replace(/https?:\\/\\/[^\\s]+/g, '');\n  text = text.replace(/www\\.[^\\s]+/g, '');\n  text = text.replace(/[^\\s]+@[^\\s]+\\.[^\\s]+/g, '');\n  \n  // –£–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏\n  text = text.replace(/(–° —É–≤–∞–∂–µ–Ω–∏–µ–º|–° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏|Best regards|Sincerely|Regards|–ù–∞–¥–µ—é—Å—å.*–ø–æ–ª–µ–∑–Ω\\w*)[\\s\\S]*$/im, '');\n  text = text.replace(/^.*(–ö–æ–º–∞–Ω–¥–∞|Team)\\s+\\w+.*$/gmi, '');\n  \n  // –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï\n  \n  // –£–¥–∞–ª—è–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏\n  text = text.replace(/^\\*\\s*/gm, '');\n  text = text.replace(/\\s*\\*\\s*/g, ' ');\n  \n  // –°–Ω–∞—á–∞–ª–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É\n  text = text.replace(/\\n+/g, ' ');\n  \n  // –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã\n  text = text.replace(/\\s{2,}/g, ' ');\n  \n  // –°–ø–∏—Å–æ–∫ —ç–º–æ–¥–∑–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n  const emojiList = ['‚≠ê', 'üí∞', 'üî•', 'üü¢', 'üü°', 'üîµ', '‚úÖ', '‚ùå', 'üìß', 'üí¨', 'üåê', 'üöÄ', 'üìä', 'üíØ', '‚ö°', 'üîê', 'üìà', 'üéØ', 'üé®', 'üìå', 'üí°', 'üéÅ', 'üèÜ', 'üîî', 'üì¢', 'üíº', 'üìù', 'üîë', 'üí≥', 'üé™', 'üé≤', 'üéÆ', 'üëç', 'üëé', 'üíú', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'ü§ç', 'üñ§', 'ü§é'];\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥ —ç–º–æ–¥–∑–∏\n  emojiList.forEach(emoji => {\n    text = text.replace(new RegExp(`\\\\s*${emoji}`, 'g'), `\\n${emoji}`);\n  });\n  \n  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏ —Å —Ç–∏—Ä–µ - –æ–¥–∏–Ω–∞—Ä–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å\n  text = text.replace(/\\s*-\\s+/g, '\\n‚Ä¢ ');\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è, –µ—Å–ª–∏ –∑–∞ –Ω–∏–º –∏–¥–µ—Ç —Å–ø–∏—Å–æ–∫\n  text = text.replace(/:\\s*([‚≠êüí∞üî•üü¢üü°üîµ‚úÖ‚ùåüìßüí¨üåêüöÄüìäüíØ‚ö°üîêüìà])/g, ':\\n$1');\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏, –µ—Å–ª–∏ —Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã\n  text = text.replace(/\\.\\s+([–ê-–ØA-Z])/g, '.\\n$1');\n  \n  // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞\n  text = text.replace(/^\\n+/, '');\n  \n  // –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ (–±–æ–ª—å—à–µ –¥–≤—É—Ö –ø–æ–¥—Ä—è–¥)\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n  \n  // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –∑–Ω–∞–∫–∞–º–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è\n  text = text.replace(/\\s+([,.;:!?])/g, '$1');\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç–æ–π –∏ –¥–≤–æ–µ—Ç–æ—á–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç\n  text = text.replace(/([.,:])([–ê-–ØA-Z–∞-—èa-z])/g, '$1 $2');\n  \n  // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞\n  text = text.trim();\n  \n  return text;\n}\n\nfor (const item of emails) {\n  const email = item.json;\n  \n  // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n  let from = '';\n  let to = '';\n  let fromName = '';\n  let toName = '';\n  \n  if (email.from && email.from.value && email.from.value[0]) {\n    from = email.from.value[0].address || '';\n    fromName = email.from.value[0].name || '';\n  } else if (email.From) {\n    from = email.From;\n  }\n  \n  if (email.to && email.to.value && email.to.value[0]) {\n    to = email.to.value[0].address || '';\n    toName = email.to.value[0].name || '';\n  } else if (email.To) {\n    to = email.To;\n  }\n  \n  const subject = email.subject || email.Subject || '';\n  const messageId = email.id || '';\n  const threadId = email.threadId || '';\n  const labelIds = email.labelIds || email.labels || [];\n  const snippet = email.snippet || '';\n  \n  // –ü–æ–ª—É—á–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç\n  let body = email.text || email.textAsHtml || snippet || '';\n  body = cleanEmailText(body);\n  \n  // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º snippet\n  if (!body || body.length < 10) {\n    body = cleanEmailText(snippet);\n  }\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –ø–∏—Å—å–º–æ–º\n  const isSent = labelIds.some(label => \n    label === 'SENT' || \n    (typeof label === 'object' && label.id === 'SENT')\n  );\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º UNREAD\n  const isUnread = labelIds.some(label => \n    label === 'UNREAD' || \n    (typeof label === 'object' && label.id === 'UNREAD')\n  );\n  \n  logs.push(`–û–±—Ä–∞–±–æ—Ç–∫–∞: From: ${from}, To: ${to}, Subject: ${subject}`);\n  \n  if (!from && !to) {\n    logs.push(`–ü–†–û–ü–£–©–ï–ù–û: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è`);\n    continue;\n  }\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º email –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ\n  let clientEmail = '';\n  let clientName = '';\n  let direction = '';\n  \n  if (isSent || from.includes(COMPANY_DOMAIN)) {\n    direction = 'outgoing';\n    clientEmail = to.toLowerCase().trim();\n    clientName = toName || to.split('@')[0];\n  } else {\n    direction = 'incoming';\n    clientEmail = from.toLowerCase().trim();\n    clientName = fromName || from.split('@')[0];\n  }\n  \n  // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ email\n  const skipPatterns = [\n    'noreply', 'no-reply', 'donotreply', 'notification',\n    'mailer-daemon', 'postmaster', 'abuse@'\n  ];\n  \n  const shouldSkip = skipPatterns.some(pattern => \n    clientEmail.includes(pattern)\n  );\n  \n  if (shouldSkip) {\n    logs.push(`–ü–†–û–ü–£–©–ï–ù–û: ${clientEmail} —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω`);\n    continue;\n  }\n  \n  if (!clientEmail || clientEmail === '') {\n    logs.push(`–ü–†–û–ü–£–©–ï–ù–û: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å email –∫–ª–∏–µ–Ω—Ç–∞`);\n    continue;\n  }\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫\n  const hasRussian = /[–∞-—è–ê-–Ø—ë–Å]/.test(body + subject);\n  const language = hasRussian ? 'ru' : 'en';\n  \n  processedEmails.push({\n    gmailId: messageId,\n    threadId: threadId,\n    email: clientEmail,\n    senderName: clientName,\n    subject: subject || 'No subject',\n    body: body.substring(0, 5000),\n    snippet: snippet,\n    direction: direction,\n    isUnread: isUnread,\n    language: language,\n    labelIds: labelIds,\n    date: email.date || new Date(parseInt(email.internalDate || Date.now())).toISOString(),\n    timestamp: email.date || new Date(parseInt(email.internalDate || Date.now())).toISOString()\n  });\n  \n  logs.push(`–î–û–ë–ê–í–õ–ï–ù–û: ${clientEmail} (${direction})`);\n}\n\nlogs.push(`–ò–¢–û–ì–û: –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedEmails.length} –∏–∑ ${emails.length}`);\n\nif (processedEmails.length === 0) {\n  return [{\n    json: {\n      error: '–ù–µ—Ç –ø–∏—Å–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏',\n      logs: logs,\n      totalEmails: emails.length\n    }\n  }];\n}\n\nreturn processedEmails.map(e => ({json: e}));"
      },
      "id": "cb8e671f-4a88-4556-884e-d57974752132",
      "name": "üìãExtract Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        -48
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "3cb91292-d974-4ac2-b009-72d3d12776a6",
      "name": "‚è∞Check Every 10 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -16,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìã –¢–∞–±–ª–∏—Ü–∞: {{ $('‚öôÔ∏è CONFIG').item.json.table_processing_log }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nSELECT \n    '{{ $json.gmailId }}' as gmail_id,\n    '{{ $json.threadId }}' as thread_id,\n    '{{ $json.email }}' as email,\n    '{{ $json.senderName }}' as sender_name,\n    '{{ $json.subject.replace(/'/g, \"''\") }}' as subject,\n    '{{ $json.direction }}' as direction,\n    {{ $json.isUnread }} as is_unread,\n    CASE \n        WHEN EXISTS (\n            SELECT 1 FROM {{ $('‚öôÔ∏è CONFIG').item.json.table_processing_log }} \n            WHERE gmail_message_id = '{{ $json.gmailId }}'\n        ) THEN true \n        ELSE false \n    END as is_processed",
        "options": {}
      },
      "id": "502bf55c-5ae1-4e55-8f3c-9e6e1baee5b2",
      "name": "üîçCheck Processed Emails",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        688,
        -48
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏\nconst processedChecks = $input.all();\nconst allEmails = $items('üìãExtract Email Data');\nconst restoredEmails = [];\n\n// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å\nfor (const check of processedChecks) {\n  const processedCheck = check.json;\n  \n  // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π email –∏–∑ Extract Email Data\n  const emailData = allEmails.find(item => \n    item.json.gmailId === processedCheck.gmail_id\n  );\n  \n  if (emailData) {\n    restoredEmails.push({\n      json: {\n        ...emailData.json,\n        is_processed: processedCheck.is_processed\n      }\n    });\n  }\n}\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –í–°–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞\nreturn restoredEmails;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -48
      ],
      "id": "dfa84a3e-c9b5-4724-9ac6-1c208762dae3",
      "name": "üîÑRestore Email Data1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.is_processed }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "2629f11f-26d2-4107-b1c4-e3700f10f239"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "09d407c6-5f24-48c8-982c-a3ab516d0108",
      "name": "‚ùìIs New Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1072,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìã –¢–∞–±–ª–∏—Ü–∞: {{ $('‚öôÔ∏è CONFIG').item.json.table_processing_log }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nINSERT INTO {{ $('‚öôÔ∏è CONFIG').item.json.table_processing_log }} (\n    gmail_message_id,\n    thread_id,\n    email_from,\n    email_to,\n    subject,\n    direction,\n    is_unread,\n    processed_at\n) VALUES (\n    '{{ $json.gmailId }}',\n    '{{ $json.threadId }}',\n    '{{ $json.email }}',\n    '{{ $('‚öôÔ∏è CONFIG').item.json.company_email }}',\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.direction }}',\n    {{ $json.isUnread }},\n    NOW()\n)\nON CONFLICT (gmail_message_id) \nDO UPDATE SET \n    processed_at = NOW(),\n    is_unread = EXCLUDED.is_unread\nRETURNING *;",
        "options": {}
      },
      "id": "2e733ae9-e511-46b8-8e65-1ff5db98ebda",
      "name": "üìù Log Email Processing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        -64
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Log Email Processing\nconst logItems = $input.all();\nconst restoredEmails = $items('üîÑRestore Email Data1');\n\nconst result = [];\n\n// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å\nfor (const logItem of logItems) {\n    const logData = logItem.json;\n    \n    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–∏—Å—å–º–æ\n    const email = restoredEmails.find(item => \n        item.json.gmailId === logData.gmail_message_id\n    );\n    \n    if (email) {\n        result.push({\n            json: email.json\n        });\n    }\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        256
      ],
      "id": "3fded5e6-7363-4fed-877c-2b193f780ddd",
      "name": "üîÑ Restore for Save"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —É–∑–ª–∞ Code —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–∏—Å—å–º–∞—Ö\nconst allEmails = $input.all();\nconst results = [];\n\nfor (const item of allEmails) {\n    const emailData = item.json;\n    \n    results.push({\n        json: {\n            ...emailData, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Code\n            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è Save Conversation\n            direction: emailData.direction || 'incoming',\n            originalBody: emailData.body || emailData.snippet || '',\n            emailContent: '', // –ü–æ–∫–∞ –ø—É—Å—Ç–æ, –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ\n            leadScore: 0, // –û–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞\n            intent: 'unknown',\n            urgency: 'medium'\n        }\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        256
      ],
      "id": "87dfede5-eeec-42dc-8b28-246092e2e7de",
      "name": "üì¶Prepare Save Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìã –¢–∞–±–ª–∏—Ü–∞: {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nBEGIN;\n-- –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É –ø–æ email –∫–ª–∏–µ–Ω—Ç–∞\nINSERT INTO {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }} (\n    email,\n    thread_id, \n    subject,\n    messages,\n    status,\n    lead_score,\n    language,\n    message_count,\n    created_at\n) VALUES (\n    '{{ $json.email }}',\n    '{{ $json.threadId }}',\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    jsonb_build_array(\n        jsonb_build_object(\n            'type', '{{ $json.direction }}',\n            'content', '{{ ($json.body || $json.snippet || \"\").replace(/'/g, \"''\").substring(0, 5000) }}',\n            'date', '{{ $json.date }}',\n            'sender', '{{ $json.direction === \"incoming\" ? $json.senderName : $('‚öôÔ∏è CONFIG').item.json.company_name }}',\n            'thread_id', '{{ $json.threadId }}',\n            'gmail_id', '{{ $json.gmailId }}'\n        )\n    ),\n    'active',\n    {{ $json.leadScore || 0 }},\n    '{{ $json.language }}',\n    1,\n    NOW()\n)\nON CONFLICT (email) DO UPDATE SET\n    messages = \n        CASE\n            WHEN NOT EXISTS (\n                SELECT 1 FROM jsonb_array_elements(COALESCE({{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.messages, '[]'::jsonb)) elem\n                WHERE elem->>'gmail_id' = '{{ $json.gmailId }}'\n            )\n            THEN (\n                SELECT jsonb_agg(elem ORDER BY (elem->>'date')::timestamp ASC)\n                FROM (\n                    SELECT elem FROM jsonb_array_elements(COALESCE({{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.messages, '[]'::jsonb)) elem\n                    UNION ALL\n                    SELECT jsonb_build_object(\n                        'type', '{{ $json.direction }}',\n                        'content', '{{ ($json.body || $json.snippet || \"\").replace(/'/g, \"''\").substring(0, 5000) }}',\n                        'date', '{{ $json.date }}',\n                        'sender', '{{ $json.direction === \"incoming\" ? $json.senderName : $('‚öôÔ∏è CONFIG').item.json.company_name }}',\n                        'thread_id', '{{ $json.threadId }}',\n                        'gmail_id', '{{ $json.gmailId }}'\n                    )\n                ) AS all_messages(elem)\n            )\n            ELSE {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.messages\n        END,\n    message_count = \n        CASE\n            WHEN NOT EXISTS (\n                SELECT 1 FROM jsonb_array_elements(COALESCE({{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.messages, '[]'::jsonb)) elem\n                WHERE elem->>'gmail_id' = '{{ $json.gmailId }}'\n            )\n            THEN COALESCE({{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.message_count, 0) + 1\n            ELSE {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.message_count\n        END,\n    lead_score = GREATEST({{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}.lead_score, {{ $json.leadScore || 0 }}),\n    status = 'active',\n    thread_id = '{{ $json.threadId }}',\n    subject = '{{ $json.subject.replace(/'/g, \"''\") }}',\n    updated_at = NOW();\nCOMMIT;",
        "options": {}
      },
      "id": "46a6083c-65df-4a66-ba01-81a162dc3882",
      "name": "üíæSave Conversation",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Save to Email Monitoring\nconst originalEmails = $items('üîÑ Restore for Save');\nconst savedConversations = $input.all();\nconst results = [];\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Code –¥–ª—è Email Monitoring\nfor (const email of originalEmails) {\n    results.push({\n        json: email.json\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        256
      ],
      "id": "75b95d25-38df-4e05-b0ef-c883e0d45548",
      "name": "üîÑRestore Email Data for Monitoring"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìã –¢–∞–±–ª–∏—Ü—ã: \n--    {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }}\n--    {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nINSERT INTO {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }} (\n    record_id,\n    record_timestamp,\n    email,\n    thread_id,\n    user_name,\n    timestamp,\n    first_contact_time,\n    last_activity_time,\n    event_type,\n    message_count,\n    subject,\n    language,\n    intent,\n    urgency,\n    status,\n    last_reply_from\n) VALUES (\n    'email_{{ $json.email }}_{{ Date.now() }}',\n    NOW(),\n    '{{ $json.email }}',\n    '{{ $json.threadId }}',\n    '{{ $json.senderName }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.timestamp }}',\n    'new_email',\n    (SELECT COALESCE(message_count, 1) FROM {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }} WHERE email = '{{ $json.email }}' LIMIT 1),\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.language }}',\n    'unknown',\n    'medium',\n    '{{ $json.isUnread ? \"unread\" : \"active\" }}',\n    '{{ $json.direction === \"incoming\" ? \"client\" : \"company\" }}'\n)\nON CONFLICT (email) DO UPDATE SET\n    user_name = EXCLUDED.user_name,\n    thread_id = EXCLUDED.thread_id,\n    subject = EXCLUDED.subject,\n    language = EXCLUDED.language,\n    status = EXCLUDED.status,\n    last_reply_from = EXCLUDED.last_reply_from,\n    message_count = (\n        SELECT COALESCE(message_count, {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }}.message_count) \n        FROM {{ $('‚öôÔ∏è CONFIG').item.json.table_conversations }} \n        WHERE email = '{{ $json.email }}' \n        LIMIT 1\n    ),\n    last_activity_time = GREATEST(\n        {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }}.last_activity_time::timestamp,\n        '{{ $json.timestamp }}'::timestamp\n    ),\n    first_contact_time = LEAST(\n        {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }}.first_contact_time::timestamp,\n        '{{ $json.timestamp }}'::timestamp\n    ),\n    updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "9738de52-2208-466e-86eb-9fb7cc09ac80",
      "name": "üìäSave to Email Monitoring",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        960,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ —É–∑–ª–∞ Code\nconst allCodeData = $items('üîÑ Restore for Save');\nconst monitoringResult = $json;\n\n// –°–æ–∑–¥–∞–µ–º Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö email\nconst uniqueEmails = new Map();\n\n// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –ø–∏—Å—å–º–æ\nfor (const item of allCodeData) {\n    const email = item.json.email;\n    \n    // –ï—Å–ª–∏ email –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –∏–ª–∏ —Ç–µ–∫—É—â–∞—è –∑–∞–ø–∏—Å—å –Ω–æ–≤–µ–µ\n    if (!uniqueEmails.has(email) || \n        new Date(item.json.date) > new Date(uniqueEmails.get(email).date)) {\n        uniqueEmails.set(email, {\n            email: email,\n            senderName: item.json.senderName,\n            language: item.json.language || 'ru',\n            date: item.json.date,\n            timestamp: item.json.timestamp || item.json.date\n        });\n    }\n}\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞\nconst result = [];\nfor (const emailData of uniqueEmails.values()) {\n    result.push({\n        json: emailData\n    });\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        256
      ],
      "id": "6d87ee24-fb0d-42cc-96e5-b960522d63a3",
      "name": "üì§Pass Monitoring Data"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        144,
        480
      ],
      "id": "bd76cf1c-ad79-4a13-bfb0-136d2a30f96f",
      "name": "üîÅLoop Over Items"
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "94869f2e-fdd5-4962-8a8b-d4cf24b58093",
      "name": "‚è≥Wait 1 sec",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        352,
        496
      ],
      "webhookId": "wait-1-webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('‚öôÔ∏è CONFIG').item.json.webhook_base_url }}/webhook/extract-email-contact",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('‚öôÔ∏è CONFIG').item.json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"type\": \"single\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        544,
        496
      ],
      "id": "3dab3992-489f-4125-8a3a-c391d0e348a1",
      "name": "üìûCall Extract Contacts"
    },
    {
      "parameters": {
        "jsCode": "// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∞–ª—å—à–µ –ø–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\nconst extractResponse = $json; // –û—Ç–≤–µ—Ç –æ—Ç Call Extract Contacts\nconst currentData = $items('‚è≥Wait 1 sec')[0].json; // –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Ü–∏–∫–ª–∞\n\nreturn [{\n  json: {\n    ...currentData, // –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞\n    extractStatus: extractResponse.status || 'completed',\n    extractMessage: extractResponse.message || 'Contacts extracted'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        496
      ],
      "id": "3b78388c-c13a-44bb-b4d5-bbaf698cf218",
      "name": "üì§ Pass Result"
    },
    {
      "parameters": {
        "amount": 2
      },
      "id": "4a54dcd0-d0cd-4aa6-8979-83a055d01313",
      "name": "‚è≥Wait 2 sec",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        928,
        496
      ],
      "webhookId": "wait-2-webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('‚öôÔ∏è CONFIG').item.json.webhook_base_url }}/webhook/analyze-email-dialog",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('‚öôÔ∏è CONFIG').item.json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"language\": \"{{ $json.language }}\",\n  \"type\": \"single\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1104,
        496
      ],
      "id": "e208f8b3-ff00-46a3-b0df-de50e45f0bb2",
      "name": "üß†Call Analyze Dialog"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìã –¢–∞–±–ª–∏—Ü—ã:\n--    {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }}\n--    {{ $('‚öôÔ∏è CONFIG').item.json.table_analysis }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nUPDATE {{ $('‚öôÔ∏è CONFIG').item.json.table_monitoring }} em\nSET \n    urgency = CASE \n        WHEN (SELECT lead_scoring->>'temperature' \n              FROM {{ $('‚öôÔ∏è CONFIG').item.json.table_analysis }} \n              WHERE email = em.email \n              ORDER BY created_at DESC LIMIT 1) = 'hot' THEN 'high'\n        WHEN (SELECT lead_scoring->>'temperature' \n              FROM {{ $('‚öôÔ∏è CONFIG').item.json.table_analysis }} \n              WHERE email = em.email \n              ORDER BY created_at DESC LIMIT 1) = 'warm' THEN 'medium'\n        ELSE 'low'\n    END,\n    updated_at = NOW()\nWHERE em.email = '{{ $items('Pass Monitoring Data')[0].json.email }}';\n\nSELECT 'Updated' as status;",
        "options": {}
      },
      "id": "4e9f17ca-f964-4521-8b21-bd6fa07652bc",
      "name": "üìàUpdate Metrics After Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        496
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É\nconst currentData = $json; // –î–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —É–∑–ª–∞ (Update Metrics After Analysis)\n\nreturn [{\n  json: {\n    status: 'processing_completed',\n    email: currentData.email || 'unknown',\n    processed: true,\n    completedAt: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        496
      ],
      "id": "7ff13fe4-f3ab-4e33-b92f-9db7e5f23da5",
      "name": "‚úÖComplete Outgoing"
    }
  ],
  "pinData": {},
  "connections": {
    "‚öôÔ∏è CONFIG": {
      "main": [
        [
          {
            "node": "üì•Get Recent Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì•Get Recent Emails": {
      "main": [
        [
          {
            "node": "üìãExtract Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìãExtract Email Data": {
      "main": [
        [
          {
            "node": "üîçCheck Processed Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è∞Check Every 10 Minutes": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è CONFIG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîçCheck Processed Emails": {
      "main": [
        [
          {
            "node": "üîÑRestore Email Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑRestore Email Data1": {
      "main": [
        [
          {
            "node": "‚ùìIs New Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùìIs New Email?": {
      "main": [
        [
          {
            "node": "üìù Log Email Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Log Email Processing": {
      "main": [
        [
          {
            "node": "üîÑ Restore for Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Restore for Save": {
      "main": [
        [
          {
            "node": "üì¶Prepare Save Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì¶Prepare Save Data": {
      "main": [
        [
          {
            "node": "üíæSave Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæSave Conversation": {
      "main": [
        [
          {
            "node": "üîÑRestore Email Data for Monitoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑRestore Email Data for Monitoring": {
      "main": [
        [
          {
            "node": "üìäSave to Email Monitoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìäSave to Email Monitoring": {
      "main": [
        [
          {
            "node": "üì§Pass Monitoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§Pass Monitoring Data": {
      "main": [
        [
          {
            "node": "üîÅLoop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÅLoop Over Items": {
      "main": [
        [],
        [
          {
            "node": "‚è≥Wait 1 sec",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è≥Wait 1 sec": {
      "main": [
        [
          {
            "node": "üìûCall Extract Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìûCall Extract Contacts": {
      "main": [
        [
          {
            "node": "üì§ Pass Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Pass Result": {
      "main": [
        [
          {
            "node": "‚è≥Wait 2 sec",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è≥Wait 2 sec": {
      "main": [
        [
          {
            "node": "üß†Call Analyze Dialog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üß†Call Analyze Dialog": {
      "main": [
        [
          {
            "node": "üìàUpdate Metrics After Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìàUpdate Metrics After Analysis": {
      "main": [
        [
          {
            "node": "‚úÖComplete Outgoing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖComplete Outgoing": {
      "main": [
        [
          {
            "node": "üîÅLoop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e757c233-c30b-47fb-9bea-d9c79d2f8dbb",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "QtELtcLpm0G1lSXS",
  "tags": []
}