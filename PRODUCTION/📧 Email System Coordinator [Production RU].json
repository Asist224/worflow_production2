{
  "name": "ğŸ“§ Email System Coordinator [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "# âš™ï¸ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ WORKFLOW\n\n---\n\n## ĞŸĞµÑ€ĞµĞ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼:\n\n### 1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ ÑƒĞ·ĞµĞ» Â«âš™ï¸ CONFIGÂ»\nĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:\n\n| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |\n|----------|----------|\n| `company_domain` | Ğ”Ğ¾Ğ¼ĞµĞ½ Ğ²Ğ°ÑˆĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ |\n| `company_name` | ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ |\n| `company_email` | Email Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ |\n| `api_key` | Ğ’Ğ°Ñˆ API ĞºĞ»ÑÑ‡ |\n| `webhook_base_url` | URL Ğ²Ğ°ÑˆĞµĞ³Ğ¾ n8n |\n| `table_*` | ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ† Ğ‘Ğ” |\n\n---\n\n### 2. ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Credentials\n\n**Gmail OAuth2** â†’ ÑƒĞ·ĞµĞ» Â«Get Recent EmailsÂ»\n\n**PostgreSQL** â†’ Ğ²ÑĞµ SQL ÑƒĞ·Ğ»Ñ‹:\nâ€¢ Check Processed Emails\nâ€¢ Log Email Processing\nâ€¢ Save Conversation\nâ€¢ Save to Email Monitoring\nâ€¢ Update Metrics After Analysis\n\n---\n\n### 3. Sub-workflows\n\nĞ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚:\nâ€¢ `/webhook/extract-email-contact`\nâ€¢ `/webhook/analyze-email-dialog`\n\n---\n\n### 4. ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ\n\nĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ **Active** Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¼ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¼ ÑƒĞ³Ğ»Ñƒ.\nWorkflow Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚.",
        "height": 1244,
        "width": 480,
        "color": 6
      },
      "id": "966a9474-7f47-417f-aa55-60131d164119",
      "name": "ğŸ“‹ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ¯",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -528,
        -256
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "company-domain", "name": "company_domain", "value": "your-company.com", "type": "string"},
            {"id": "company-name", "name": "company_name", "value": "Your Company", "type": "string"},
            {"id": "company-email", "name": "company_email", "value": "support@your-company.com", "type": "string"},
            {"id": "api-key", "name": "api_key", "value": "YOUR-API-KEY-CHANGE-ME", "type": "string"},
            {"id": "webhook-url", "name": "webhook_base_url", "value": "https://your-n8n.com", "type": "string"},
            {"id": "table-log", "name": "table_processing_log", "value": "email_processing_log", "type": "string"},
            {"id": "table-conv", "name": "table_conversations", "value": "gmail_conversations", "type": "string"},
            {"id": "table-mon", "name": "table_monitoring", "value": "email_monitoring", "type": "string"},
            {"id": "table-analysis", "name": "table_analysis", "value": "email_dialog_analysis", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "e773bbc5-a17b-486c-85ff-e93bfe7b817b",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        144,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "simple": false,
        "filters": {
          "q": "=newer_than:5d -from:noreply -from:no-reply -from:donotreply -from:notification"
        },
        "options": {}
      },
      "id": "51eef9f8-a34f-4cb6-a378-adc3530066fa",
      "name": "ğŸ“¥Get Recent Emails",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        304,
        -48
      ],
      "webhookId": "92e92da3-2b91-46e4-b567-e8a64ffded96",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“§ EXTRACT EMAIL DATA\n// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±ĞµÑ€ÑƒÑ‚ÑÑ Ğ¸Ğ· ÑƒĞ·Ğ»Ğ° CONFIG Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ\nconst config = $('âš™ï¸ CONFIG').first().json;\nconst COMPANY_DOMAIN = config.company_domain;\n\n// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ email Ğ¸Ğ· Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸\nconst emails = $input.all();\nconst processedEmails = [];\nconst logs = [];\n\nlogs.push(`ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ${emails.length} Ğ¿Ğ¸ÑĞµĞ¼ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸`);\n\n// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° email\nfunction cleanEmailText(text) {\n  if (!text) return '';\n  \n  // Ğ¡ĞĞĞ§ĞĞ›Ğ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ’Ğ¡Ğ• ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ñ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼Ğ¸\n  text = text.replace(/^.*\\d{1,2}\\s+(ÑĞ½Ğ²|Ñ„ĞµĞ²|Ğ¼Ğ°Ñ€|Ğ°Ğ¿Ñ€|Ğ¼Ğ°Ñ|Ğ¸ÑĞ½|Ğ¸ÑĞ»|Ğ°Ğ²Ğ³|ÑĞµĞ½|Ğ¾ĞºÑ‚|Ğ½Ğ¾Ñ|Ğ´ĞµĞº)\\w*\\.?\\s+\\d{4}\\s+Ğ³\\.\\s+Ğ²\\s+\\d{1,2}:\\d{2}.*$/gmi, '');\n  text = text.replace(/^.*\\d{1,2}\\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\w*\\s+\\d{4}\\s+at\\s+\\d{1,2}:\\d{2}.*$/gmi, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ñ Ğ´Ğ½ÑĞ¼Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸\n  text = text.replace(/^.*(ĞŸĞ½|Ğ’Ñ‚|Ğ¡Ñ€|Ğ§Ñ‚|ĞŸÑ‚|Ğ¡Ğ±|Ğ’Ñ|Ğ¿Ğ½|Ğ²Ñ‚|ÑÑ€|Ñ‡Ñ‚|Ğ¿Ñ‚|ÑĞ±|Ğ²Ñ|Mon|Tue|Wed|Thu|Fri|Sat|Sun),\\s+\\d{1,2}\\s+.*$/gmi, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ñ†Ğ¸Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Gmail\n  text = text.replace(/^>+.*$/gm, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ email Ğ°Ğ´Ñ€ĞµÑĞ° Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ Ğ´Ğ²Ğ¾ĞµÑ‚Ğ¾Ñ‡Ğ¸ĞµĞ¼\n  text = text.replace(/^.*[A-Za-z\\s]+\\s*<[^>]+@[^>]+>.*:$/gm, '');\n  text = text.replace(/^.*Cryptomator Team.*:$/gmi, '');\n  text = text.replace(/^.*CityBike.*:$/gmi, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ñ \"Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»(Ğ°):\" Ğ¸Ğ»Ğ¸ \"wrote:\"\n  text = text.replace(/^.*\\s+(Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»[Ğ°]?|wrote|Ğ¿Ğ¸ÑˆĞµÑ‚|writes).*:.*$/gmi, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğµ ÑĞºĞ¾Ğ±ĞºĞ¸ Ğ¸ Ğ¸Ñ… ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ\n  text = text.replace(/\\[([^\\]]*)\\]/g, '$1'); // ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ±ĞµĞ· ÑĞºĞ¾Ğ±Ğ¾Ğº\n  text = text.replace(/\\[\"/g, ''); // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰ÑƒÑ ÑĞºĞ¾Ğ±ĞºÑƒ Ñ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¾Ğ¹\n  text = text.replace(/\"\\]/g, ''); // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰ÑƒÑ ÑĞºĞ¾Ğ±ĞºÑƒ Ñ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¾Ğ¹\n  text = text.replace(/\\[|\\]/g, ''); // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞ¸ĞµÑÑ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğµ ÑĞºĞ¾Ğ±ĞºĞ¸\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ñ„Ğ¸Ğ³ÑƒÑ€Ğ½Ñ‹Ğµ ÑĞºĞ¾Ğ±ĞºĞ¸\n  text = text.replace(/\\{|\\}/g, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ´Ğ²Ğ¾Ğ¹Ğ½Ñ‹Ğµ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ Ğ¸ ĞºĞ¾Ğ½Ñ†Ğµ ÑÑ‚Ñ€Ğ¾Ğº\n  text = text.replace(/^\"|\"$/gm, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»Ğ¸\n  text = text.replace(/^(-{3,}|_{3,}|\\*{3,})[\\s\\S]*$/m, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ñ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸\n  text = text.replace(/ğŸ“§.*$/gm, '');\n  text = text.replace(/ğŸ’¬.*$/gm, '');\n  text = text.replace(/ğŸŒ.*$/gm, '');\n  text = text.replace(/\\|/g, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ URL Ğ¸ email\n  text = text.replace(/https?:\\/\\/[^\\s]+/g, '');\n  text = text.replace(/www\\.[^\\s]+/g, '');\n  text = text.replace(/[^\\s]+@[^\\s]+\\.[^\\s]+/g, '');\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸\n  text = text.replace(/(Ğ¡ ÑƒĞ²Ğ°Ğ¶ĞµĞ½Ğ¸ĞµĞ¼|Ğ¡ Ğ½Ğ°Ğ¸Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸|Best regards|Sincerely|Regards|ĞĞ°Ğ´ĞµÑÑÑŒ.*Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½\\w*)[\\s\\S]*$/im, '');\n  text = text.replace(/^.*(ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°|Team)\\s+\\w+.*$/gmi, '');\n  \n  // Ğ¤ĞĞ ĞœĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•\n  \n  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ·Ğ²ĞµĞ·Ğ´Ğ¾Ñ‡ĞºĞ¸\n  text = text.replace(/^\\*\\s*/gm, '');\n  text = text.replace(/\\s*\\*\\s*/g, ' ');\n  \n  // Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ²ĞµÑÑŒ Ñ‚ĞµĞºÑÑ‚ Ğ² Ğ¾Ğ´Ğ½Ñƒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ\n  text = text.replace(/\\n+/g, ' ');\n  \n  // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹\n  text = text.replace(/\\s{2,}/g, ' ');\n  \n  // Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n  const emojiList = ['â­', 'ğŸ’°', 'ğŸ”¥', 'ğŸŸ¢', 'ğŸŸ¡', 'ğŸ”µ', 'âœ…', 'âŒ', 'ğŸ“§', 'ğŸ’¬', 'ğŸŒ', 'ğŸš€', 'ğŸ“Š', 'ğŸ’¯', 'âš¡', 'ğŸ”', 'ğŸ“ˆ', 'ğŸ¯', 'ğŸ¨', 'ğŸ“Œ', 'ğŸ’¡', 'ğŸ', 'ğŸ†', 'ğŸ””', 'ğŸ“¢', 'ğŸ’¼', 'ğŸ“', 'ğŸ”‘', 'ğŸ’³', 'ğŸª', 'ğŸ²', 'ğŸ®', 'ğŸ‘', 'ğŸ‘', 'ğŸ’œ', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤'];\n  \n  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ½Ğ¾Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸\n  emojiList.forEach(emoji => {\n    text = text.replace(new RegExp(`\\\\s*${emoji}`, 'g'), `\\n${emoji}`);\n  });\n  \n  // ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞºĞ¸ Ñ Ñ‚Ğ¸Ñ€Ğµ - Ğ¾Ğ´Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ½Ğ¾Ñ\n  text = text.replace(/\\s*-\\s+/g, '\\nâ€¢ ');\n  \n  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ½Ğ¾Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´Ğ²Ğ¾ĞµÑ‚Ğ¾Ñ‡Ğ¸Ñ, ĞµÑĞ»Ğ¸ Ğ·Ğ° Ğ½Ğ¸Ğ¼ Ğ¸Ğ´ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº\n  text = text.replace(/:\\s*([â­ğŸ’°ğŸ”¥ğŸŸ¢ğŸŸ¡ğŸ”µâœ…âŒğŸ“§ğŸ’¬ğŸŒğŸš€ğŸ“ŠğŸ’¯âš¡ğŸ”ğŸ“ˆ])/g, ':\\n$1');\n  \n  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ½Ğ¾Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸, ĞµÑĞ»Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ Ğ·Ğ°Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ Ğ±ÑƒĞºĞ²Ñ‹\n  text = text.replace(/\\.\\s+([Ğ-Ğ¯A-Z])/g, '.\\n$1');\n  \n  // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ½Ğ¾Ñ Ğ² ÑĞ°Ğ¼Ğ¾Ğ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°\n  text = text.replace(/^\\n+/, '');\n  \n  // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ ÑÑ‚Ñ€Ğ¾Ğº (Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ´Ğ²ÑƒÑ… Ğ¿Ğ¾Ğ´Ñ€ÑĞ´)\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n  \n  // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ½Ğ°ĞºĞ°Ğ¼Ğ¸ Ğ¿Ñ€ĞµĞ¿Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ\n  text = text.replace(/\\s+([,.;:!?])/g, '$1');\n  \n  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ» Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸, Ğ·Ğ°Ğ¿ÑÑ‚Ğ¾Ğ¹ Ğ¸ Ğ´Ğ²Ğ¾ĞµÑ‚Ğ¾Ñ‡Ğ¸Ñ, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚\n  text = text.replace(/([.,:])([Ğ-Ğ¯A-ZĞ°-Ña-z])/g, '$1 $2');\n  \n  // Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°\n  text = text.trim();\n  \n  return text;\n}\n\nfor (const item of emails) {\n  const email = item.json;\n  \n  // Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹\n  let from = '';\n  let to = '';\n  let fromName = '';\n  let toName = '';\n  \n  if (email.from && email.from.value && email.from.value[0]) {\n    from = email.from.value[0].address || '';\n    fromName = email.from.value[0].name || '';\n  } else if (email.From) {\n    from = email.From;\n  }\n  \n  if (email.to && email.to.value && email.to.value[0]) {\n    to = email.to.value[0].address || '';\n    toName = email.to.value[0].name || '';\n  } else if (email.To) {\n    to = email.To;\n  }\n  \n  const subject = email.subject || email.Subject || '';\n  const messageId = email.id || '';\n  const threadId = email.threadId || '';\n  const labelIds = email.labelIds || email.labels || [];\n  const snippet = email.snippet || '';\n  \n  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸ Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚\n  let body = email.text || email.textAsHtml || snippet || '';\n  body = cleanEmailText(body);\n  \n  // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ Ñ‚ĞµĞºÑÑ‚ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ snippet\n  if (!body || body.length < 10) {\n    body = cleanEmailText(snippet);\n  }\n  \n  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾Ğ¼\n  const isSent = labelIds.some(label => \n    label === 'SENT' || \n    (typeof label === 'object' && label.id === 'SENT')\n  );\n  \n  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ UNREAD\n  const isUnread = labelIds.some(label => \n    label === 'UNREAD' || \n    (typeof label === 'object' && label.id === 'UNREAD')\n  );\n  \n  logs.push(`ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°: From: ${from}, To: ${to}, Subject: ${subject}`);\n  \n  if (!from && !to) {\n    logs.push(`ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ: Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ñ`);\n    continue;\n  }\n  \n  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ\n  let clientEmail = '';\n  let clientName = '';\n  let direction = '';\n  \n  if (isSent || from.includes(COMPANY_DOMAIN)) {\n    direction = 'outgoing';\n    clientEmail = to.toLowerCase().trim();\n    clientName = toName || to.split('@')[0];\n  } else {\n    direction = 'incoming';\n    clientEmail = from.toLowerCase().trim();\n    clientName = fromName || from.split('@')[0];\n  }\n  \n  // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ½ĞµĞ¶ĞµĞ»Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ email\n  const skipPatterns = [\n    'noreply', 'no-reply', 'donotreply', 'notification',\n    'mailer-daemon', 'postmaster', 'abuse@'\n  ];\n  \n  const shouldSkip = skipPatterns.some(pattern => \n    clientEmail.includes(pattern)\n  );\n  \n  if (shouldSkip) {\n    logs.push(`ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ: ${clientEmail} ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½`);\n    continue;\n  }\n  \n  if (!clientEmail || clientEmail === '') {\n    logs.push(`ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ: Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°`);\n    continue;\n  }\n  \n  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑĞ·Ñ‹Ğº\n  const hasRussian = /[Ğ°-ÑĞ-Ğ¯Ñ‘Ğ]/.test(body + subject);\n  const language = hasRussian ? 'ru' : 'en';\n  \n  processedEmails.push({\n    gmailId: messageId,\n    threadId: threadId,\n    email: clientEmail,\n    senderName: clientName,\n    subject: subject || 'No subject',\n    body: body.substring(0, 5000),\n    snippet: snippet,\n    direction: direction,\n    isUnread: isUnread,\n    language: language,\n    labelIds: labelIds,\n    date: email.date || new Date(parseInt(email.internalDate || Date.now())).toISOString(),\n    timestamp: email.date || new Date(parseInt(email.internalDate || Date.now())).toISOString()\n  });\n  \n  logs.push(`Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: ${clientEmail} (${direction})`);\n}\n\nlogs.push(`Ğ˜Ğ¢ĞĞ“Ğ: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ ${processedEmails.length} Ğ¸Ğ· ${emails.length}`);\n\nif (processedEmails.length === 0) {\n  return [{\n    json: {\n      error: 'ĞĞµÑ‚ Ğ¿Ğ¸ÑĞµĞ¼ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸',\n      logs: logs,\n      totalEmails: emails.length\n    }\n  }];\n}\n\nreturn processedEmails.map(e => ({json: e}));"
      },
      "id": "cb8e671f-4a88-4556-884e-d57974752132",
      "name": "ğŸ“‹Extract Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        -48
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "3cb91292-d974-4ac2-b009-72d3d12776a6",
      "name": "â°Check Every 10 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -16,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: {{ $('âš™ï¸ CONFIG').first().json.table_processing_log }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSELECT \n    '{{ $json.gmailId }}' as gmail_id,\n    '{{ $json.threadId }}' as thread_id,\n    '{{ $json.email }}' as email,\n    '{{ $json.senderName }}' as sender_name,\n    '{{ $json.subject.replace(/'/g, \"''\") }}' as subject,\n    '{{ $json.direction }}' as direction,\n    {{ $json.isUnread }} as is_unread,\n    CASE \n        WHEN EXISTS (\n            SELECT 1 FROM {{ $('âš™ï¸ CONFIG').first().json.table_processing_log }} \n            WHERE gmail_message_id = '{{ $json.gmailId }}'\n        ) THEN true \n        ELSE false \n    END as is_processed",
        "options": {}
      },
      "id": "502bf55c-5ae1-4e55-8f3c-9e6e1baee5b2",
      "name": "ğŸ”Check Processed Emails",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        688,
        -48
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸\nconst processedChecks = $input.all();\nconst allEmails = $items('ğŸ“‹Extract Email Data');\nconst restoredEmails = [];\n\n// ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ\nfor (const check of processedChecks) {\n  const processedCheck = check.json;\n  \n  // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ email Ğ¸Ğ· Extract Email Data\n  const emailData = allEmails.find(item => \n    item.json.gmailId === processedCheck.gmail_id\n  );\n  \n  if (emailData) {\n    restoredEmails.push({\n      json: {\n        ...emailData.json,\n        is_processed: processedCheck.is_processed\n      }\n    });\n  }\n}\n\n// Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°\nreturn restoredEmails;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -48
      ],
      "id": "dfa84a3e-c9b5-4724-9ac6-1c208762dae3",
      "name": "ğŸ”„Restore Email Data1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.is_processed }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "2629f11f-26d2-4107-b1c4-e3700f10f239"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "09d407c6-5f24-48c8-982c-a3ab516d0108",
      "name": "â“Is New Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1072,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: {{ $('âš™ï¸ CONFIG').first().json.table_processing_log }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_processing_log }} (\n    gmail_message_id,\n    thread_id,\n    email_from,\n    email_to,\n    subject,\n    direction,\n    is_unread,\n    processed_at\n) VALUES (\n    '{{ $json.gmailId }}',\n    '{{ $json.threadId }}',\n    '{{ $json.email }}',\n    '{{ $('âš™ï¸ CONFIG').first().json.company_email }}',\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.direction }}',\n    {{ $json.isUnread }},\n    NOW()\n)\nON CONFLICT (gmail_message_id) \nDO UPDATE SET \n    processed_at = NOW(),\n    is_unread = EXCLUDED.is_unread\nRETURNING *;",
        "options": {}
      },
      "id": "2e733ae9-e511-46b8-8e65-1ff5db98ebda",
      "name": "ğŸ“ Log Email Processing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        -64
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Log Email Processing\nconst logItems = $input.all();\nconst restoredEmails = $items('ğŸ”„Restore Email Data1');\n\nconst result = [];\n\n// ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ\nfor (const logItem of logItems) {\n    const logData = logItem.json;\n    \n    // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾\n    const email = restoredEmails.find(item => \n        item.json.gmailId === logData.gmail_message_id\n    );\n    \n    if (email) {\n        result.push({\n            json: email.json\n        });\n    }\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        256
      ],
      "id": "3fded5e6-7363-4fed-877c-2b193f780ddd",
      "name": "ğŸ”„ Restore for Save"
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑƒĞ·Ğ»Ğ° Code Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°Ñ…\nconst allEmails = $input.all();\nconst results = [];\n\nfor (const item of allEmails) {\n    const emailData = item.json;\n    \n    results.push({\n        json: {\n            ...emailData, // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Code\n            // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ Save Conversation\n            direction: emailData.direction || 'incoming',\n            originalBody: emailData.body || emailData.snippet || '',\n            emailContent: '', // ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ\n            leadScore: 0, // ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n            intent: 'unknown',\n            urgency: 'medium'\n        }\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        256
      ],
      "id": "87dfede5-eeec-42dc-8b28-246092e2e7de",
      "name": "ğŸ“¦Prepare Save Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: {{ $('âš™ï¸ CONFIG').first().json.table_conversations }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nBEGIN;\n-- Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºÑƒ Ğ¿Ğ¾ email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_conversations }} (\n    email,\n    thread_id, \n    subject,\n    messages,\n    status,\n    lead_score,\n    language,\n    message_count,\n    created_at\n) VALUES (\n    '{{ $json.email }}',\n    '{{ $json.threadId }}',\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    jsonb_build_array(\n        jsonb_build_object(\n            'type', '{{ $json.direction }}',\n            'content', '{{ ($json.body || $json.snippet || \"\").replace(/'/g, \"''\").substring(0, 5000) }}',\n            'date', '{{ $json.date }}',\n            'sender', '{{ $json.direction === \"incoming\" ? $json.senderName : $('âš™ï¸ CONFIG').first().json.company_name }}',\n            'thread_id', '{{ $json.threadId }}',\n            'gmail_id', '{{ $json.gmailId }}'\n        )\n    ),\n    'active',\n    {{ $json.leadScore || 0 }},\n    '{{ $json.language }}',\n    1,\n    NOW()\n)\nON CONFLICT (email) DO UPDATE SET\n    messages = \n        CASE\n            WHEN NOT EXISTS (\n                SELECT 1 FROM jsonb_array_elements(COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.messages, '[]'::jsonb)) elem\n                WHERE elem->>'gmail_id' = '{{ $json.gmailId }}'\n            )\n            THEN (\n                SELECT jsonb_agg(elem ORDER BY (elem->>'date')::timestamp ASC)\n                FROM (\n                    SELECT elem FROM jsonb_array_elements(COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.messages, '[]'::jsonb)) elem\n                    UNION ALL\n                    SELECT jsonb_build_object(\n                        'type', '{{ $json.direction }}',\n                        'content', '{{ ($json.body || $json.snippet || \"\").replace(/'/g, \"''\").substring(0, 5000) }}',\n                        'date', '{{ $json.date }}',\n                        'sender', '{{ $json.direction === \"incoming\" ? $json.senderName : $('âš™ï¸ CONFIG').first().json.company_name }}',\n                        'thread_id', '{{ $json.threadId }}',\n                        'gmail_id', '{{ $json.gmailId }}'\n                    )\n                ) AS all_messages(elem)\n            )\n            ELSE {{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.messages\n        END,\n    message_count = \n        CASE\n            WHEN NOT EXISTS (\n                SELECT 1 FROM jsonb_array_elements(COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.messages, '[]'::jsonb)) elem\n                WHERE elem->>'gmail_id' = '{{ $json.gmailId }}'\n            )\n            THEN COALESCE({{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.message_count, 0) + 1\n            ELSE {{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.message_count\n        END,\n    lead_score = GREATEST({{ $('âš™ï¸ CONFIG').first().json.table_conversations }}.lead_score, {{ $json.leadScore || 0 }}),\n    status = 'active',\n    thread_id = '{{ $json.threadId }}',\n    subject = '{{ $json.subject.replace(/'/g, \"''\") }}',\n    updated_at = NOW();\nCOMMIT;",
        "options": {}
      },
      "id": "46a6083c-65df-4a66-ba01-81a162dc3882",
      "name": "ğŸ’¾Save Conversation",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Save to Email Monitoring\nconst originalEmails = $items('ğŸ”„ Restore for Save');\nconst savedConversations = $input.all();\nconst results = [];\n\n// Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Code Ğ´Ğ»Ñ Email Monitoring\nfor (const email of originalEmails) {\n    results.push({\n        json: email.json\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        256
      ],
      "id": "75b95d25-38df-4e05-b0ef-c883e0d45548",
      "name": "ğŸ”„Restore Email Data for Monitoring"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹: \n--    {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }}\n--    {{ $('âš™ï¸ CONFIG').first().json.table_conversations }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }} (\n    record_id,\n    record_timestamp,\n    email,\n    thread_id,\n    user_name,\n    timestamp,\n    first_contact_time,\n    last_activity_time,\n    event_type,\n    message_count,\n    subject,\n    language,\n    intent,\n    urgency,\n    status,\n    last_reply_from\n) VALUES (\n    'email_{{ $json.email }}_{{ Date.now() }}',\n    NOW(),\n    '{{ $json.email }}',\n    '{{ $json.threadId }}',\n    '{{ $json.senderName }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.timestamp }}',\n    'new_email',\n    (SELECT COALESCE(message_count, 1) FROM {{ $('âš™ï¸ CONFIG').first().json.table_conversations }} WHERE email = '{{ $json.email }}' LIMIT 1),\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.language }}',\n    'unknown',\n    'medium',\n    '{{ $json.isUnread ? \"unread\" : \"active\" }}',\n    '{{ $json.direction === \"incoming\" ? \"client\" : \"company\" }}'\n)\nON CONFLICT (email) DO UPDATE SET\n    user_name = EXCLUDED.user_name,\n    thread_id = EXCLUDED.thread_id,\n    subject = EXCLUDED.subject,\n    language = EXCLUDED.language,\n    status = EXCLUDED.status,\n    last_reply_from = EXCLUDED.last_reply_from,\n    message_count = (\n        SELECT COALESCE(message_count, {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }}.message_count) \n        FROM {{ $('âš™ï¸ CONFIG').first().json.table_conversations }} \n        WHERE email = '{{ $json.email }}' \n        LIMIT 1\n    ),\n    last_activity_time = GREATEST(\n        {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }}.last_activity_time::timestamp,\n        '{{ $json.timestamp }}'::timestamp\n    ),\n    first_contact_time = LEAST(\n        {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }}.first_contact_time::timestamp,\n        '{{ $json.timestamp }}'::timestamp\n    ),\n    updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "9738de52-2208-466e-86eb-9fb7cc09ac80",
      "name": "ğŸ“ŠSave to Email Monitoring",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        960,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑƒĞ·Ğ»Ğ° Code\nconst allCodeData = $items('ğŸ”„ Restore for Save');\nconst monitoringResult = $json;\n\n// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Map Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… email\nconst uniqueEmails = new Map();\n\n// ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾\nfor (const item of allCodeData) {\n    const email = item.json.email;\n    \n    // Ğ•ÑĞ»Ğ¸ email ĞµÑ‰Ğµ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ¾Ğ²ĞµĞµ\n    if (!uniqueEmails.has(email) || \n        new Date(item.json.date) > new Date(uniqueEmails.get(email).date)) {\n        uniqueEmails.set(email, {\n            email: email,\n            senderName: item.json.senderName,\n            language: item.json.language || 'ru',\n            date: item.json.date,\n            timestamp: item.json.timestamp || item.json.date\n        });\n    }\n}\n\n// ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Map Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°\nconst result = [];\nfor (const emailData of uniqueEmails.values()) {\n    result.push({\n        json: emailData\n    });\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        256
      ],
      "id": "6d87ee24-fb0d-42cc-96e5-b960522d63a3",
      "name": "ğŸ“¤Pass Monitoring Data"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        144,
        480
      ],
      "id": "bd76cf1c-ad79-4a13-bfb0-136d2a30f96f",
      "name": "ğŸ”Loop Over Items"
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "94869f2e-fdd5-4962-8a8b-d4cf24b58093",
      "name": "â³Wait 1 sec",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        352,
        496
      ],
      "webhookId": "wait-1-webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('âš™ï¸ CONFIG').first().json.webhook_base_url }}/webhook/extract-email-contact",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('âš™ï¸ CONFIG').first().json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"type\": \"single\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        544,
        496
      ],
      "id": "3dab3992-489f-4125-8a3a-c391d0e348a1",
      "name": "ğŸ“Call Extract Contacts"
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²\nconst extractResponse = $json; // ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Call Extract Contacts\nconst currentData = $items('â³Wait 1 sec')[0].json; // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· Ñ†Ğ¸ĞºĞ»Ğ°\n\nreturn [{\n  json: {\n    ...currentData, // Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°\n    extractStatus: extractResponse.status || 'completed',\n    extractMessage: extractResponse.message || 'Contacts extracted'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        496
      ],
      "id": "3b78388c-c13a-44bb-b4d5-bbaf698cf218",
      "name": "ğŸ“¤ Pass Result"
    },
    {
      "parameters": {
        "amount": 2
      },
      "id": "4a54dcd0-d0cd-4aa6-8979-83a055d01313",
      "name": "â³Wait 2 sec",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        928,
        496
      ],
      "webhookId": "wait-2-webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('âš™ï¸ CONFIG').first().json.webhook_base_url }}/webhook/analyze-email-dialog",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('âš™ï¸ CONFIG').first().json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"language\": \"{{ $json.language }}\",\n  \"type\": \"single\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1104,
        496
      ],
      "id": "e208f8b3-ff00-46a3-b0df-de50e45f0bb2",
      "name": "ğŸ§ Call Analyze Dialog"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:\n--    {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }}\n--    {{ $('âš™ï¸ CONFIG').first().json.table_analysis }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nUPDATE {{ $('âš™ï¸ CONFIG').first().json.table_monitoring }} em\nSET \n    urgency = CASE \n        WHEN (SELECT lead_scoring->>'temperature' \n              FROM {{ $('âš™ï¸ CONFIG').first().json.table_analysis }} \n              WHERE email = em.email \n              ORDER BY created_at DESC LIMIT 1) = 'hot' THEN 'high'\n        WHEN (SELECT lead_scoring->>'temperature' \n              FROM {{ $('âš™ï¸ CONFIG').first().json.table_analysis }} \n              WHERE email = em.email \n              ORDER BY created_at DESC LIMIT 1) = 'warm' THEN 'medium'\n        ELSE 'low'\n    END,\n    updated_at = NOW()\nWHERE em.email = '{{ $items('ğŸ“¤Pass Monitoring Data')[0].json.email }}';\n\nSELECT 'Updated' as status;",
        "options": {}
      },
      "id": "4e9f17ca-f964-4521-8b21-bd6fa07652bc",
      "name": "ğŸ“ˆUpdate Metrics After Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        496
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ\nconst currentData = $json; // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ ÑƒĞ·Ğ»Ğ° (Update Metrics After Analysis)\n\nreturn [{\n  json: {\n    status: 'processing_completed',\n    email: currentData.email || 'unknown',\n    processed: true,\n    completedAt: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        496
      ],
      "id": "7ff13fe4-f3ab-4e33-b92f-9db7e5f23da5",
      "name": "âœ…Complete Outgoing"
    }
  ],
  "pinData": {},
  "connections": {
    "âš™ï¸ CONFIG": {
      "main": [
        [
          {
            "node": "ğŸ“¥Get Recent Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥Get Recent Emails": {
      "main": [
        [
          {
            "node": "ğŸ“‹Extract Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹Extract Email Data": {
      "main": [
        [
          {
            "node": "ğŸ”Check Processed Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â°Check Every 10 Minutes": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”Check Processed Emails": {
      "main": [
        [
          {
            "node": "ğŸ”„Restore Email Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„Restore Email Data1": {
      "main": [
        [
          {
            "node": "â“Is New Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“Is New Email?": {
      "main": [
        [
          {
            "node": "ğŸ“ Log Email Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Log Email Processing": {
      "main": [
        [
          {
            "node": "ğŸ”„ Restore for Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Restore for Save": {
      "main": [
        [
          {
            "node": "ğŸ“¦Prepare Save Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦Prepare Save Data": {
      "main": [
        [
          {
            "node": "ğŸ’¾Save Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾Save Conversation": {
      "main": [
        [
          {
            "node": "ğŸ”„Restore Email Data for Monitoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„Restore Email Data for Monitoring": {
      "main": [
        [
          {
            "node": "ğŸ“ŠSave to Email Monitoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ŠSave to Email Monitoring": {
      "main": [
        [
          {
            "node": "ğŸ“¤Pass Monitoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤Pass Monitoring Data": {
      "main": [
        [
          {
            "node": "ğŸ”Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "â³Wait 1 sec",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³Wait 1 sec": {
      "main": [
        [
          {
            "node": "ğŸ“Call Extract Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Call Extract Contacts": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Pass Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Pass Result": {
      "main": [
        [
          {
            "node": "â³Wait 2 sec",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³Wait 2 sec": {
      "main": [
        [
          {
            "node": "ğŸ§ Call Analyze Dialog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§ Call Analyze Dialog": {
      "main": [
        [
          {
            "node": "ğŸ“ˆUpdate Metrics After Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆUpdate Metrics After Analysis": {
      "main": [
        [
          {
            "node": "âœ…Complete Outgoing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ…Complete Outgoing": {
      "main": [
        [
          {
            "node": "ğŸ”Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e757c233-c30b-47fb-9bea-d9c79d2f8dbb",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "QtELtcLpm0G1lSXS",
  "tags": []
}