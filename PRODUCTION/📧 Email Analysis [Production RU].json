{
  "name": "ğŸ“§ Email Analysis [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“§ Email Analysis - ĞĞ½Ğ°Ğ»Ğ¸Ğ· Email Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²\n\n### ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nĞ­Ñ‚Ğ¾Ñ‚ workflow Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ email-Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºÑƒ Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI.\nĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½, Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, ÑƒĞ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸\nĞ¸ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸. Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Lead Scoring.\n\n---\n\n### ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n\n1. **ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ ÑƒĞ·ĞµĞ» `âš™ï¸ CONFIG`** Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ:\n   - `api_key` â€” Ğ²Ğ°Ñˆ API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ endpoint\n   - `rate_limit_window_ms` â€” Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ rate limiting (Ğ¼Ñ)\n   - `rate_limit_max_requests` â€” Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¾ĞºĞ½Ğµ\n   - ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ† PostgreSQL\n\n2. **ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ PostgreSQL** credential Ğº ÑƒĞ·Ğ»Ğ°Ğ¼ Ğ‘Ğ”\n\n3. **ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Google Gemini API** credential\n\n4. **ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ workflow**\n\n---\n\n### ğŸ“¡ API Endpoint\n\n**POST** `/webhook/analyze-email-dialog`\n\n**Headers:**\n```\nContent-Type: application/json\nx-api-key: Ğ²Ğ°Ñˆ_api_key\n```\n\n**Body:**\n```json\n{\n  \"type\": \"single\",\n  \"email\": \"client@example.com\",\n  \"threadId\": \"thread_123\",\n  \"language\": \"ru\",\n  \"userName\": \"Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²\"\n}\n```\n\n**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**\n- `type` â€” Ñ‚Ğ¸Ğ¿ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: `single` (Ğ¾Ğ´Ğ¸Ğ½ email) Ğ¸Ğ»Ğ¸ `all` (Ğ²ÑĞµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸)\n- `email` â€” email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n- `language` â€” ÑĞ·Ñ‹Ğº Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²\n\n---\n\n### ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n\n```json\n{\n  \"emotionalTone\": {\n    \"overall\": \"positive/negative/neutral\",\n    \"satisfaction\": 85\n  },\n  \"customerNeeds\": [\"...\"],\n  \"missedOpportunities\": [\"...\"],\n  \"recommendations\": [\"...\"],\n  \"leadScoring\": {\n    \"score\": 75,\n    \"temperature\": \"warm\"\n  }\n}\n```"
      },
      "id": "sticky-note-instructions",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2300,
        0
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-language-settings",
              "name": "table_analysis_language_settings",
              "value": "analysis_language_settings",
              "type": "string"
            },
            {
              "id": "table-dialog-analysis",
              "name": "table_email_dialog_analysis",
              "value": "email_dialog_analysis",
              "type": "string"
            },
            {
              "id": "table-conversations",
              "name": "table_gmail_conversations",
              "value": "gmail_conversations",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "config-node",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2080,
        304
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "analyze-email-dialog",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "01d39500-672d-41c3-a8e2-221b55d1ffd1",
      "name": "ğŸŒ Webhook: Analyze Email",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1888,
        304
      ],
      "webhookId": "analyze-email-dialog-webhook"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// ğŸ” Ğ£ĞĞ˜Ğ’Ğ•Ğ Ğ¡ĞĞ›Ğ¬ĞĞĞ¯ Ğ—ĞĞ©Ğ˜Ğ¢Ğ: API KEY + RATE LIMITING\n// ============================================\n\n// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· CONFIG\nconst config = $('âš™ï¸ CONFIG').first().json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Analyze Email').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1728,
        304
      ],
      "id": "4be98bc3-982f-4bd3-914e-3ecd5c00c338",
      "name": "ğŸ” Security Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1552,
        304
      ],
      "id": "2123dfe0-4144-4331-879e-3f1ca7bf0ab4",
      "name": "ğŸ”€ Auth Check"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1344,
        464
      ],
      "id": "25607d76-07a2-4e06-b6fd-33daf46cf796",
      "name": "âŒ Error Response"
    },
    {
      "parameters": {
        "jsCode": "// Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°\nconst data = $('ğŸŒ Webhook: Analyze Email').item.json.body || $('ğŸŒ Webhook: Analyze Email').item.json;\n\nconst analysisType = data.type || 'single';\nconst email = data.email;\nconst threadId = data.threadId;\nconst language = data.language;\n\nreturn [{\n    json: {\n        type: analysisType,\n        email: email,\n        threadId: threadId,\n        language: language,\n        userName: data.userName\n    }\n}];"
      },
      "id": "edfd5978-d604-4a74-a0ab-70dd7ea5883c",
      "name": "ğŸ“¥ Process Analysis Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1344,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ·Ñ‹Ğº Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº\nSELECT language_code \nFROM {{ $('âš™ï¸ CONFIG').first().json.table_analysis_language_settings }} \nORDER BY id DESC \nLIMIT 1;",
        "options": {}
      },
      "id": "f9c099c4-6342-465f-a65f-01b77685f46c",
      "name": "ğŸ“‹ Get Analysis Language",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1168,
        288
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… ÑƒĞ·Ğ»Ğ¾Ğ²\nconst requestData = $('ğŸ“¥ Process Analysis Request').first().json;\nconst langSetting = items[0]?.json?.language_code || 'ru';\n\n// ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ñ ÑĞ·Ñ‹ĞºĞ¾Ğ¼ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\nreturn [{\n    json: {\n        type: requestData.type,\n        email: requestData.email,\n        threadId: requestData.threadId,\n        language: requestData.language,\n        userName: requestData.userName,\n        analysisLanguage: langSetting\n    }\n}];"
      },
      "id": "fd3f462c-a5c0-4339-9b2e-3d3d0a149bfe",
      "name": "ğŸ”„ Merge with Language",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğµ email ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·\nWITH last_analysis AS (\n    SELECT \n        email,\n        updated_at as analysis_date,\n        emotional_tone,\n        customer_needs,\n        missed_opportunities,\n        recommendations,\n        lead_scoring,\n        statistics,\n        satisfaction_percentage\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_email_dialog_analysis }}\n    WHERE email = '{{ $('ğŸ”„ Merge with Language').first().json.email }}'\n    ORDER BY updated_at DESC\n    LIMIT 1\n),\nconversation_data AS (\n    SELECT \n        email,\n        updated_at as conversation_updated,\n        message_count\n    FROM {{ $('âš™ï¸ CONFIG').first().json.table_gmail_conversations }}\n    WHERE email = '{{ $('ğŸ”„ Merge with Language').first().json.email }}'\n    ORDER BY updated_at DESC\n    LIMIT 1\n)\nSELECT \n    COALESCE(cd.email, '{{ $('ğŸ”„ Merge with Language').first().json.email }}') as email,\n    cd.conversation_updated,\n    cd.message_count,\n    la.analysis_date as last_analysis_date,\n    CASE \n        WHEN cd.conversation_updated IS NULL THEN false\n        WHEN la.analysis_date IS NULL THEN true\n        WHEN cd.conversation_updated > la.analysis_date THEN true \n        ELSE false \n    END as has_new_messages,\n    la.emotional_tone as prev_emotional_tone,\n    la.customer_needs as prev_customer_needs,\n    la.missed_opportunities as prev_missed_opportunities,\n    la.recommendations as prev_recommendations,\n    la.lead_scoring as prev_lead_scoring,\n    la.statistics as prev_statistics,\n    la.satisfaction_percentage as prev_satisfaction\nFROM conversation_data cd\nFULL OUTER JOIN last_analysis la ON true;",
        "options": {}
      },
      "id": "ea5d5b04-d3cb-4f6a-bc2c-8f51be47b982",
      "name": "ğŸ” Check New Messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -832,
        288
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞœĞµÑ€Ğ¶Ğ¸Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Check for New Email Messages Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· Merge with Language\nconst checkResult = items[0].json;\nconst mergedData = $('ğŸ”„ Merge with Language').first().json;\n\n// ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSONB Ğ¿Ğ¾Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\nconst parseJsonField = (field) => {\n    if (!field) return null;\n    if (typeof field === 'string') {\n        try {\n            return JSON.parse(field);\n        } catch (e) {\n            return field;\n        }\n    }\n    return field;\n};\n\n// Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\nconst previousAnalysis = checkResult.last_analysis_date ? {\n    emotionalTone: parseJsonField(checkResult.prev_emotional_tone),\n    customerNeeds: parseJsonField(checkResult.prev_customer_needs),\n    missedOpportunities: parseJsonField(checkResult.prev_missed_opportunities),\n    recommendations: parseJsonField(checkResult.prev_recommendations),\n    leadScoring: parseJsonField(checkResult.prev_lead_scoring),\n    statistics: parseJsonField(checkResult.prev_statistics),\n    satisfaction: checkResult.prev_satisfaction,\n    analysisDate: checkResult.last_analysis_date\n} : null;\n\nreturn [{\n    json: {\n        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Merge with Language\n        type: mergedData.type,\n        email: mergedData.email,\n        threadId: mergedData.threadId,\n        language: mergedData.language,\n        userName: mergedData.userName,\n        analysisLanguage: mergedData.analysisLanguage,\n        \n        // Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Check for New Email Messages\n        has_new_messages: checkResult.has_new_messages,\n        conversation_updated: checkResult.conversation_updated,\n        last_analysis_date: checkResult.last_analysis_date,\n        message_count: checkResult.message_count,\n        \n        // ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ² AI\n        previousAnalysis: previousAnalysis\n    }\n}];"
      },
      "id": "b3a1265f-5420-4d97-9cf5-5331da40bf6a",
      "name": "ğŸ”€ Merge Check Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-new-email-messages",
              "leftValue": "={{ $json.has_new_messages }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ca5a0d73-2f35-480e-af52-bf23a60b5dc6",
      "name": "ğŸ”€ Has New Messages?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -416,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· email\nSELECT \n    email,\n    analysis_type,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    lead_scoring,\n    statistics,\n    satisfaction_percentage,\n    created_at,\n    updated_at\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_email_dialog_analysis }}\nWHERE email = '{{ $('ğŸ”€ Merge Check Data').first().json.email }}'\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "3be2e34c-477e-4369-bada-82dcad647219",
      "name": "ğŸ“‹ Get Existing Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -208,
        512
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· email Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ°\nconst existingAnalysis = items[0].json;\nconst checkData = $('ğŸ”€ Merge Check Data').first().json;\n\n// ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSONB Ğ¿Ğ¾Ğ»Ñ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¸\nconst parseJsonField = (field) => {\n    if (!field) return null;\n    if (typeof field === 'string') {\n        try {\n            return JSON.parse(field);\n        } catch (e) {\n            return field;\n        }\n    }\n    return field;\n};\n\nreturn [{\n    json: {\n        // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n        emotionalTone: parseJsonField(existingAnalysis.emotional_tone),\n        customerNeeds: parseJsonField(existingAnalysis.customer_needs),\n        missedOpportunities: parseJsonField(existingAnalysis.missed_opportunities),\n        recommendations: parseJsonField(existingAnalysis.recommendations),\n        leadScoring: parseJsonField(existingAnalysis.lead_scoring),\n        statistics: parseJsonField(existingAnalysis.statistics),\n        \n        // Email Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€\n        email: existingAnalysis.email || checkData.email,\n        \n        // ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n        _cached: true,\n        _lastAnalysisDate: checkData.last_analysis_date,\n        _conversationUpdated: checkData.conversation_updated,\n        _messageCount: checkData.message_count\n    }\n}];"
      },
      "id": "e3816139-e0d0-4bc4-ac17-23022dcbb0fb",
      "name": "ğŸ“ Format Existing Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        512
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "2c8b3358-1943-43bd-abfc-4be44472ce4a",
      "name": "ğŸ“¤ Return Cached Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        208,
        512
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.type }}",
              "rightValue": "single",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "id": "single-analysis-check"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "75c2e9fd-dcb0-44e3-9829-4bad1a97239a",
      "name": "ğŸ”€ Analysis Type?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -208,
        96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ email Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·)\nSELECT \n    gc.email,\n    gc.thread_id,\n    gc.subject,\n    gc.messages,\n    gc.status,\n    gc.lead_score,\n    gc.language,\n    gc.message_count,\n    gc.created_at,\n    gc.updated_at,\n    '{{ $('ğŸ”€ Merge Check Data').first().json.last_analysis_date }}' as last_analysis_date\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_gmail_conversations }} gc\nWHERE gc.email = '{{ $('ğŸ”€ Merge Check Data').first().json.email }}'\nORDER BY gc.updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "6d81e7db-4c56-474a-9927-373aa6a23d53",
      "name": "ğŸ“§ Get Single Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ email Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\nSELECT \n    gc.email,\n    gc.thread_id,\n    gc.subject,\n    gc.messages,\n    gc.status,\n    gc.lead_score,\n    gc.language,\n    gc.message_count,\n    gc.created_at,\n    gc.updated_at,\n    '{{ $('ğŸ”€ Merge Check Data').first().json.last_analysis_date }}' as last_analysis_date\nFROM {{ $('âš™ï¸ CONFIG').first().json.table_gmail_conversations }} gc\nWHERE \n    gc.created_at >= NOW() - INTERVAL '30 days'\n    {{ $('ğŸ”€ Merge Check Data').first().json.language ? \"AND gc.language = '\" + $('ğŸ”€ Merge Check Data').first().json.language + \"'\" : \"\" }}\nORDER BY gc.updated_at DESC;",
        "options": {}
      },
      "id": "4e033833-ef48-4c6f-a0d0-ec6fb19e7c2e",
      "name": "ğŸ“§ Get All Dialogs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        192
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ email Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\nconst dialogs = items;\nconst mergedData = $('ğŸ”€ Merge Check Data').first().json;\nconst analysisType = mergedData.type;\nconst analysisLanguage = mergedData.analysisLanguage || 'ru';\nconst lastAnalysisDate = mergedData.last_analysis_date;\nconst previousAnalysis = mergedData.previousAnalysis;\n\n// Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ email\nconst emailDialogs = {};\n\ndialogs.forEach(item => {\n    const data = item.json;\n    const email = data.email;\n    \n    if (!emailDialogs[email]) {\n        // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ messages\n        let messages = [];\n        try {\n            messages = typeof data.messages === 'string' \n                ? JSON.parse(data.messages) \n                : data.messages || [];\n        } catch (e) {\n            messages = [];\n        }\n        \n        // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· - Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞĞĞ’Ğ«Ğ• ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ\n        let filteredMessages = messages;\n        let allMessages = messages;\n        \n        if (lastAnalysisDate && lastAnalysisDate !== 'null' && lastAnalysisDate !== '') {\n            const lastAnalysisTime = new Date(lastAnalysisDate).getTime();\n            filteredMessages = messages.filter(msg => {\n                const msgTime = new Date(msg.date).getTime();\n                return msgTime > lastAnalysisTime;\n            });\n        }\n        \n        emailDialogs[email] = {\n            email: email,\n            threadId: data.thread_id,\n            subject: data.subject,\n            language: data.language,\n            messageCount: data.message_count || messages.length,\n            newMessageCount: filteredMessages.length,\n            leadScore: data.lead_score,\n            messages: filteredMessages,\n            allMessages: allMessages\n        };\n    }\n});\n\n// ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ AI Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑĞ·Ñ‹ĞºĞ°\nconst dialogsForAnalysis = Object.values(emailDialogs).map((dialog) => {\n    // Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼ĞµÑ‚ĞºĞ¸ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑĞ·Ñ‹ĞºĞ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n    const clientLabel = analysisLanguage === 'en' ? 'Client' : \n                        analysisLanguage === 'es' ? 'Cliente' : \n                        analysisLanguage === 'fr' ? 'Client' : \n                        analysisLanguage === 'de' ? 'Kunde' : \n                        analysisLanguage === 'it' ? 'Cliente' : \n                        analysisLanguage === 'pt' ? 'Cliente' : \n                        analysisLanguage === 'zh' ? 'å®¢æˆ·' : \n                        analysisLanguage === 'ja' ? 'é¡§å®¢' : \n                        analysisLanguage === 'ko' ? 'ê³ ê°' : \n                        analysisLanguage === 'ua' ? 'ĞšĞ»Ñ–Ñ”Ğ½Ñ‚' : \n                        'ĞšĞ»Ğ¸ĞµĞ½Ñ‚';\n    \n    const botLabel = analysisLanguage === 'en' ? 'Bot' : \n                     analysisLanguage === 'es' ? 'Bot' : \n                     analysisLanguage === 'fr' ? 'Bot' : \n                     analysisLanguage === 'de' ? 'Bot' : \n                     analysisLanguage === 'it' ? 'Bot' : \n                     analysisLanguage === 'pt' ? 'Bot' : \n                     analysisLanguage === 'zh' ? 'æœºå™¨äºº' : \n                     analysisLanguage === 'ja' ? 'ãƒœãƒƒãƒˆ' : \n                     analysisLanguage === 'ko' ? 'ë´‡' : \n                     analysisLanguage === 'ua' ? 'Ğ‘Ğ¾Ñ‚' : \n                     'Ğ‘Ğ¾Ñ‚';\n    \n    const conversation = dialog.messages.map(msg => \n        `${msg.type === 'incoming' ? clientLabel : botLabel}: ${msg.content}`\n    ).join('\\n');\n    \n    return {\n        email: dialog.email,\n        threadId: dialog.threadId,\n        subject: dialog.subject,\n        language: dialog.language,\n        conversation: conversation,\n        newMessageCount: dialog.newMessageCount,\n        totalMessageCount: dialog.allMessages.length\n    };\n});\n\n// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼, ÑÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ\nconst isUpdate = !!previousAnalysis;\n\nreturn [{\n    json: {\n        type: analysisType,\n        email: mergedData.email,\n        dialogs: dialogsForAnalysis,\n        totalDialogs: dialogsForAnalysis.length,\n        analysisLanguage: analysisLanguage,\n        isUpdate: isUpdate,\n        previousAnalysis: previousAnalysis\n    }\n}];"
      },
      "id": "40708d1b-9fc9-4a5f-9698-f7681dcc80d1",
      "name": "ğŸ“ Format Dialogs for AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        96
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Ğ¯Ğ·Ñ‹Ğº Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²: {{ $json.analysisLanguage || 'ru' }}\nĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ: Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ’Ğ¡Ğ• Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ: {{ \n  $json.analysisLanguage === 'ru' ? 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' : \n  $json.analysisLanguage === 'en' ? 'English' : \n  $json.analysisLanguage === 'es' ? 'EspaÃ±ol' : \n  $json.analysisLanguage === 'fr' ? 'FranÃ§ais' : \n  $json.analysisLanguage === 'de' ? 'Deutsch' : \n  $json.analysisLanguage === 'it' ? 'Italiano' : \n  $json.analysisLanguage === 'pt' ? 'PortuguÃªs' : \n  $json.analysisLanguage === 'zh' ? 'ä¸­æ–‡' : \n  $json.analysisLanguage === 'ja' ? 'æ—¥æœ¬èª' : \n  $json.analysisLanguage === 'ko' ? 'í•œêµ­ì–´' : \n  $json.analysisLanguage === 'ua' ? 'Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°' : \n  'Ğ ÑƒÑÑĞºĞ¸Ğ¹' \n}}\n\nĞ¢Ğ¸Ğ¿ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: {{ $json.type }}\nĞ ĞµĞ¶Ğ¸Ğ¼: {{ $json.isUpdate ? 'ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°' : 'ĞŸĞ•Ğ Ğ’Ğ˜Ğ§ĞĞ«Ğ™ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·' }}\n\n{{ $json.isUpdate && $json.previousAnalysis ? `\n========================================\nĞŸĞ Ğ•Ğ”Ğ«Ğ”Ğ£Ğ©Ğ˜Ğ™ ĞĞĞĞ›Ğ˜Ğ— (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ĞºĞ°Ğº Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ):\n========================================\n\nĞ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½: ${JSON.stringify($json.previousAnalysis.emotionalTone, null, 2)}\n\nĞŸĞ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: ${JSON.stringify($json.previousAnalysis.customerNeeds, null, 2)}\n\nĞ£Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸: ${JSON.stringify($json.previousAnalysis.missedOpportunities, null, 2)}\n\nĞ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸: ${JSON.stringify($json.previousAnalysis.recommendations, null, 2)}\n\nLead Scoring: ${JSON.stringify($json.previousAnalysis.leadScoring, null, 2)}\n\nĞ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°: ${JSON.stringify($json.previousAnalysis.statistics, null, 2)}\n\n========================================\nĞĞĞ’Ğ«Ğ• Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯ Ğ”Ğ›Ğ¯ ĞĞĞĞ›Ğ˜Ğ—Ğ:\n========================================\n` : '========================================\\nĞ”Ğ˜ĞĞ›ĞĞ“Ğ˜ Ğ”Ğ›Ğ¯ ĞŸĞ•Ğ Ğ’Ğ˜Ğ§ĞĞĞ“Ğ ĞĞĞĞ›Ğ˜Ğ—Ğ:\\n========================================\\n' }}\n\n{{ $json.dialogs.map((d, i) => `\n--- Email Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ ${i+1} (${d.email}, ${d.language}) ---\nĞ¢ĞµĞ¼Ğ°: ${d.subject}\n${ $json.isUpdate ? `ĞĞ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: ${d.newMessageCount} Ğ¸Ğ· ${d.totalMessageCount} Ğ¾Ğ±Ñ‰Ğ¸Ñ…` : `Ğ’ÑĞµĞ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: ${d.totalMessageCount}` }\n\n${d.conversation}`).join('\\n\\n') }}",
        "options": {
          "systemMessage": "=#Ğ Ğ¾Ğ»ÑŒ: Ğ’Ñ‹ â€” ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñƒ email-Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸ĞµĞ¹ Cryptomator.\n\n---\n\n# ğŸ”´ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ - Ğ¯Ğ—Ğ«Ğš Ğ’Ğ«Ğ’ĞĞ”Ğ\n\n**Ğ’Ğ¡Ğ• Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ”ĞĞ›Ğ–ĞĞ« Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ, ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ² \"Ğ¯Ğ·Ñ‹Ğº Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²\"!**\n\nĞ­Ñ‚Ğ¾ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚:\n- Ğ’ÑĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ² emotionalTone (overall, overallText, description)\n- Ğ’Ğ¡Ğ• ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¼Ğ°ÑÑĞ¸Ğ²Ğ¾Ğ² customerNeeds, missedOpportunities, recommendations\n- Ğ’ÑĞµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² leadScoring (recommendation)\n- Ğ’ÑĞµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² statistics\n\n**ĞĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ Ğ¾Ñ‚ ÑĞ·Ñ‹ĞºĞ° Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ², Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°!**\n\n---\n\n# ğŸ”„ Ğ Ğ•Ğ–Ğ˜Ğœ Ğ ĞĞ‘ĞĞ¢Ğ«\n\n## Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:\n1. **Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ°Ğº Ğ±Ğ°Ğ·Ñƒ** â€” Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ğ¹ Ñ Ğ½ÑƒĞ»Ñ\n2. **ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞĞĞ’Ğ«Ğ• ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ** â€” Ğ¾Ğ½Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾\n3. **ĞĞ‘ĞĞĞ’Ğ˜ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ** Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸:\n   - Lead Score Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ²Ñ‹ÑĞ¸Ñ‚ÑŒÑÑ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ‚ÑŒÑÑ\n   - ĞœĞ¾Ğ³ÑƒÑ‚ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ (Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğº ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼)\n   - Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒÑÑ\n   - Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ\n4. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞ¹ Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½ÑƒÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ** â€” Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑĞ¹ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n5. **ĞÑ‚Ğ¼ĞµÑ‡Ğ°Ğ¹ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ** â€” ĞµÑĞ»Ğ¸ Lead Score Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ, Ğ¾Ñ‚Ñ€Ğ°Ğ·Ğ¸ ÑÑ‚Ğ¾ Ğ² recommendation\n\n## Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ ĞŸĞ•Ğ Ğ’Ğ˜Ğ§ĞĞ«Ğ™ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·:\n- ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ²ĞµÑÑŒ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ Ğ½ÑƒĞ»Ñ\n- Ğ¡Ğ»ĞµĞ´ÑƒĞ¹ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n\n---\n\n#Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ email-Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ¸ Ğ¾Ñ†ĞµĞ½Ğ¸Ñ‚ÑŒ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ, Ğ²Ñ‹ÑĞ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ², Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ ÑƒĞ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶ Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ.\n\n#ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:\n\n1. **Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸**:\n   - ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½ (Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹, Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹, Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)\n   - ĞÑ†ĞµĞ½Ğ¸Ñ‚Ğµ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑƒĞ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° (0-100%)\n   - ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºÑƒ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¹ Ğ² Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğµ\n\n2. **Ğ’Ñ‹ÑĞ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°**:\n   - ĞŸĞµÑ€ĞµÑ‡Ğ¸ÑĞ»Ğ¸Ñ‚Ğµ ÑĞ²Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹\n   - ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ñ‡Ğ°ÑÑ‚Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹\n   - Ğ’Ñ‹ÑĞ²Ğ¸Ñ‚Ğµ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸\n\n3. **Ğ£Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶**:\n   - Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚Ğµ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹\n   - Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½ĞµÑ€ĞµÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹\n   - ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¸ Ğ½ĞµĞ¿Ğ¾Ğ»Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²\n\n4. **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ**:\n   - ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²\n   - Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞ¹Ñ‚Ğµ Ñ‚ĞµĞ¼Ñ‹ Ğ´Ğ»Ñ follow-up\n   - Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğµ\n\n# Lead Scoring Ğ´Ğ»Ñ Email (0-100 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²):\n\n## ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ¾Ñ†ĞµĞ½ĞºĞ¸:\n\n### 1. Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ñ‚Ğ¾Ğ½ (0-25 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²)\n- 20-25: ĞÑ‡ĞµĞ½ÑŒ Ğ´Ğ¾Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚, Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½\n- 15-19: Ğ£Ğ´Ğ¾Ğ²Ğ»ĞµÑ‚Ğ²Ğ¾Ñ€ĞµĞ½, Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾-Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹\n- 10-14: ĞĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹\n- 5-9: Ğ•ÑÑ‚ÑŒ Ğ½ĞµĞ´Ğ¾Ğ²Ğ¾Ğ»ÑŒÑÑ‚Ğ²Ğ¾\n- 0-4: Ğ¯Ğ²Ğ½Ğ¾Ğµ Ğ½ĞµĞ´Ğ¾Ğ²Ğ¾Ğ»ÑŒÑÑ‚Ğ²Ğ¾\n\n### 2. ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (0-20 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²)\n- ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ² Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸: +5\n- Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ: +5\n- ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: +5\n- Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ² Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸: +5\n\n### 3. ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ²Ğ¾Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ (0-15 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²)\n- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°\n- Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²\n- Ğ”Ğ»Ğ¸Ğ½Ğ° Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¸ÑĞµĞ¼\n- Ğ—Ğ°Ğ´Ğ°ĞµÑ‚ ÑƒÑ‚Ğ¾Ñ‡Ğ½ÑÑÑ‰Ğ¸Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹\n\n### 4. ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ (0-25 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²)\n- ĞŸÑ€ÑĞ¼Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ†ĞµĞ½Ğµ: +10\n- Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ğµ: +5\n- Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´ĞµĞ¼Ğ¾/Ğ¿Ñ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸: +10\n- Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸: +5\n\n### 5. Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ (0-15 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²)\n- \"Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾\": 15\n- \"Ğ’ ÑÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑÑÑ†Ğµ\": 10\n- \"ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµĞ¼\": 5\n- \"ĞœĞ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ\": 2\n\n## Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ»Ğ¸Ğ´Ğ°:\n- **hot**: 80-100 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²\n- **warm**: 50-79 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²\n- **cold**: 0-49 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²\n\n---\n\n#Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° - Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ JSON Ğ±ĞµĞ· markdown:\n{\n  \"emotionalTone\": {\n    \"overall\": \"positive/negative/neutral\",\n    \"overallText\": \"ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ½Ğ°\",\n    \"satisfaction\": Ñ‡Ğ¸ÑĞ»Ğ¾ (0-100),\n    \"description\": \"Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ¸\"\n  },\n  \"customerNeeds\": [\"ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚ĞµĞ¹\"],\n  \"missedOpportunities\": [\"ÑĞ¿Ğ¸ÑĞ¾Ğº ÑƒĞ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ñ… Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹\"],\n  \"recommendations\": [\"ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¹\"],\n  \"statistics\": {\n    \"totalDialogs\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n    \"avgSatisfaction\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n    \"resolvedPercentage\": Ñ‡Ğ¸ÑĞ»Ğ¾\n  },\n  \"leadScoring\": {\n    \"score\": Ñ‡Ğ¸ÑĞ»Ğ¾ (0-100),\n    \"temperature\": \"hot/warm/cold\",\n    \"factors\": {\n      \"satisfaction\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n      \"contacts\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n      \"engagement\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n      \"intentions\": Ñ‡Ğ¸ÑĞ»Ğ¾,\n      \"urgency\": Ñ‡Ğ¸ÑĞ»Ğ¾\n    },\n    \"recommendation\": \"Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ Ñ Ğ»Ğ¸Ğ´Ğ¾Ğ¼\"\n  }\n}\n\n---\n\n# Ğ’ĞĞ–ĞĞ\n\n1. **ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ:** Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚Ğµ Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ JSON Ğ±ĞµĞ· markdown, Ñ‚Ñ€Ğ¾Ğ¹Ğ½Ñ‹Ñ… ĞºĞ°Ğ²Ñ‹Ñ‡ĞµĞº Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°!\n\n2. **Ğ¯Ğ·Ñ‹Ğº Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:** Ğ’Ğ¡Ğ• Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ, ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ² \"Ğ¯Ğ·Ñ‹Ğº Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²\", Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ Ğ¾Ñ‚ ÑĞ·Ñ‹ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸!\n\n3. **ĞŸÑ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸:** Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ â€” ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ğ¹ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·, Ğ½Ğµ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞ¹ ĞµĞ³Ğ¾!\n\n4. **Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸:** ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼, Ğ½Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¼\n\n5. **ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ ÑĞ»Ğ¾Ğ²:** Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ñ‹Ğµ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹ Ñ‡Ğ°ÑÑ‚Ğ¾ ÑĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑ"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        416,
        96
      ],
      "id": "416e21fb-86d4-4027-8b2e-691ace79ff85",
      "name": "ğŸ¤– Email AI Agent"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        336,
        304
      ],
      "id": "f76a2136-6889-448a-ae3f-079718493e2d",
      "name": "ğŸ§  Google Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "abo0BDHSJPM0pgRU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ AI Ğ°Ğ³ĞµĞ½Ñ‚Ğ°\nconst aiResponse = items[0].json;\nconst mergedData = $('ğŸ”€ Merge Check Data').first().json;\n\nlet responseText = '';\nlet parsedResponse = null;\n\n// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°\nif (aiResponse.output) {\n    responseText = aiResponse.output;\n} else if (aiResponse.text) {\n    responseText = aiResponse.text;\n} else if (typeof aiResponse === 'string') {\n    responseText = aiResponse;\n} else if (aiResponse.emotionalTone) {\n    parsedResponse = aiResponse;\n}\n\n// ĞŸĞ°Ñ€ÑĞ¸Ğ¼ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ‚ĞµĞºÑÑ‚\nif (!parsedResponse && responseText) {\n    let cleanJson = responseText.trim();\n    \n    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ markdown\n    if (cleanJson.startsWith('```json')) {\n        cleanJson = cleanJson.substring(7);\n    } else if (cleanJson.startsWith('```')) {\n        cleanJson = cleanJson.substring(3);\n    }\n    if (cleanJson.endsWith('```')) {\n        cleanJson = cleanJson.substring(0, cleanJson.length - 3);\n    }\n    cleanJson = cleanJson.trim();\n    \n    // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° 1: Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³\n    try {\n        parsedResponse = JSON.parse(cleanJson);\n    } catch (e1) {\n        // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° 2: Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ JSON\n        try {\n            const firstBrace = cleanJson.indexOf('{');\n            const lastBrace = cleanJson.lastIndexOf('}');\n            if (firstBrace !== -1 && lastBrace > firstBrace) {\n                parsedResponse = JSON.parse(cleanJson.substring(firstBrace, lastBrace + 1));\n            }\n        } catch (e2) {\n            // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° 3: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° escape\n            try {\n                let fixedJson = cleanJson;\n                if (fixedJson.startsWith('\"') && fixedJson.endsWith('\"')) {\n                    fixedJson = fixedJson.slice(1, -1);\n                }\n                fixedJson = fixedJson.replace(/\\\\\\\\n/g, '\\\\n').replace(/\\\\\\\\t/g, '\\\\t');\n                const fb = fixedJson.indexOf('{');\n                const lb = fixedJson.lastIndexOf('}');\n                if (fb !== -1 && lb > fb) {\n                    parsedResponse = JSON.parse(fixedJson.substring(fb, lb + 1));\n                }\n            } catch (e3) {}\n        }\n    }\n}\n\n// Fallback Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ\nif (!parsedResponse) {\n    parsedResponse = {\n        emotionalTone: { overall: 'neutral', overallText: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°', satisfaction: 50, description: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° AI' },\n        customerNeeds: ['Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·'],\n        missedOpportunities: ['Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹'],\n        recommendations: ['ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·'],\n        statistics: { totalDialogs: 1, avgSatisfaction: 50, resolvedPercentage: 0 },\n        leadScoring: { score: 0, temperature: 'cold', factors: { satisfaction: 0, contacts: 0, engagement: 0, intentions: 0, urgency: 0 }, recommendation: 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·' }\n    };\n}\n\nparsedResponse.email = mergedData.email;\n\nreturn [{ json: parsedResponse }];"
      },
      "id": "7c2e185b-10af-439e-a4f7-adb155c0c00f",
      "name": "ğŸ“Š Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        96
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "f558a9da-8986-4ba4-af6a-78f23e2f1e98",
      "name": "ğŸ“¤ Send Analysis Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1008,
        16
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° email (Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ ĞºĞ°Ğº JSONB)\nINSERT INTO {{ $('âš™ï¸ CONFIG').first().json.table_email_dialog_analysis }} (\n    email,\n    analysis_type,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    lead_scoring,\n    statistics,\n    satisfaction_percentage,\n    created_at\n) VALUES (\n    '{{ $json.email }}',\n    'single',\n    $js${{ JSON.stringify($json.emotionalTone) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.customerNeeds) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.missedOpportunities) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.recommendations) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.leadScoring) }}$js$::jsonb,\n    $js${{ JSON.stringify($json.statistics) }}$js$::jsonb,\n    {{ $json.emotionalTone?.satisfaction || $json.statistics?.avgSatisfaction || 0 }},\n    NOW()\n)\nON CONFLICT (email) DO UPDATE SET\n    emotional_tone = EXCLUDED.emotional_tone,\n    customer_needs = EXCLUDED.customer_needs,\n    missed_opportunities = EXCLUDED.missed_opportunities,\n    recommendations = EXCLUDED.recommendations,\n    lead_scoring = EXCLUDED.lead_scoring,\n    statistics = EXCLUDED.statistics,\n    satisfaction_percentage = EXCLUDED.satisfaction_percentage,\n    updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1008,
        208
      ],
      "id": "0b1c331e-a02d-43a5-9fac-c2875931e75d",
      "name": "ğŸ’¾ Save Analysis",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "âš™ï¸ CONFIG": {
      "main": [
        [
          {
            "node": "ğŸŒ Webhook: Analyze Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Webhook: Analyze Email": {
      "main": [
        [
          {
            "node": "ğŸ” Security Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Security Check": {
      "main": [
        [
          {
            "node": "ğŸ”€ Auth Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Auth Check": {
      "main": [
        [
          {
            "node": "ğŸ“¥ Process Analysis Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Process Analysis Request": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Get Analysis Language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Get Analysis Language": {
      "main": [
        [
          {
            "node": "ğŸ”„ Merge with Language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Merge with Language": {
      "main": [
        [
          {
            "node": "ğŸ” Check New Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Check New Messages": {
      "main": [
        [
          {
            "node": "ğŸ”€ Merge Check Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Merge Check Data": {
      "main": [
        [
          {
            "node": "ğŸ”€ Has New Messages?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Has New Messages?": {
      "main": [
        [
          {
            "node": "ğŸ”€ Analysis Type?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“‹ Get Existing Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Get Existing Analysis": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Existing Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Existing Analysis": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Return Cached Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Analysis Type?": {
      "main": [
        [
          {
            "node": "ğŸ“§ Get Single Dialog",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“§ Get All Dialogs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Get Single Dialog": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Dialogs for AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Get All Dialogs": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Dialogs for AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Dialogs for AI": {
      "main": [
        [
          {
            "node": "ğŸ¤– Email AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Email AI Agent": {
      "main": [
        [
          {
            "node": "ğŸ“Š Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Google Gemini": {
      "ai_languageModel": [
        [
          {
            "node": "ğŸ¤– Email AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Parse AI Response": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Analysis Result",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ’¾ Save Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "53710e37-b733-4ec5-b381-66161fd724dc",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "xPxOYs0EDQVVEd0R",
  "tags": []
}
