{
  "name": "ğŸ“§ Email Automation Main_2 [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“§ Email Automation Main - Ğ§Ğ°ÑÑ‚ÑŒ 2\n\n### ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½Ğ° Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ email.\nĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½ĞµĞ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI.\n\n---\n\n### ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n\n1. **ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ ÑƒĞ·ĞµĞ» `âš™ï¸ CONFIG`** Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ:\n   - `telegram_chat_id` â€” ID Ñ‡Ğ°Ñ‚Ğ° Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹\n   - `table_gmail_conversations` â€” Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸\n   - `google_sheets_id` â€” ID Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ñ Ğ±Ğ°Ğ·Ğ¾Ğ¹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹\n\n2. **ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ credentials:**\n   - PostgreSQL\n   - Gmail OAuth2\n   - Google Sheets OAuth2\n   - Telegram Bot\n   - Google Gemini API\n\n3. **ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»** Ğ² Schedule Trigger\n\n4. **ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ workflow**\n\n---\n\n### âš™ï¸ Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ ÑÑ‚Ğ° Ñ‡Ğ°ÑÑ‚ÑŒ:\n- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ½ĞµĞ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ğ¸Ğ· Gmail\n- Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ noreply Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°\n- Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸ Ğ¸Ğ· Ğ‘Ğ”\n- Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ AI (Gemini)\n- ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· Gmail\n- ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ ĞºĞ°Ğº Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ğ¾Ğµ\n- Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµÑ‚ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğ² Telegram"
      },
      "id": "sticky-note-instructions",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-18600, -3600]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "telegram-chat", "name": "telegram_chat_id", "value": "-1002588885971", "type": "string"},
            {"id": "table-conversations", "name": "table_gmail_conversations", "value": "gmail_conversations", "type": "string"},
            {"id": "sheets-id", "name": "google_sheets_id", "value": "17jog8YLtJJAolGVCLKATWsz6fVJi-aPrGxP3fKtokS4", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "config-main",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-18064, -3328]
    },
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "minutes"}]
        }
      },
      "id": "1572622e-be80-40f1-ab8f-dae4fe28f5b7",
      "name": "â° Schedule Check answer",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [-18224, -3328]
    },
    {
      "parameters": {"options": {}},
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [-17312, -3136],
      "id": "8cd378f5-d3ea-45d3-840d-49cfc1ac6355",
      "name": "ğŸ§  Gemini Model Reply",
      "credentials": {"googlePalmApi": {"id": "abo0BDHSJPM0pgRU", "name": "Google Gemini(PaLM) Api account"}}
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json;\nconst historyData = $json;\nconst clientEmail = $('ğŸ“œ Get History').first().json.email;\n\nconst retryCount = historyData.retryCount || 0;\nif (retryCount > 2) {\n  return [];\n}\n\nlet emailContent = '';\nlet shouldSendReply = true;\nlet replyData = {};\n\ntry {\n  let output = aiResponse.output;\n  \n  if (typeof output === 'string') {\n    const trimmedOutput = output.trim();\n    \n    if (trimmedOutput.startsWith('<!DOCTYPE') || trimmedOutput.startsWith('<html')) {\n      emailContent = trimmedOutput;\n    } else {\n      try {\n        const cleanJson = trimmedOutput.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n        const parsedData = JSON.parse(cleanJson);\n        \n        if (parsedData.replyData && parsedData.replyData.emailContent) {\n          emailContent = parsedData.replyData.emailContent;\n          replyData = parsedData;\n        } else if (parsedData.emailContent) {\n          emailContent = parsedData.emailContent;\n          replyData = parsedData;\n        } else {\n          if (typeof parsedData === 'string' && parsedData.includes('emailContent')) {\n            const innerParsed = JSON.parse(parsedData);\n            if (innerParsed.replyData && innerParsed.replyData.emailContent) {\n              emailContent = innerParsed.replyData.emailContent;\n              replyData = innerParsed;\n            }\n          }\n        }\n        \n        if (parsedData.shouldReply === false) {\n          shouldSendReply = false;\n        }\n        \n      } catch (parseError) {\n        if (trimmedOutput.includes('<!DOCTYPE') || trimmedOutput.includes('<html')) {\n          const htmlMatch = trimmedOutput.match(/<!DOCTYPE[\\s\\S]*<\\/html>/);\n          if (htmlMatch) {\n            emailContent = htmlMatch[0];\n          }\n        }\n      }\n    }\n  } else if (typeof output === 'object') {\n    replyData = output;\n    if (replyData.replyData && replyData.replyData.emailContent) {\n      emailContent = replyData.replyData.emailContent;\n    } else if (replyData.emailContent) {\n      emailContent = replyData.emailContent;\n    }\n  }\n  \n} catch (e) {\n  return [];\n}\n\nif (!shouldSendReply) {\n  return [];\n}\n\nif (!emailContent || !emailContent.includes('<')) {\n  return [];\n}\n\nif (!emailContent || emailContent.length < 50) {\n  return [{\n    json: {\n      needsRetry: true,\n      email: clientEmail,\n      retryCount: retryCount + 1,\n      ...historyData\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    to: clientEmail,\n    subject: $('ğŸ”„ Loop Over Items').first().json.subject,\n    emailContent: emailContent,\n    language: replyData.replyData?.language || historyData.language || 'ru',\n    attachments: replyData.replyData?.attachments || [],\n    threadId: historyData.thread_id,\n    messageId: historyData.messageId,\n    originalBody: historyData.conversation_history || '',\n    senderName: historyData.full_name || 'Client',\n    urgency: replyData.replyData?.urgency || 'medium',\n    leadScore: replyData.clientData?.leadScore || historyData.lead_score || 0,\n    intent: replyData.clientData?.intent || 'information',\n    internalNote: replyData.internalNote || '',\n    followUpDays: replyData.replyData?.followUpDays || 3\n  }\n}];"
      },
      "id": "8c17bd54-ce0f-488e-a26f-21a2250ab6c9",
      "name": "ğŸ“ Parse AI Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16944, -3328]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.emailContent }}",
        "options": {
          "appendAttribution": false,
          "senderName": "Cryptomator Team",
          "replyTo": "={{ $json.to }}"
        }
      },
      "id": "286c654d-ec93-40c0-aa20-47ee39782ebb",
      "name": "ğŸ“¤ Send Gmail Reply",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [-18208, -2992],
      "credentials": {"gmailOAuth2": {"id": "ev0cwU3ZEXqPZ9wU", "name": "Gmail account"}}
    },
    {
      "parameters": {
        "operation": "markAsRead",
        "messageId": "={{ $items('ğŸ“‹ Process Incoming')[0].json.messageId }}"
      },
      "id": "870b9ba2-f8cd-4fbd-9741-c7fb46a94760",
      "name": "âœ… Mark as Read",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [-17824, -2992],
      "credentials": {"gmailOAuth2": {"id": "ev0cwU3ZEXqPZ9wU", "name": "Gmail account"}}
    },
    {
      "parameters": {
        "jsCode": "const config = $('âš™ï¸ CONFIG').first().json;\nconst emailData = $input.first().json;\n\nfunction escapeMarkdown(text) {\n  if (!text) return '';\n  return String(text)\n    .replace(/\\\\/g, '\\\\\\\\')\n    .replace(/\\*/g, '\\\\*')\n    .replace(/_/g, '\\\\_')\n    .replace(/\\[/g, '\\\\[')\n    .replace(/\\]/g, '\\\\]')\n    .replace(/\\(/g, '\\\\(')\n    .replace(/\\)/g, '\\\\)')\n    .replace(/~/g, '\\\\~')\n    .replace(/`/g, '\\\\`')\n    .replace(/>/g, '\\\\>')\n    .replace(/#/g, '\\\\#')\n    .replace(/\\+/g, '\\\\+')\n    .replace(/-/g, '\\\\-')\n    .replace(/=/g, '\\\\=')\n    .replace(/\\|/g, '\\\\|')\n    .replace(/\\{/g, '\\\\{')\n    .replace(/\\}/g, '\\\\}')\n    .replace(/\\./g, '\\\\.')\n    .replace(/!/g, '\\\\!');\n}\n\nconst urgencyEmoji = {'high': 'ğŸ”´', 'medium': 'ğŸŸ¡', 'low': 'ğŸŸ¢'};\nconst intentEmoji = {'purchase': 'ğŸ’°', 'information': 'â„¹ï¸', 'support': 'ğŸ› ï¸', 'complaint': 'âš ï¸'};\n\nconst safeName = escapeMarkdown(emailData.senderName || emailData.to || 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚');\nconst safeEmail = escapeMarkdown(emailData.to || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½');\nconst safeSubject = escapeMarkdown(emailData.subject || 'Ğ‘ĞµĞ· Ñ‚ĞµĞ¼Ñ‹');\nconst safeNote = escapeMarkdown(emailData.internalNote || 'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½');\n\nconst message = `ğŸ“§ *ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½*\n\nğŸ‘¤ *ĞšĞ»Ğ¸ĞµĞ½Ñ‚:* ${safeName}\nğŸ“® *Email:* ${safeEmail}\nğŸ“ *Ğ¢ĞµĞ¼Ğ°:* ${safeSubject}\nğŸŒ *Ğ¯Ğ·Ñ‹Ğº:* ${emailData.language === 'ru' ? 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹' : 'ğŸ‡¬ğŸ‡§ English'}\n\n${urgencyEmoji[emailData.urgency] || 'ğŸŸ¡'} *ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚:* ${emailData.urgency || 'medium'}\n${intentEmoji[emailData.intent] || 'â„¹ï¸'} *ĞĞ°Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ:* ${emailData.intent || 'information'}\nğŸ’¯ *Lead Score:* ${emailData.leadScore || 0}/100\n\nğŸ“Œ *Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ°:* ${safeNote}\nâ° *Follow\\\\-up Ñ‡ĞµÑ€ĞµĞ·:* ${emailData.followUpDays || 3} Ğ´Ğ½ĞµĞ¹\n\n\\\\#email\\\\_reply \\\\#${emailData.language || 'ru'} \\\\#${emailData.intent || 'info'}`;\n\nreturn [{json: {message: message, chat_id: config.telegram_chat_id}}];"
      },
      "id": "faee1d99-ba25-4292-83f1-187bd5ab8e28",
      "name": "ğŸ“Š Prepare Telegram Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-17424, -2992]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {"appendAttribution": false, "parse_mode": "MarkdownV2"}
      },
      "id": "3ed45ba8-c3ef-43c2-8174-3dfa7882f957",
      "name": "ğŸ“± Notify Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [-17232, -2992],
      "credentials": {"telegramApi": {"id": "fn7ywFo6SxQJtPcU", "name": "Telegram account"}}
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ ĞŸĞ˜Ğ¡Ğ¬ĞœĞ:\n\nĞÑ‚: {{ $('ğŸ“‹ Process Incoming').item.json.from }} ({{ $('ğŸ“‹ Process Incoming').item.json.senderName }})\nĞ¢ĞµĞ¼Ğ°: {{ $('ğŸ“‹ Process Incoming').item.json.subject }}\nĞ¯Ğ·Ñ‹Ğº: {{ $('ğŸ“‹ Process Incoming').item.json.language === 'ru' ? 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' : 'English' }}\nĞ¢ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°:\n{{ $('ğŸ“‹ Process Incoming').item.json.body }}\n\nĞ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯ ĞŸĞ•Ğ Ğ•ĞŸĞ˜Ğ¡ĞšĞ˜:\n{{ $json.conversation_history || 'ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚' }}\n\nĞ”ĞĞĞĞ«Ğ• ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ:\nĞ˜Ğ¼Ñ: {{ $json.full_name || $('ğŸ“‹ Process Incoming').item.json.senderName }}\nLead Score: {{ $json.lead_score || 0 }}\nĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¸ÑĞµĞ¼: {{ $json.message_count || 0 }}",
        "options": {
          "systemMessage": "# Ğ ĞĞ›Ğ¬: Email ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Cryptomator\n\nĞ¢Ñ‹ - Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°Ğ¼ Cryptomator. ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ğ¿Ğ¸ÑÑŒĞ¼Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾.\n\n# Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Google Sheets Tool Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.\n\n## ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ:\n1. Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ°\n2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¸Ğ¼Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, ĞµÑĞ»Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾\n3. Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸\n\n## JSON ĞĞ¢Ğ’Ğ•Ğ¢:\n```json\n{\n  \"shouldReply\": true,\n  \"replyData\": {\n    \"subject\": \"Re: Ñ‚ĞµĞ¼Ğ°\",\n    \"emailContent\": \"HTML Ğ¿Ğ¸ÑÑŒĞ¼Ğ°\",\n    \"language\": \"ru/en\",\n    \"urgency\": \"medium\",\n    \"followUpDays\": 3\n  },\n  \"clientData\": {\n    \"leadScore\": 0-100,\n    \"intent\": \"information/purchase/support\",\n    \"readyToBuy\": true/false\n  },\n  \"internalNote\": \"Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ°\"\n}\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [-17248, -3328],
      "id": "73500c31-7ce1-40da-9602-37fe97aa7456",
      "name": "ğŸ¤– Gmail Reply Agent"
    },
    {
      "parameters": {
        "operation": "getAll",
        "limit": 10,
        "filters": {
          "labelIds": ["UNREAD"],
          "q": "is:unread newer_than:3d -from:noreply -from:no-reply -from:donotreply"
        }
      },
      "id": "b92e9497-2df9-48e4-b50f-e4c09e34d59c",
      "name": "ğŸ“¬ Get Unread Emails",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [-17840, -3328],
      "credentials": {"gmailOAuth2": {"id": "ev0cwU3ZEXqPZ9wU", "name": "Gmail account"}}
    },
    {
      "parameters": {
        "jsCode": "const emails = $input.all();\nconst processedEmails = [];\n\nfor (const item of emails) {\n  const email = item.json;\n  \n  const headers = email.payload?.headers || [];\n  const from = headers.find(h => h.name === 'From')?.value || email.From || '';\n  const subject = headers.find(h => h.name === 'Subject')?.value || email.Subject || '';\n  const messageId = email.id;\n  const threadId = email.threadId;\n  \n  let senderEmail = '';\n  let senderName = '';\n  \n  const emailMatch = from.match(/<([^>]+)>/) || from.match(/([^\\s]+@[^\\s]+)/);\n  if (emailMatch) {\n    senderEmail = emailMatch[1].toLowerCase().trim();\n  }\n  \n  if (from.includes('<')) {\n    senderName = from.split('<')[0].trim().replace(/['\"]/g, '');\n  } else {\n    senderName = from.split('@')[0];\n  }\n  \n  let body = email.snippet || '';\n  \n  let skipReason = null;\n  \n  if (senderEmail.includes('noreply') || senderEmail.includes('no-reply')) {\n    skipReason = 'NoReply Ğ°Ğ´Ñ€ĞµÑ';\n  } else if (senderEmail.includes('facebook')) {\n    skipReason = 'Facebook';\n  } else if (senderEmail.includes('workspace@google')) {\n    skipReason = 'Google Workspace';\n  } else if (senderEmail.includes('cryptomator.pro')) {\n    const isReply = subject && subject.toLowerCase().includes('re:');\n    if (!isReply) {\n      skipReason = 'ĞĞ°ÑˆĞµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ';\n    }\n  } else if (!body || body.length < 3) {\n    skipReason = 'ĞŸÑƒÑÑ‚Ğ¾Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾';\n  }\n  \n  if (skipReason) {\n    continue;\n  }\n  \n  const hasRussian = /[Ğ°-ÑĞ-Ğ¯Ñ‘Ğ]/.test(body + subject);\n  const language = hasRussian ? 'ru' : 'en';\n  \n  processedEmails.push({\n    messageId: messageId,\n    threadId: threadId,\n    from: senderEmail,\n    senderName: senderName || 'Client',\n    subject: subject || 'No subject',\n    body: body.substring(0, 3000),\n    language: language,\n    timestamp: new Date(parseInt(email.internalDate || Date.now())).toISOString()\n  });\n}\n\nif (processedEmails.length === 0) {\n  return [];\n}\n\nreturn processedEmails.map(e => ({json: e}));"
      },
      "id": "d2899db2-3a76-4665-83c6-83bd1c483e6c",
      "name": "ğŸ“‹ Process Incoming",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-17648, -3328]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=WITH existing_conversation AS (\n    SELECT * FROM {{ $('âš™ï¸ CONFIG').first().json.table_gmail_conversations }}\n    WHERE email = '{{ $json.from }}'\n    LIMIT 1\n)\nSELECT \n    COALESCE(thread_id, '{{ $json.threadId }}') as thread_id,\n    COALESCE(email, '{{ $json.from }}') as email,\n    COALESCE(messages::text, 'ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚') as conversation_history,\n    COALESCE(lead_score, 0) as lead_score,\n    COALESCE(message_count, 0) as message_count,\n    '{{ $json.senderName }}' as full_name,\n    'email' as platform,\n    '{{ $json.language }}' as language\nFROM existing_conversation\nUNION ALL\nSELECT \n    '{{ $json.threadId }}' as thread_id,\n    '{{ $json.from }}' as email,\n    'ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚' as conversation_history,\n    0 as lead_score,\n    0 as message_count,\n    '{{ $json.senderName }}' as full_name,\n    'email' as platform,\n    '{{ $json.language }}' as language\nWHERE NOT EXISTS (SELECT 1 FROM existing_conversation);",
        "options": {}
      },
      "id": "49d74fd2-0721-48f6-a3ea-e08f7d1a7cd4",
      "name": "ğŸ“œ Get History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-17440, -3328],
      "credentials": {"postgres": {"id": "dPjh4Kdb4nIbCTQG", "name": "Postgres account"}}
    },
    {
      "parameters": {
        "documentId": {"__rl": true, "value": "={{ $('âš™ï¸ CONFIG').first().json.google_sheets_id }}", "mode": "id"},
        "sheetName": {"__rl": true, "value": "gid=0", "mode": "list", "cachedResultName": "Ğ›Ğ¸ÑÑ‚1"},
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.6,
      "position": [-17008, -3136],
      "id": "fae7fade-9c74-4f23-8ed2-03a1a70b4fff",
      "name": "ğŸ“Š Google Sheets ru",
      "credentials": {"googleSheetsOAuth2Api": {"id": "DvPu60dZpHogNtbY", "name": "Google Sheets account"}}
    },
    {
      "parameters": {
        "jsCode": "const gmailResponse = $items(\"ğŸ“¤ Send Gmail Reply\")[0].json;\nconst parseData = $items(\"ğŸ“ Parse AI Reply\")[0].json;\n\nreturn [{\n  json: {\n    messageId: parseData.messageId || gmailResponse.messageId,\n    threadId: parseData.threadId || gmailResponse.threadId,\n    status: 'processed'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-18016, -2992],
      "id": "3b04a944-286e-4b80-a9ed-36e146100d14",
      "name": "ğŸ”— Pass Message ID"
    },
    {
      "parameters": {
        "jsCode": "const parseData = $items(\"ğŸ“ Parse AI Reply\")[0].json;\nconst markAsReadData = $json;\n\nreturn [{\n  json: {\n    to: parseData.to,\n    senderName: parseData.senderName || parseData.to.split('@')[0],\n    subject: parseData.subject,\n    language: parseData.language || 'ru',\n    urgency: parseData.urgency || 'medium',\n    intent: parseData.intent || 'information',\n    leadScore: parseData.leadScore || 0,\n    internalNote: parseData.internalNote || 'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½',\n    followUpDays: parseData.followUpDays || 3\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-17616, -2992],
      "id": "b6507e56-22f7-4a81-accf-156022f00eee",
      "name": "ğŸ“‹ Prepare Notification Data"
    },
    {
      "parameters": {"options": {}},
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [-17472, -3328],
      "id": "541173d3-74fa-413c-9415-5d18659b9e1e",
      "name": "ğŸ”„ Loop Over Items"
    },
    {
      "parameters": {"amount": 10},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [-16560, -3312],
      "id": "a749c9d7-5963-44d8-8191-de86dc300b01",
      "name": "â³ Wait",
      "webhookId": "285307e1-14c7-4381-b783-7fd9d73dc07c"
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict", "version": 2},
          "conditions": [{"id": "73212611-2a14-4a98-8587-14fed2aa3c0f", "leftValue": "={{ $json.emailContent }}", "rightValue": 50, "operator": {"type": "string", "operation": "notEmpty", "singleValue": true}}],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-16736, -3328],
      "id": "cf502f39-55f6-4fdf-8210-8445012d908d",
      "name": "ğŸ”€ If Valid"
    }
  ],
  "pinData": {},
  "connections": {
    "â° Schedule Check answer": {"main": [[{"node": "âš™ï¸ CONFIG", "type": "main", "index": 0}]]},
    "âš™ï¸ CONFIG": {"main": [[{"node": "ğŸ“¬ Get Unread Emails", "type": "main", "index": 0}]]},
    "ğŸ§  Gemini Model Reply": {"ai_languageModel": [[{"node": "ğŸ¤– Gmail Reply Agent", "type": "ai_languageModel", "index": 0}]]},
    "ğŸ“ Parse AI Reply": {"main": [[{"node": "ğŸ”€ If Valid", "type": "main", "index": 0}]]},
    "ğŸ“¤ Send Gmail Reply": {"main": [[{"node": "ğŸ”— Pass Message ID", "type": "main", "index": 0}]]},
    "âœ… Mark as Read": {"main": [[{"node": "ğŸ“‹ Prepare Notification Data", "type": "main", "index": 0}]]},
    "ğŸ“Š Prepare Telegram Notification": {"main": [[{"node": "ğŸ“± Notify Telegram", "type": "main", "index": 0}]]},
    "ğŸ“± Notify Telegram": {"main": [[{"node": "ğŸ”„ Loop Over Items", "type": "main", "index": 0}]]},
    "ğŸ¤– Gmail Reply Agent": {"main": [[{"node": "ğŸ“ Parse AI Reply", "type": "main", "index": 0}]]},
    "ğŸ“¬ Get Unread Emails": {"main": [[{"node": "ğŸ“‹ Process Incoming", "type": "main", "index": 0}]]},
    "ğŸ“‹ Process Incoming": {"main": [[{"node": "ğŸ”„ Loop Over Items", "type": "main", "index": 0}]]},
    "ğŸ“œ Get History": {"main": [[{"node": "ğŸ¤– Gmail Reply Agent", "type": "main", "index": 0}]]},
    "ğŸ“Š Google Sheets ru": {"ai_tool": [[{"node": "ğŸ¤– Gmail Reply Agent", "type": "ai_tool", "index": 0}]]},
    "ğŸ”— Pass Message ID": {"main": [[{"node": "âœ… Mark as Read", "type": "main", "index": 0}]]},
    "ğŸ“‹ Prepare Notification Data": {"main": [[{"node": "ğŸ“Š Prepare Telegram Notification", "type": "main", "index": 0}]]},
    "ğŸ”„ Loop Over Items": {"main": [[], [{"node": "ğŸ“œ Get History", "type": "main", "index": 0}]]},
    "â³ Wait": {"main": [[{"node": "ğŸ“¬ Get Unread Emails", "type": "main", "index": 0}]]},
    "ğŸ”€ If Valid": {"main": [[{"node": "ğŸ“¤ Send Gmail Reply", "type": "main", "index": 0}], [{"node": "â³ Wait", "type": "main", "index": 0}]]}
  },
  "active": false,
  "settings": {"executionOrder": "v1"},
  "versionId": "production-v1",
  "meta": {"instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"},
  "id": "email-automation-main-2-ru",
  "tags": []
}
