{
  "name": "ğŸ“§ Email System Coordinator [Production EN]",
  "nodes": [
    {
      "parameters": {
        "content": "# âš™ï¸ WORKFLOW SETUP\n\n---\n\n## Before using:\n\n### 1. Open the Â«âš™ï¸ CONFIGÂ» node\nConfigure all parameters:\n\n| Parameter | Description |\n|----------|----------|\n| `company_domain` | Your company domain |\n| `company_name` | Company name |\n| `company_email` | Support email |\n| `api_key` | Your API key |\n| `webhook_base_url` | Your n8n URL |\n| `table_*` | Database table names |\n\n---\n\n### 2. Connect Credentials\n\n**Gmail OAuth2** â†’ Â«Get Recent EmailsÂ» node\n\n**PostgreSQL** â†’ all SQL nodes:\nâ€¢ Check Processed Emails\nâ€¢ Log Email Processing\nâ€¢ Save Conversation\nâ€¢ Save to Email Monitoring\nâ€¢ Update Metrics After Analysis\n\n---\n\n### 3. Sub-workflows\n\nMake sure these exist:\nâ€¢ `/webhook/extract-email-contact`\nâ€¢ `/webhook/analyze-email-dialog`\n\n---\n\n### 4. Activation\n\nClick **Active** in the top right corner.\nWorkflow runs every 10 minutes.",
        "height": 1244,
        "width": 480,
        "color": 6
      },
      "id": "966a9474-7f47-417f-aa55-60131d164119",
      "name": "ğŸ“‹ INSTRUCTIONS",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -528,
        -256
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {"id": "company-domain", "name": "company_domain", "value": "your-company.com", "type": "string"},
            {"id": "company-name", "name": "company_name", "value": "Your Company", "type": "string"},
            {"id": "company-email", "name": "company_email", "value": "support@your-company.com", "type": "string"},
            {"id": "api-key", "name": "api_key", "value": "YOUR-API-KEY-CHANGE-ME", "type": "string"},
            {"id": "webhook-url", "name": "webhook_base_url", "value": "https://your-n8n.com", "type": "string"},
            {"id": "table-log", "name": "table_processing_log", "value": "email_processing_log", "type": "string"},
            {"id": "table-conv", "name": "table_conversations", "value": "gmail_conversations", "type": "string"},
            {"id": "table-mon", "name": "table_monitoring", "value": "email_monitoring", "type": "string"},
            {"id": "table-analysis", "name": "table_analysis", "value": "email_dialog_analysis", "type": "string"}
          ]
        },
        "options": {}
      },
      "id": "e773bbc5-a17b-486c-85ff-e93bfe7b817b",
      "name": "âš™ï¸ CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        144,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "simple": false,
        "filters": {
          "q": "=newer_than:5d -from:noreply -from:no-reply -from:donotreply -from:notification"
        },
        "options": {}
      },
      "id": "51eef9f8-a34f-4cb6-a378-adc3530066fa",
      "name": "ğŸ“¥Get Recent Emails",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        304,
        -48
      ],
      "webhookId": "92e92da3-2b91-46e4-b567-e8a64ffded96",
      "credentials": {
        "gmailOAuth2": {
          "id": "ev0cwU3ZEXqPZ9wU",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“§ EXTRACT EMAIL DATA\n// Settings are taken from CONFIG node automatically\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Get configuration\nconst config = $('âš™ï¸ CONFIG').item.json;\nconst COMPANY_DOMAIN = config.company_domain;\n\n// Get all emails from last check\nconst emails = $input.all();\nconst processedEmails = [];\nconst logs = [];\n\nlogs.push(`Received ${emails.length} emails for processing`);\n\n// Function to clean and format email text\nfunction cleanEmailText(text) {\n  if (!text) return '';\n  \n  // First remove ALL lines with dates and names\n  text = text.replace(/^.*\\d{1,2}\\s+(ÑĞ½Ğ²|Ñ„ĞµĞ²|Ğ¼Ğ°Ñ€|Ğ°Ğ¿Ñ€|Ğ¼Ğ°Ñ|Ğ¸ÑĞ½|Ğ¸ÑĞ»|Ğ°Ğ²Ğ³|ÑĞµĞ½|Ğ¾ĞºÑ‚|Ğ½Ğ¾Ñ|Ğ´ĞµĞº)\\w*\\.?\\s+\\d{4}\\s+Ğ³\\.\\s+Ğ²\\s+\\d{1,2}:\\d{2}.*$/gmi, '');\n  text = text.replace(/^.*\\d{1,2}\\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\w*\\s+\\d{4}\\s+at\\s+\\d{1,2}:\\d{2}.*$/gmi, '');\n  \n  // Remove lines with days of week\n  text = text.replace(/^.*(ĞŸĞ½|Ğ’Ñ‚|Ğ¡Ñ€|Ğ§Ñ‚|ĞŸÑ‚|Ğ¡Ğ±|Ğ’Ñ|Ğ¿Ğ½|Ğ²Ñ‚|ÑÑ€|Ñ‡Ñ‚|Ğ¿Ñ‚|ÑĞ±|Ğ²Ñ|Mon|Tue|Wed|Thu|Fri|Sat|Sun),\\s+\\d{1,2}\\s+.*$/gmi, '');\n  \n  // Remove Gmail quoting\n  text = text.replace(/^>+.*$/gm, '');\n  \n  // Remove email addresses and names with colon\n  text = text.replace(/^.*[A-Za-z\\s]+\\s*<[^>]+@[^>]+>.*:$/gm, '');\n  text = text.replace(/^.*Cryptomator Team.*:$/gmi, '');\n  text = text.replace(/^.*CityBike.*:$/gmi, '');\n  \n  // Remove lines with \"wrote:\" patterns\n  text = text.replace(/^.*\\s+(Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»[Ğ°]?|wrote|Ğ¿Ğ¸ÑˆĞµÑ‚|writes).*:.*$/gmi, '');\n  \n  // Remove square brackets and their contents\n  text = text.replace(/\\[([^\\]]*)\\]/g, '$1');\n  text = text.replace(/\\[\"/g, '');\n  text = text.replace(/\"\\]/g, '');\n  text = text.replace(/\\[|\\]/g, '');\n  \n  // Remove curly braces\n  text = text.replace(/\\{|\\}/g, '');\n  \n  // Remove double quotes at start and end of lines\n  text = text.replace(/^\"|\"$/gm, '');\n  \n  // Remove signatures and separators\n  text = text.replace(/^(-{3,}|_{3,}|\\*{3,})[\\s\\S]*$/m, '');\n  \n  // Remove contact info with emojis\n  text = text.replace(/ğŸ“§.*$/gm, '');\n  text = text.replace(/ğŸ’¬.*$/gm, '');\n  text = text.replace(/ğŸŒ.*$/gm, '');\n  text = text.replace(/\\|/g, '');\n  \n  // Remove URLs and emails\n  text = text.replace(/https?:\\/\\/[^\\s]+/g, '');\n  text = text.replace(/www\\.[^\\s]+/g, '');\n  text = text.replace(/[^\\s]+@[^\\s]+\\.[^\\s]+/g, '');\n  \n  // Remove signatures\n  text = text.replace(/(Ğ¡ ÑƒĞ²Ğ°Ğ¶ĞµĞ½Ğ¸ĞµĞ¼|Ğ¡ Ğ½Ğ°Ğ¸Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸|Best regards|Sincerely|Regards|ĞĞ°Ğ´ĞµÑÑÑŒ.*Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½\\w*)[\\s\\S]*$/im, '');\n  text = text.replace(/^.*(ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°|Team)\\s+\\w+.*$/gmi, '');\n  \n  // FORMATTING\n  \n  // Remove single asterisks\n  text = text.replace(/^\\*\\s*/gm, '');\n  text = text.replace(/\\s*\\*\\s*/g, ' ');\n  \n  // Merge all text into one line\n  text = text.replace(/\\n+/g, ' ');\n  \n  // Remove multiple spaces\n  text = text.replace(/\\s{2,}/g, ' ');\n  \n  // List of emojis for formatting\n  const emojiList = ['â­', 'ğŸ’°', 'ğŸ”¥', 'ğŸŸ¢', 'ğŸŸ¡', 'ğŸ”µ', 'âœ…', 'âŒ', 'ğŸ“§', 'ğŸ’¬', 'ğŸŒ', 'ğŸš€', 'ğŸ“Š', 'ğŸ’¯', 'âš¡', 'ğŸ”', 'ğŸ“ˆ', 'ğŸ¯', 'ğŸ¨', 'ğŸ“Œ', 'ğŸ’¡', 'ğŸ', 'ğŸ†', 'ğŸ””', 'ğŸ“¢', 'ğŸ’¼', 'ğŸ“', 'ğŸ”‘', 'ğŸ’³', 'ğŸª', 'ğŸ²', 'ğŸ®', 'ğŸ‘', 'ğŸ‘', 'ğŸ’œ', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤'];\n  \n  // Add single line break before emojis\n  emojiList.forEach(emoji => {\n    text = text.replace(new RegExp(`\\\\s*${emoji}`, 'g'), `\\n${emoji}`);\n  });\n  \n  // Process lists with dashes - single line break\n  text = text.replace(/\\s*-\\s+/g, '\\nâ€¢ ');\n  \n  // Add line break after colon if followed by list\n  text = text.replace(/:\\s*([â­ğŸ’°ğŸ”¥ğŸŸ¢ğŸŸ¡ğŸ”µâœ…âŒğŸ“§ğŸ’¬ğŸŒğŸš€ğŸ“ŠğŸ’¯âš¡ğŸ”ğŸ“ˆ])/g, ':\\n$1');\n  \n  // Add line break after period if next sentence starts with capital\n  text = text.replace(/\\.\\s+([Ğ-Ğ¯A-Z])/g, '.\\n$1');\n  \n  // Remove line break at very beginning\n  text = text.replace(/^\\n+/, '');\n  \n  // Remove multiple line breaks (more than two)\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n  \n  // Remove spaces before punctuation\n  text = text.replace(/\\s+([,.;:!?])/g, '$1');\n  \n  // Add space after period, comma and colon if missing\n  text = text.replace(/([.,:])([Ğ-Ğ¯A-ZĞ°-Ña-z])/g, '$1 $2');\n  \n  // Final cleanup\n  text = text.trim();\n  \n  return text;\n}\n\nfor (const item of emails) {\n  const email = item.json;\n  \n  // Extract data from structure\n  let from = '';\n  let to = '';\n  let fromName = '';\n  let toName = '';\n  \n  if (email.from && email.from.value && email.from.value[0]) {\n    from = email.from.value[0].address || '';\n    fromName = email.from.value[0].name || '';\n  } else if (email.From) {\n    from = email.From;\n  }\n  \n  if (email.to && email.to.value && email.to.value[0]) {\n    to = email.to.value[0].address || '';\n    toName = email.to.value[0].name || '';\n  } else if (email.To) {\n    to = email.To;\n  }\n  \n  const subject = email.subject || email.Subject || '';\n  const messageId = email.id || '';\n  const threadId = email.threadId || '';\n  const labelIds = email.labelIds || email.labels || [];\n  const snippet = email.snippet || '';\n  \n  // Get and clean text\n  let body = email.text || email.textAsHtml || snippet || '';\n  body = cleanEmailText(body);\n  \n  // If after cleanup text is empty, use snippet\n  if (!body || body.length < 10) {\n    body = cleanEmailText(snippet);\n  }\n  \n  // Check if this is a sent email\n  const isSent = labelIds.some(label => \n    label === 'SENT' || \n    (typeof label === 'object' && label.id === 'SENT')\n  );\n  \n  // Check UNREAD\n  const isUnread = labelIds.some(label => \n    label === 'UNREAD' || \n    (typeof label === 'object' && label.id === 'UNREAD')\n  );\n  \n  logs.push(`Processing: From: ${from}, To: ${to}, Subject: ${subject}`);\n  \n  if (!from && !to) {\n    logs.push(`SKIPPED: no sender and recipient data`);\n    continue;\n  }\n  \n  // Determine client email and direction\n  let clientEmail = '';\n  let clientName = '';\n  let direction = '';\n  \n  if (isSent || from.includes(COMPANY_DOMAIN)) {\n    direction = 'outgoing';\n    clientEmail = to.toLowerCase().trim();\n    clientName = toName || to.split('@')[0];\n  } else {\n    direction = 'incoming';\n    clientEmail = from.toLowerCase().trim();\n    clientName = fromName || from.split('@')[0];\n  }\n  \n  // Filter unwanted emails\n  const skipPatterns = [\n    'noreply', 'no-reply', 'donotreply', 'notification',\n    'mailer-daemon', 'postmaster', 'abuse@'\n  ];\n  \n  const shouldSkip = skipPatterns.some(pattern => \n    clientEmail.includes(pattern)\n  );\n  \n  if (shouldSkip) {\n    logs.push(`SKIPPED: ${clientEmail} contains forbidden pattern`);\n    continue;\n  }\n  \n  if (!clientEmail || clientEmail === '') {\n    logs.push(`SKIPPED: could not extract client email`);\n    continue;\n  }\n  \n  // Determine language\n  const hasRussian = /[Ğ°-ÑĞ-Ğ¯Ñ‘Ğ]/.test(body + subject);\n  const language = hasRussian ? 'ru' : 'en';\n  \n  processedEmails.push({\n    gmailId: messageId,\n    threadId: threadId,\n    email: clientEmail,\n    senderName: clientName,\n    subject: subject || 'No subject',\n    body: body.substring(0, 5000),\n    snippet: snippet,\n    direction: direction,\n    isUnread: isUnread,\n    language: language,\n    labelIds: labelIds,\n    date: email.date || new Date(parseInt(email.internalDate || Date.now())).toISOString(),\n    timestamp: email.date || new Date(parseInt(email.internalDate || Date.now())).toISOString()\n  });\n  \n  logs.push(`ADDED: ${clientEmail} (${direction})`);\n}\n\nlogs.push(`TOTAL: Processed ${processedEmails.length} of ${emails.length}`);\n\nif (processedEmails.length === 0) {\n  return [{\n    json: {\n      error: 'No emails to process',\n      logs: logs,\n      totalEmails: emails.length\n    }\n  }];\n}\n\nreturn processedEmails.map(e => ({json: e}));"
      },
      "id": "cb8e671f-4a88-4556-884e-d57974752132",
      "name": "ğŸ“‹Extract Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        -48
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "3cb91292-d974-4ac2-b009-72d3d12776a6",
      "name": "â°Check Every 10 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -16,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Table: {{ $('âš™ï¸ CONFIG').item.json.table_processing_log }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSELECT \n    '{{ $json.gmailId }}' as gmail_id,\n    '{{ $json.threadId }}' as thread_id,\n    '{{ $json.email }}' as email,\n    '{{ $json.senderName }}' as sender_name,\n    '{{ $json.subject.replace(/'/g, \"''\") }}' as subject,\n    '{{ $json.direction }}' as direction,\n    {{ $json.isUnread }} as is_unread,\n    CASE \n        WHEN EXISTS (\n            SELECT 1 FROM {{ $('âš™ï¸ CONFIG').item.json.table_processing_log }} \n            WHERE gmail_message_id = '{{ $json.gmailId }}'\n        ) THEN true \n        ELSE false \n    END as is_processed",
        "options": {}
      },
      "id": "502bf55c-5ae1-4e55-8f3c-9e6e1baee5b2",
      "name": "ğŸ”Check Processed Emails",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        688,
        -48
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get ALL check results\nconst processedChecks = $input.all();\nconst allEmails = $items('ğŸ“‹Extract Email Data');\nconst restoredEmails = [];\n\n// Process each checked entry\nfor (const check of processedChecks) {\n  const processedCheck = check.json;\n  \n  // Find corresponding email from Extract Email Data\n  const emailData = allEmails.find(item => \n    item.json.gmailId === processedCheck.gmail_id\n  );\n  \n  if (emailData) {\n    restoredEmails.push({\n      json: {\n        ...emailData.json,\n        is_processed: processedCheck.is_processed\n      }\n    });\n  }\n}\n\n// Return ALL restored emails\nreturn restoredEmails;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -48
      ],
      "id": "dfa84a3e-c9b5-4724-9ac6-1c208762dae3",
      "name": "ğŸ”„Restore Email Data1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ $json.is_processed }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "id": "2629f11f-26d2-4107-b1c4-e3700f10f239"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "09d407c6-5f24-48c8-982c-a3ab516d0108",
      "name": "â“Is New Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1072,
        -48
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Table: {{ $('âš™ï¸ CONFIG').item.json.table_processing_log }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').item.json.table_processing_log }} (\n    gmail_message_id,\n    thread_id,\n    email_from,\n    email_to,\n    subject,\n    direction,\n    is_unread,\n    processed_at\n) VALUES (\n    '{{ $json.gmailId }}',\n    '{{ $json.threadId }}',\n    '{{ $json.email }}',\n    '{{ $('âš™ï¸ CONFIG').item.json.company_email }}',\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.direction }}',\n    {{ $json.isUnread }},\n    NOW()\n)\nON CONFLICT (gmail_message_id) \nDO UPDATE SET \n    processed_at = NOW(),\n    is_unread = EXCLUDED.is_unread\nRETURNING *;",
        "options": {}
      },
      "id": "2e733ae9-e511-46b8-8e65-1ff5db98ebda",
      "name": "ğŸ“ Log Email Processing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        -64
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get all data from Log Email Processing\nconst logItems = $input.all();\nconst restoredEmails = $items('ğŸ”„Restore Email Data1');\n\nconst result = [];\n\n// Process each entry\nfor (const logItem of logItems) {\n    const logData = logItem.json;\n    \n    // Find corresponding email\n    const email = restoredEmails.find(item => \n        item.json.gmailId === logData.gmail_message_id\n    );\n    \n    if (email) {\n        result.push({\n            json: email.json\n        });\n    }\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        256
      ],
      "id": "3fded5e6-7363-4fed-877c-2b193f780ddd",
      "name": "ğŸ”„ Restore for Save"
    },
    {
      "parameters": {
        "jsCode": "// Get all data from Code node with full email information\nconst allEmails = $input.all();\nconst results = [];\n\nfor (const item of allEmails) {\n    const emailData = item.json;\n    \n    results.push({\n        json: {\n            ...emailData, // Keep all data from Code\n            // Additional fields for Save Conversation\n            direction: emailData.direction || 'incoming',\n            originalBody: emailData.body || emailData.snippet || '',\n            emailContent: '', // Empty for now, will be filled on reply\n            leadScore: 0, // Will be updated after analysis\n            intent: 'unknown',\n            urgency: 'medium'\n        }\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        256
      ],
      "id": "87dfede5-eeec-42dc-8b28-246092e2e7de",
      "name": "ğŸ“¦Prepare Save Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Table: {{ $('âš™ï¸ CONFIG').item.json.table_conversations }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nBEGIN;\n-- Save conversation by client email\nINSERT INTO {{ $('âš™ï¸ CONFIG').item.json.table_conversations }} (\n    email,\n    thread_id, \n    subject,\n    messages,\n    status,\n    lead_score,\n    language,\n    message_count,\n    created_at\n) VALUES (\n    '{{ $json.email }}',\n    '{{ $json.threadId }}',\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    jsonb_build_array(\n        jsonb_build_object(\n            'type', '{{ $json.direction }}',\n            'content', '{{ ($json.body || $json.snippet || \"\").replace(/'/g, \"''\").substring(0, 5000) }}',\n            'date', '{{ $json.date }}',\n            'sender', '{{ $json.direction === \"incoming\" ? $json.senderName : $('âš™ï¸ CONFIG').item.json.company_name }}',\n            'thread_id', '{{ $json.threadId }}',\n            'gmail_id', '{{ $json.gmailId }}'\n        )\n    ),\n    'active',\n    {{ $json.leadScore || 0 }},\n    '{{ $json.language }}',\n    1,\n    NOW()\n)\nON CONFLICT (email) DO UPDATE SET\n    messages = \n        CASE\n            WHEN NOT EXISTS (\n                SELECT 1 FROM jsonb_array_elements(COALESCE({{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.messages, '[]'::jsonb)) elem\n                WHERE elem->>'gmail_id' = '{{ $json.gmailId }}'\n            )\n            THEN (\n                SELECT jsonb_agg(elem ORDER BY (elem->>'date')::timestamp ASC)\n                FROM (\n                    SELECT elem FROM jsonb_array_elements(COALESCE({{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.messages, '[]'::jsonb)) elem\n                    UNION ALL\n                    SELECT jsonb_build_object(\n                        'type', '{{ $json.direction }}',\n                        'content', '{{ ($json.body || $json.snippet || \"\").replace(/'/g, \"''\").substring(0, 5000) }}',\n                        'date', '{{ $json.date }}',\n                        'sender', '{{ $json.direction === \"incoming\" ? $json.senderName : $('âš™ï¸ CONFIG').item.json.company_name }}',\n                        'thread_id', '{{ $json.threadId }}',\n                        'gmail_id', '{{ $json.gmailId }}'\n                    )\n                ) AS all_messages(elem)\n            )\n            ELSE {{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.messages\n        END,\n    message_count = \n        CASE\n            WHEN NOT EXISTS (\n                SELECT 1 FROM jsonb_array_elements(COALESCE({{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.messages, '[]'::jsonb)) elem\n                WHERE elem->>'gmail_id' = '{{ $json.gmailId }}'\n            )\n            THEN COALESCE({{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.message_count, 0) + 1\n            ELSE {{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.message_count\n        END,\n    lead_score = GREATEST({{ $('âš™ï¸ CONFIG').item.json.table_conversations }}.lead_score, {{ $json.leadScore || 0 }}),\n    status = 'active',\n    thread_id = '{{ $json.threadId }}',\n    subject = '{{ $json.subject.replace(/'/g, \"''\") }}',\n    updated_at = NOW();\nCOMMIT;",
        "options": {}
      },
      "id": "46a6083c-65df-4a66-ba01-81a162dc3882",
      "name": "ğŸ’¾Save Conversation",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Restore original data for Save to Email Monitoring\nconst originalEmails = $items('ğŸ”„ Restore for Save');\nconst savedConversations = $input.all();\nconst results = [];\n\n// Return original data from Code for Email Monitoring\nfor (const email of originalEmails) {\n    results.push({\n        json: email.json\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        256
      ],
      "id": "75b95d25-38df-4e05-b0ef-c883e0d45548",
      "name": "ğŸ”„Restore Email Data for Monitoring"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Tables:\n--    {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }}\n--    {{ $('âš™ï¸ CONFIG').item.json.table_conversations }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nINSERT INTO {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }} (\n    record_id,\n    record_timestamp,\n    email,\n    thread_id,\n    user_name,\n    timestamp,\n    first_contact_time,\n    last_activity_time,\n    event_type,\n    message_count,\n    subject,\n    language,\n    intent,\n    urgency,\n    status,\n    last_reply_from\n) VALUES (\n    'email_{{ $json.email }}_{{ Date.now() }}',\n    NOW(),\n    '{{ $json.email }}',\n    '{{ $json.threadId }}',\n    '{{ $json.senderName }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.timestamp }}',\n    'new_email',\n    (SELECT COALESCE(message_count, 1) FROM {{ $('âš™ï¸ CONFIG').item.json.table_conversations }} WHERE email = '{{ $json.email }}' LIMIT 1),\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.language }}',\n    'unknown',\n    'medium',\n    '{{ $json.isUnread ? \"unread\" : \"active\" }}',\n    '{{ $json.direction === \"incoming\" ? \"client\" : \"company\" }}'\n)\nON CONFLICT (email) DO UPDATE SET\n    user_name = EXCLUDED.user_name,\n    thread_id = EXCLUDED.thread_id,\n    subject = EXCLUDED.subject,\n    language = EXCLUDED.language,\n    status = EXCLUDED.status,\n    last_reply_from = EXCLUDED.last_reply_from,\n    message_count = (\n        SELECT COALESCE(message_count, {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }}.message_count) \n        FROM {{ $('âš™ï¸ CONFIG').item.json.table_conversations }} \n        WHERE email = '{{ $json.email }}' \n        LIMIT 1\n    ),\n    last_activity_time = GREATEST(\n        {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }}.last_activity_time::timestamp,\n        '{{ $json.timestamp }}'::timestamp\n    ),\n    first_contact_time = LEAST(\n        {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }}.first_contact_time::timestamp,\n        '{{ $json.timestamp }}'::timestamp\n    ),\n    updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "9738de52-2208-466e-86eb-9fb7cc09ac80",
      "name": "ğŸ“ŠSave to Email Monitoring",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        960,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get ALL data from Code node\nconst allCodeData = $items('ğŸ”„ Restore for Save');\nconst monitoringResult = $json;\n\n// Create Map to store unique emails\nconst uniqueEmails = new Map();\n\n// Process each email\nfor (const item of allCodeData) {\n    const email = item.json.email;\n    \n    // If email not added yet or current record is newer\n    if (!uniqueEmails.has(email) || \n        new Date(item.json.date) > new Date(uniqueEmails.get(email).date)) {\n        uniqueEmails.set(email, {\n            email: email,\n            senderName: item.json.senderName,\n            language: item.json.language || 'en',\n            date: item.json.date,\n            timestamp: item.json.timestamp || item.json.date\n        });\n    }\n}\n\n// Convert Map to array for return\nconst result = [];\nfor (const emailData of uniqueEmails.values()) {\n    result.push({\n        json: emailData\n    });\n}\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1168,
        256
      ],
      "id": "6d87ee24-fb0d-42cc-96e5-b960522d63a3",
      "name": "ğŸ“¤Pass Monitoring Data"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        144,
        480
      ],
      "id": "bd76cf1c-ad79-4a13-bfb0-136d2a30f96f",
      "name": "ğŸ”Loop Over Items"
    },
    {
      "parameters": {
        "amount": 1
      },
      "id": "94869f2e-fdd5-4962-8a8b-d4cf24b58093",
      "name": "â³Wait 1 sec",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        352,
        496
      ],
      "webhookId": "wait-1-webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('âš™ï¸ CONFIG').item.json.webhook_base_url }}/webhook/extract-email-contact",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('âš™ï¸ CONFIG').item.json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"type\": \"single\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        544,
        496
      ],
      "id": "3dab3992-489f-4125-8a3a-c391d0e348a1",
      "name": "ğŸ“Call Extract Contacts"
    },
    {
      "parameters": {
        "jsCode": "// Pass data further after contact extraction\nconst extractResponse = $json; // Response from Call Extract Contacts\nconst currentData = $items('â³Wait 1 sec')[0].json; // Current item data from loop\n\nreturn [{\n  json: {\n    ...currentData, // All current item data\n    extractStatus: extractResponse.status || 'completed',\n    extractMessage: extractResponse.message || 'Contacts extracted'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        496
      ],
      "id": "3b78388c-c13a-44bb-b4d5-bbaf698cf218",
      "name": "ğŸ“¤ Pass Result"
    },
    {
      "parameters": {
        "amount": 2
      },
      "id": "4a54dcd0-d0cd-4aa6-8979-83a055d01313",
      "name": "â³Wait 2 sec",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        928,
        496
      ],
      "webhookId": "wait-2-webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('âš™ï¸ CONFIG').item.json.webhook_base_url }}/webhook/analyze-email-dialog",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "apiKey",
              "value": "={{ $('âš™ï¸ CONFIG').item.json.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"email\": \"{{ $json.email }}\",\n  \"language\": \"{{ $json.language }}\",\n  \"type\": \"single\"\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          },
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1104,
        496
      ],
      "id": "e208f8b3-ff00-46a3-b0df-de50e45f0bb2",
      "name": "ğŸ§ Call Analyze Dialog"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n-- ğŸ“‹ Tables:\n--    {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }}\n--    {{ $('âš™ï¸ CONFIG').item.json.table_analysis }}\n-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nUPDATE {{ $('âš™ï¸ CONFIG').item.json.table_monitoring }} em\nSET \n    urgency = CASE \n        WHEN (SELECT lead_scoring->>'temperature' \n              FROM {{ $('âš™ï¸ CONFIG').item.json.table_analysis }} \n              WHERE email = em.email \n              ORDER BY created_at DESC LIMIT 1) = 'hot' THEN 'high'\n        WHEN (SELECT lead_scoring->>'temperature' \n              FROM {{ $('âš™ï¸ CONFIG').item.json.table_analysis }} \n              WHERE email = em.email \n              ORDER BY created_at DESC LIMIT 1) = 'warm' THEN 'medium'\n        ELSE 'low'\n    END,\n    updated_at = NOW()\nWHERE em.email = '{{ $items('Pass Monitoring Data')[0].json.email }}';\n\nSELECT 'Updated' as status;",
        "options": {}
      },
      "id": "4e9f17ca-f964-4521-8b21-bd6fa07652bc",
      "name": "ğŸ“ˆUpdate Metrics After Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1296,
        496
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Complete processing\nconst currentData = $json; // Data from previous node (Update Metrics After Analysis)\n\nreturn [{\n  json: {\n    status: 'processing_completed',\n    email: currentData.email || 'unknown',\n    processed: true,\n    completedAt: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        496
      ],
      "id": "7ff13fe4-f3ab-4e33-b92f-9db7e5f23da5",
      "name": "âœ…Complete Outgoing"
    }
  ],
  "pinData": {},
  "connections": {
    "âš™ï¸ CONFIG": {
      "main": [
        [
          {
            "node": "ğŸ“¥Get Recent Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥Get Recent Emails": {
      "main": [
        [
          {
            "node": "ğŸ“‹Extract Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹Extract Email Data": {
      "main": [
        [
          {
            "node": "ğŸ”Check Processed Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â°Check Every 10 Minutes": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”Check Processed Emails": {
      "main": [
        [
          {
            "node": "ğŸ”„Restore Email Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„Restore Email Data1": {
      "main": [
        [
          {
            "node": "â“Is New Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“Is New Email?": {
      "main": [
        [
          {
            "node": "ğŸ“ Log Email Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Log Email Processing": {
      "main": [
        [
          {
            "node": "ğŸ”„ Restore for Save",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Restore for Save": {
      "main": [
        [
          {
            "node": "ğŸ“¦Prepare Save Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦Prepare Save Data": {
      "main": [
        [
          {
            "node": "ğŸ’¾Save Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾Save Conversation": {
      "main": [
        [
          {
            "node": "ğŸ”„Restore Email Data for Monitoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„Restore Email Data for Monitoring": {
      "main": [
        [
          {
            "node": "ğŸ“ŠSave to Email Monitoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ŠSave to Email Monitoring": {
      "main": [
        [
          {
            "node": "ğŸ“¤Pass Monitoring Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤Pass Monitoring Data": {
      "main": [
        [
          {
            "node": "ğŸ”Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "â³Wait 1 sec",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³Wait 1 sec": {
      "main": [
        [
          {
            "node": "ğŸ“Call Extract Contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Call Extract Contacts": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Pass Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Pass Result": {
      "main": [
        [
          {
            "node": "â³Wait 2 sec",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³Wait 2 sec": {
      "main": [
        [
          {
            "node": "ğŸ§ Call Analyze Dialog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§ Call Analyze Dialog": {
      "main": [
        [
          {
            "node": "ğŸ“ˆUpdate Metrics After Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆUpdate Metrics After Analysis": {
      "main": [
        [
          {
            "node": "âœ…Complete Outgoing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ…Complete Outgoing": {
      "main": [
        [
          {
            "node": "ğŸ”Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "production-en-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "email-system-coordinator-en",
  "tags": []
}
