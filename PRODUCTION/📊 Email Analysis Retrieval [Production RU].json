{
  "name": "ğŸ“Š Email Analysis Retrieval [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“Š Email Analysis Retrieval - ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n\n### ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ\nĞ­Ñ‚Ğ¾Ñ‚ workflow Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ API Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²\nĞ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° email-Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ¸: ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ½, lead scoring, Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸.\n\n---\n\n### ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n\n1. **ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ ÑƒĞ·Ğ»Ñ‹ `âš™ï¸ CONFIG (Single)` Ğ¸ `âš™ï¸ CONFIG (All)`** Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ:\n   - `api_key` â€” Ğ²Ğ°Ñˆ API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ endpoint\n   - `rate_limit_window_ms` â€” Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ rate limiting (Ğ¼Ñ)\n   - `rate_limit_max_requests` â€” Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¾ĞºĞ½Ğµ\n   - ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ PostgreSQL\n\n2. **ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ PostgreSQL** credential Ğº ÑƒĞ·Ğ»Ğ°Ğ¼ Ğ‘Ğ”\n\n3. **ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ workflow**\n\n---\n\n### ğŸ“¡ API Endpoints\n\n#### 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ email\n**GET** `/webhook/get-email-analysis?email=client@example.com`\n\n**Headers:**\n```\nx-api-key: Ğ²Ğ°Ñˆ_api_key\n```\n\n**Query Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**\n- `email` â€” email ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°\n- `type` â€” Ñ‚Ğ¸Ğ¿ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° (default: `single`)\n\n---\n\n#### 2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñ‹\n**GET** `/webhook/get-all-email-analysis`\n\n**Headers:**\n```\nx-api-key: Ğ²Ğ°Ñˆ_api_key\n```\n\n**Query Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾):**\n- `days` â€” Ğ·Ğ° ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ½ĞµĞ¹ (default: Ğ²ÑĞµ)\n- `language` â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ ÑĞ·Ñ‹ĞºÑƒ\n\n---\n\n### ğŸ“Š Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°\n\n```json\n{\n  \"found\": true,\n  \"email\": \"client@example.com\",\n  \"emotionalTone\": {...},\n  \"leadScoring\": {...},\n  \"recommendations\": [...]\n}\n```"
      },
      "id": "sticky-note-instructions",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -500,
        -350
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-analysis",
              "name": "table_email_dialog_analysis",
              "value": "email_dialog_analysis",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "config-single",
      "name": "âš™ï¸ CONFIG (Single)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        -144
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "api-key",
              "name": "api_key",
              "value": "24fs-$r4d-defd-77ds-7eds",
              "type": "string"
            },
            {
              "id": "rate-window",
              "name": "rate_limit_window_ms",
              "value": 60000,
              "type": "number"
            },
            {
              "id": "rate-max",
              "name": "rate_limit_max_requests",
              "value": 60,
              "type": "number"
            },
            {
              "id": "table-analysis",
              "name": "table_email_dialog_analysis",
              "value": "email_dialog_analysis",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "config-all",
      "name": "âš™ï¸ CONFIG (All)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        208
      ]
    },
    {
      "parameters": {
        "path": "get-email-analysis",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "87b2128f-d0b6-4b5a-a241-e6f3ecafa74b",
      "name": "ğŸŒ Webhook: Get Single Analysis",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -200,
        -144
      ],
      "webhookId": "get-email-analysis-webhook"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// ğŸ” Ğ£ĞĞ˜Ğ’Ğ•Ğ Ğ¡ĞĞ›Ğ¬ĞĞĞ¯ Ğ—ĞĞ©Ğ˜Ğ¢Ğ: API KEY + RATE LIMITING\n// ============================================\n\n// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· CONFIG (Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ñ‹ Ğ¿Ğ¾ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞµ)\nconst config = {\n  api_key: $('âš™ï¸ CONFIG (Single)').first().json.api_key,\n  rate_limit_window_ms: $('âš™ï¸ CONFIG (Single)').first().json.rate_limit_window_ms,\n  rate_limit_max_requests: $('âš™ï¸ CONFIG (Single)').first().json.rate_limit_max_requests,\n  table_email_dialog_analysis: $('âš™ï¸ CONFIG (Single)').first().json.table_email_dialog_analysis\n};\n\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Get Single Analysis').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, config: config, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, config: config, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, config: config, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true, config: config } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        200,
        -144
      ],
      "id": "96443ee0-1161-4c87-aed4-ab85ace71bea",
      "name": "ğŸ” Security Check (Single)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        -144
      ],
      "id": "9cf3bea6-0c90-416f-b8fe-1fc7677aa653",
      "name": "ğŸ”€ Auth Check (Single)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        600,
        -32
      ],
      "id": "62348eb8-3d12-4dd7-a819-95dac6bd63d0",
      "name": "âŒ Error Response (Single)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n    email,\n    thread_id,\n    user_name,\n    analysis_type,\n    language,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    statistics,\n    satisfaction_percentage,\n    lead_scoring,\n    created_at,\n    updated_at\nFROM {{ $json.config.table_email_dialog_analysis }} \nWHERE email = '{{ $json.query.email }}' \nAND analysis_type = '{{ $json.query.type || 'single' }}' \nORDER BY created_at DESC \nLIMIT 1",
        "options": {}
      },
      "id": "1b11646e-ece6-4549-9af7-451683ece96f",
      "name": "ğŸ“‹ Get Analysis from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        600,
        -208
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = items[0]?.json;\nif (!data) {\n  return [{json: {found: false, message: 'ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½'}}];\n}\n\n// ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSONB Ğ¿Ğ¾Ğ»Ñ\nlet emotionalTone = data.emotional_tone;\nlet customerNeeds = data.customer_needs;\nlet missedOpportunities = data.missed_opportunities;\nlet recommendations = data.recommendations;\nlet statistics = data.statistics;\nlet leadScoring = data.lead_scoring;\n\n// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ¿Ğ°Ñ€ÑĞ¸Ğ¼ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑÑ‚Ñ€Ğ¾ĞºĞ¸\nif (typeof emotionalTone === 'string') {\n  try { emotionalTone = JSON.parse(emotionalTone); } catch(e) {}\n}\nif (typeof customerNeeds === 'string') {\n  try { customerNeeds = JSON.parse(customerNeeds); } catch(e) {}\n}\nif (typeof missedOpportunities === 'string') {\n  try { missedOpportunities = JSON.parse(missedOpportunities); } catch(e) {}\n}\nif (typeof recommendations === 'string') {\n  try { recommendations = JSON.parse(recommendations); } catch(e) {}\n}\nif (typeof statistics === 'string') {\n  try { statistics = JSON.parse(statistics); } catch(e) {}\n}\nif (typeof leadScoring === 'string') {\n  try { leadScoring = JSON.parse(leadScoring); } catch(e) {}\n}\n\nreturn [{\n  json: {\n    found: true,\n    email: data.email,\n    threadId: data.thread_id,\n    userName: data.user_name,\n    analysisType: data.analysis_type,\n    language: data.language,\n    emotionalTone: emotionalTone,\n    customerNeeds: customerNeeds,\n    missedOpportunities: missedOpportunities,\n    recommendations: recommendations,\n    statistics: statistics,\n    satisfactionPercentage: data.satisfaction_percentage || emotionalTone?.satisfaction || 0,\n    leadScoring: leadScoring,\n    createdAt: data.created_at,\n    updatedAt: data.updated_at\n  }\n}];"
      },
      "id": "e8571a60-5e64-49e2-8810-badea478cb6a",
      "name": "ğŸ“ Format Single Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        -208
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "f9100a59-bc25-4a2a-9422-d4fdde78b8fd",
      "name": "ğŸ“¤ Send Single Analysis",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1000,
        -208
      ]
    },
    {
      "parameters": {
        "path": "get-all-email-analysis",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "27b3cdcb-0e15-4ee3-9883-bcd9751594fe",
      "name": "ğŸŒ Webhook: Get All Analysis",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -200,
        208
      ],
      "webhookId": "get-all-email-analysis-webhook"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// ğŸ” Ğ£ĞĞ˜Ğ’Ğ•Ğ Ğ¡ĞĞ›Ğ¬ĞĞĞ¯ Ğ—ĞĞ©Ğ˜Ğ¢Ğ: API KEY + RATE LIMITING\n// ============================================\n\n// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· CONFIG (Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ñ‹ Ğ¿Ğ¾ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞµ)\nconst config = {\n  api_key: $('âš™ï¸ CONFIG (All)').first().json.api_key,\n  rate_limit_window_ms: $('âš™ï¸ CONFIG (All)').first().json.rate_limit_window_ms,\n  rate_limit_max_requests: $('âš™ï¸ CONFIG (All)').first().json.rate_limit_max_requests,\n  table_email_dialog_analysis: $('âš™ï¸ CONFIG (All)').first().json.table_email_dialog_analysis\n};\n\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max_requests;\n\nconst inputData = $('ğŸŒ Webhook: Get All Analysis').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, config: config, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, config: config, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, config: config, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true, config: config } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        200,
        208
      ],
      "id": "ed82d0cf-5ef8-4f85-9bd4-6d6a75456b1e",
      "name": "ğŸ” Security Check (All)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        208
      ],
      "id": "dfc56595-b71b-43eb-9e78-8744c551ec79",
      "name": "ğŸ”€ Auth Check (All)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        600,
        320
      ],
      "id": "ef7a8bd9-a672-4cf9-a0e0-0b9c2361938a",
      "name": "âŒ Error Response (All)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT DISTINCT ON (email) \n    email,\n    thread_id,\n    user_name,\n    analysis_type,\n    language,\n    emotional_tone,\n    customer_needs,\n    missed_opportunities,\n    recommendations,\n    statistics,\n    satisfaction_percentage,\n    lead_scoring,\n    created_at,\n    updated_at\nFROM {{ $json.config.table_email_dialog_analysis }} \nWHERE analysis_type = 'single'\n    {{ $json.query?.days ? \"AND created_at >= NOW() - INTERVAL '\" + $json.query.days + \" days'\" : \"\" }}\n    {{ $json.query?.language ? \"AND language = '\" + $json.query.language + \"'\" : \"\" }}\nORDER BY email, created_at DESC",
        "options": {}
      },
      "id": "752b2232-158b-4c55-8cf3-f742d37952dd",
      "name": "ğŸ“‹ Get All Analysis from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        600,
        144
      ],
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const analyses = {};\n\nitems.forEach(item => {\n  const data = item.json;\n  \n  // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSONB Ğ¿Ğ¾Ğ»Ñ\n  let emotionalTone = data.emotional_tone;\n  let leadScoring = data.lead_scoring;\n  \n  if (typeof emotionalTone === 'string') {\n    try { emotionalTone = JSON.parse(emotionalTone); } catch(e) {}\n  }\n  if (typeof leadScoring === 'string') {\n    try { leadScoring = JSON.parse(leadScoring); } catch(e) {}\n  }\n  \n  analyses[data.email] = {\n    emotionalTone: emotionalTone?.overall || 'unknown',\n    satisfactionPercentage: data.satisfaction_percentage || emotionalTone?.satisfaction || 0,\n    leadScoring: leadScoring?.score || 0,\n    leadTemperature: leadScoring?.temperature || 'cold',\n    createdAt: data.created_at,\n    updatedAt: data.updated_at\n  };\n});\n\nreturn [{json: {analyses}}];"
      },
      "id": "c2abde7a-ad35-45ad-bbe1-d525a1dd0045",
      "name": "ğŸ“ Format All Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        144
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "29bbd3db-72dc-4acc-bd26-aec8bbea9e10",
      "name": "ğŸ“¤ Send All Analysis",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1000,
        144
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "ğŸŒ Webhook: Get Single Analysis": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG (Single)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ CONFIG (Single)": {
      "main": [
        [
          {
            "node": "ğŸ” Security Check (Single)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Security Check (Single)": {
      "main": [
        [
          {
            "node": "ğŸ”€ Auth Check (Single)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Auth Check (Single)": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Get Analysis from DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Error Response (Single)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Get Analysis from DB": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Single Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Single Analysis": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send Single Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Webhook: Get All Analysis": {
      "main": [
        [
          {
            "node": "âš™ï¸ CONFIG (All)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ CONFIG (All)": {
      "main": [
        [
          {
            "node": "ğŸ” Security Check (All)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Security Check (All)": {
      "main": [
        [
          {
            "node": "ğŸ”€ Auth Check (All)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Auth Check (All)": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Get All Analysis from DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Error Response (All)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Get All Analysis from DB": {
      "main": [
        [
          {
            "node": "ğŸ“ Format All Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format All Analysis": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send All Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "dd169c96-b08a-4d25-b307-dab9c778b9ea",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "HPt567FSlyDaZUia",
  "tags": []
}
