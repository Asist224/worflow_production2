{
  "name": "üìß Email Monitoring [Production RU]",
  "nodes": [
    {
      "parameters": {
        "content": "# üìß EMAIL –ú–û–ù–ò–¢–û–†–ò–ù–ì\n\n\n\n## ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê\n\n\n\n### 1Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–∑–ª—ã CONFIG\n\n–í —ç—Ç–æ–º workflow 3 —Ü–µ–ø–æ—á–∫–∏, –∫–∞–∂–¥–∞—è –∏–º–µ–µ—Ç —Å–≤–æ–π CONFIG —É–∑–µ–ª.\n\n–û—Ç–∫—Ä–æ–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∫–∞–∂–¥–æ–º:\n\n\n\n**üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**\n\n‚Ä¢ `api_key` ‚Äî –í–∞—à API –∫–ª—é—á\n\n‚Ä¢ `rate_limit_window_ms` ‚Äî –û–∫–Ω–æ –ª–∏–º–∏—Ç–∞ (–º—Å)\n\n‚Ä¢ `rate_limit_max` ‚Äî –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω\n\n\n\n**üóÑÔ∏è –¢–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**\n\n‚Ä¢ `table_email_monitoring` ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ email\n\n‚Ä¢ `table_email_dialog_analysis` ‚Äî –ê–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤\n\n‚Ä¢ `table_gmail_conversations` ‚Äî –ü–µ—Ä–µ–ø–∏—Å–∫–∏ Gmail\n\n\n\n---\n\n\n\n### 2Ô∏è‚É£ –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Credentials\n\n\n\n**PostgreSQL** ‚Üí –≤—Å–µ —É–∑–ª—ã —Å –∏–∫–æ–Ω–∫–æ–π üêò\n\n\n\n---\n\n\n\n### 3Ô∏è‚É£ API Endpoints\n\n\n\n| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |\n|:-----:|----------|----------|\n| POST | `/email-monitoring` | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ |\n| GET | `/email-monitoring-data` | –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ |\n| GET | `/email-dialogs` | –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ email |\n\n\n\n---\n\n\n\n### 4Ô∏è‚É£ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤\n\n\n\n–ü–µ—Ä–µ–¥–∞–π—Ç–µ API –∫–ª—é—á –æ–¥–Ω–∏–º –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤:\n\n‚Ä¢ Header: `x-api-key: –í–ê–®_–ö–õ–Æ–ß`\n\n‚Ä¢ Query: `?apiKey=–í–ê–®_–ö–õ–Æ–ß`\n\n‚Ä¢ Body: `{\"apiKey\": \"–í–ê–®_–ö–õ–Æ–ß\"}`\n\n\n\n---\n\n\n\n### 5Ô∏è‚É£ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏\n\n\n\n‚Ä¢ üì• –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ email –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n‚Ä¢ üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞\n\n‚Ä¢ üí¨ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏\n\n‚Ä¢ üî• Lead Score –∏ —Å—Ç–∞—Ç—É—Å—ã\n\n‚Ä¢ ‚è∞ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n\n\n---\n\n\n\n### 6Ô∏è‚É£ –ê–∫—Ç–∏–≤–∞—Ü–∏—è\n\n\n\n–ù–∞–∂–º–∏—Ç–µ **Active** ‚ÜóÔ∏è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É",
        "height": 1380,
        "width": 420,
        "color": 6
      },
      "id": "sticky-instructions-ru",
      "name": "üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1100,
        -500
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "email-monitoring",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -736,
        -368
      ],
      "id": "9066a0cf-c33f-4c9b-8485-38264e4a5fa9",
      "name": "üåê Webhook: Save Monitoring",
      "webhookId": "email-monitoring-webhook-id"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"api_key\": \"24fs-$r4d-defd-77ds-7eds\",\n  \"rate_limit_window_ms\": 60000,\n  \"rate_limit_max\": 60,\n  \"table_email_monitoring\": \"email_monitoring\"\n}",
        "options": {}
      },
      "id": "config-save-monitoring",
      "name": "‚öôÔ∏è CONFIG (Save)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -544,
        -368
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìù –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• EMAIL\n// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è email –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst webhook = $('üåê Webhook: Save Monitoring').item.json;\nconst inputData = webhook.body || webhook;\n\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏\nconst currentTime = new Date();\nconst currentTimeISO = currentTime.toISOString();\n\n// –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –ë–î\nconst monitoringData = {\n    // –û—Å–Ω–æ–≤–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è email\n    recordId: `email_${inputData.email}_${Date.now()}`,\n    recordTimestamp: currentTimeISO,\n    email: inputData.email,\n    thread_id: inputData.threadId,\n    user_name: inputData.userName || inputData.senderName,\n    \n    // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏\n    timestamp: currentTimeISO,\n    first_contact_time: inputData.firstContactTime || currentTimeISO,\n    last_activity_time: currentTimeISO,\n    \n    // –î–∞–Ω–Ω—ã–µ –æ —Å–æ–±—ã—Ç–∏–∏\n    event_type: inputData.eventType || 'email_activity',\n    message_count: inputData.messageCount || 0,\n    \n    // –î–∞–Ω–Ω—ã–µ –æ –∫–ª–∏–µ–Ω—Ç–µ\n    subject: inputData.subject || '',\n    language: inputData.language || 'ru',\n    lead_score: inputData.leadScore || 0,\n    intent: inputData.intent || 'information',\n    urgency: inputData.urgency || 'medium',\n    \n    // –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–ø–∏—Å–∫–∏\n    status: inputData.status || 'active',\n    last_reply_from: inputData.lastReplyFrom || 'client',\n    follow_up_date: inputData.followUpDate || null\n};\n\nreturn [{json: monitoringData}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        -368
      ],
      "id": "c5065276-0e4b-42b1-9744-2abebda53731",
      "name": "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Email"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ email –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\n-- –¢–∞–±–ª–∏—Ü–∞: {{ $('‚öôÔ∏è CONFIG (Save)').item.json.table_email_monitoring }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nINSERT INTO {{ $('‚öôÔ∏è CONFIG (Save)').item.json.table_email_monitoring }} (\n    record_id, \n    record_timestamp, \n    email, \n    thread_id, \n    user_name,\n    timestamp, \n    first_contact_time, \n    last_activity_time,\n    event_type, \n    message_count, \n    subject, \n    language,\n    lead_score, \n    intent, \n    urgency, \n    status, \n    last_reply_from, \n    follow_up_date\n)\nVALUES (\n    '{{ $json.recordId }}',\n    '{{ $json.recordTimestamp }}',\n    '{{ $json.email }}',\n    '{{ $json.thread_id }}',\n    '{{ $json.user_name }}',\n    '{{ $json.timestamp }}',\n    '{{ $json.first_contact_time }}',\n    '{{ $json.last_activity_time }}',\n    '{{ $json.event_type }}',\n    {{ $json.message_count }},\n    '{{ $json.subject.replace(/'/g, \"''\") }}',\n    '{{ $json.language }}',\n    {{ $json.lead_score }},\n    '{{ $json.intent }}',\n    '{{ $json.urgency }}',\n    '{{ $json.status }}',\n    '{{ $json.last_reply_from }}',\n    {{ $json.follow_up_date ? \"'\" + $json.follow_up_date + \"'\" : 'NULL' }}\n)\nON CONFLICT (email) \nDO UPDATE SET\n    thread_id = EXCLUDED.thread_id,\n    user_name = EXCLUDED.user_name,\n    last_activity_time = EXCLUDED.last_activity_time,\n    message_count = EXCLUDED.message_count,\n    subject = EXCLUDED.subject,\n    language = EXCLUDED.language,\n    lead_score = GREATEST({{ $('‚öôÔ∏è CONFIG (Save)').item.json.table_email_monitoring }}.lead_score, EXCLUDED.lead_score),\n    intent = EXCLUDED.intent,\n    urgency = EXCLUDED.urgency,\n    status = EXCLUDED.status,\n    last_reply_from = EXCLUDED.last_reply_from,\n    follow_up_date = EXCLUDED.follow_up_date,\n    updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -128,
        -368
      ],
      "id": "087faa8f-ca79-4ff0-a3c7-e3a52e3f38bf",
      "name": "üêò –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"status\": \"success\",\n  \"message\": \"Email monitoring data saved\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        80,
        -368
      ],
      "id": "150ea984-d748-4c41-bfc3-db12d86dacbe",
      "name": "‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç"
    },
    {
      "parameters": {
        "path": "email-monitoring-data",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -736,
        -96
      ],
      "id": "9c12dfb7-fa69-496f-9f39-09a10389e2e5",
      "name": "üåê Webhook: Get Monitoring Data",
      "webhookId": "get-email-monitoring-webhook"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"api_key\": \"24fs-$r4d-defd-77ds-7eds\",\n  \"rate_limit_window_ms\": 60000,\n  \"rate_limit_max\": 60,\n  \"table_email_monitoring\": \"email_monitoring\",\n  \"table_email_dialog_analysis\": \"email_dialog_analysis\"\n}",
        "options": {}
      },
      "id": "config-get-monitoring",
      "name": "‚öôÔ∏è CONFIG (Monitoring)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -544,
        -96
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üîê SECURITY CHECK: API KEY + RATE LIMITING\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ —É–∑–ª–∞ CONFIG\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst config = $('‚öôÔ∏è CONFIG (Monitoring)').item.json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max;\n\nconst inputData = $('üåê Webhook: Get Monitoring Data').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        -96
      ],
      "id": "dec057b9-fac0-4cb0-b0e3-3a05d90b8dba",
      "name": "üîê Security Check (Monitoring)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -128,
        -96
      ],
      "id": "c8331e7b-d2cc-4acd-bdbb-fd3e5bdb471c",
      "name": "‚ùì Auth OK? (Monitoring)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        80,
        32
      ],
      "id": "c197d549-75f1-4d34-a36b-0e3a552197df",
      "name": "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Monitoring)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üìä –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ email –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞\n-- –¢–∞–±–ª–∏—Ü—ã: {{ $('‚öôÔ∏è CONFIG (Monitoring)').item.json.table_email_monitoring }},\n--          {{ $('‚öôÔ∏è CONFIG (Monitoring)').item.json.table_email_dialog_analysis }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nWITH email_stats AS (\n    SELECT \n        em.email,\n        em.user_name,\n        MIN(em.first_contact_time) as first_contact,\n        MAX(em.last_activity_time) as last_activity,\n        MAX(em.message_count) as messages,\n        -- –ü–æ–ª—É—á–∞–µ–º lead_score –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞\n        COALESCE(\n            (SELECT (lead_scoring->>'score')::integer \n             FROM {{ $('‚öôÔ∏è CONFIG (Monitoring)').item.json.table_email_dialog_analysis }} eda\n             WHERE eda.email = em.email \n             ORDER BY eda.created_at DESC \n             LIMIT 1), \n            0\n        ) as lead_score,\n        -- –î–û–ë–ê–í–õ–Ø–ï–ú satisfaction_percentage\n        COALESCE(\n            (SELECT satisfaction_percentage\n             FROM {{ $('‚öôÔ∏è CONFIG (Monitoring)').item.json.table_email_dialog_analysis }} eda\n             WHERE eda.email = em.email \n             ORDER BY eda.created_at DESC \n             LIMIT 1), \n            0\n        ) as satisfaction_percentage,\n        -- –¢–∞–∫–∂–µ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –ª–∏–¥–∞\n        COALESCE(\n            (SELECT lead_scoring->>'temperature'\n             FROM {{ $('‚öôÔ∏è CONFIG (Monitoring)').item.json.table_email_dialog_analysis }} eda\n             WHERE eda.email = em.email \n             ORDER BY eda.created_at DESC \n             LIMIT 1), \n            'cold'\n        ) as lead_temperature,\n        FIRST_VALUE(em.subject) OVER (PARTITION BY em.email ORDER BY em.timestamp DESC) as subject,\n        FIRST_VALUE(em.language) OVER (PARTITION BY em.email ORDER BY em.timestamp DESC) as language,\n        FIRST_VALUE(em.intent) OVER (PARTITION BY em.email ORDER BY em.timestamp DESC) as intent,\n        FIRST_VALUE(em.urgency) OVER (PARTITION BY em.email ORDER BY em.timestamp DESC) as urgency,\n        FIRST_VALUE(em.status) OVER (PARTITION BY em.email ORDER BY em.timestamp DESC) as status,\n        FIRST_VALUE(em.thread_id) OVER (PARTITION BY em.email ORDER BY em.timestamp DESC) as thread_id\n    FROM {{ $('‚öôÔ∏è CONFIG (Monitoring)').item.json.table_email_monitoring }} em\n    WHERE em.last_activity_time >= NOW() - INTERVAL '30 days'\n        AND em.email IS NOT NULL \n        AND em.email != ''\n    GROUP BY em.email, em.user_name, em.timestamp, em.subject, \n             em.language, em.intent, em.urgency, em.status, em.thread_id\n)\nSELECT DISTINCT ON (email) \n    *,\n    CASE \n        WHEN last_activity > NOW() - INTERVAL '24 hours' THEN 'active'\n        WHEN last_activity > NOW() - INTERVAL '7 days' THEN 'pending'\n        ELSE 'inactive'\n    END as activity_status\nFROM email_stats\nORDER BY email, last_activity DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        80,
        -160
      ],
      "id": "10ed660f-869c-464f-81c2-b2e69f0271ae",
      "name": "üêò –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Email",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìä –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–• –î–õ–Ø –î–ê–®–ë–û–†–î–ê\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –¥–ª—è email\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ email –ø–µ—Ä–µ–ø–∏—Å–∫–∏\nfunction getEmailConversationStatus(data) {\n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ë–î\n  const dbStatus = data.status;\n  const messageCount = parseInt(data.messages) || parseInt(data.message_count) || 0;\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏\n  const lastActivityDate = new Date(data.last_activity);\n  const daysSinceActivity = (Date.now() - lastActivityDate) / (1000 * 60 * 60 * 24);\n  \n  // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞\n  if (dbStatus === 'unread') {\n    return {\n      status: 'unread',\n      statusText: '–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ',\n      statusIcon: 'üîµ',\n      statusColor: '#3b82f6',\n      daysSince: daysSinceActivity\n    };\n  }\n  \n  if (messageCount === 0) {\n    return {\n      status: 'new',\n      statusText: '–ù–æ–≤–æ–µ',\n      statusIcon: 'üì•',\n      statusColor: '#22c55e',\n      daysSince: daysSinceActivity\n    };\n  }\n  \n  if (messageCount === 1) {\n    return {\n      status: 'awaiting_reply',\n      statusText: '–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞',\n      statusIcon: '‚è≥',\n      statusColor: '#f59e0b',\n      daysSince: daysSinceActivity\n    };\n  }\n  \n  if (messageCount > 3) {\n    if (daysSinceActivity > 7) {\n      return {\n        status: 'inactive',\n        statusText: '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è',\n        statusIcon: 'üí§',\n        statusColor: '#6b7280',\n        daysSince: daysSinceActivity\n      };\n    }\n    return {\n      status: 'conversation',\n      statusText: '–ü–µ—Ä–µ–ø–∏—Å–∫–∞',\n      statusIcon: 'üí¨',\n      statusColor: '#8b5cf6',\n      daysSince: daysSinceActivity\n    };\n  }\n  \n  if (daysSinceActivity < 1) {\n    return {\n      status: 'active',\n      statusText: '–ê–∫—Ç–∏–≤–Ω–∞—è',\n      statusIcon: 'üìß',\n      statusColor: '#059669',\n      daysSince: daysSinceActivity\n    };\n  }\n  \n  if (daysSinceActivity > 3) {\n    return {\n      status: 'pending',\n      statusText: '–í –æ–∂–∏–¥–∞–Ω–∏–∏',\n      statusIcon: '‚è∏Ô∏è',\n      statusColor: '#f59e0b',\n      daysSince: daysSinceActivity\n    };\n  }\n  \n  return {\n    status: 'active',\n    statusText: '–ê–∫—Ç–∏–≤–Ω–∞—è',\n    statusIcon: 'üìß',\n    statusColor: '#059669',\n    daysSince: daysSinceActivity\n  };\n}\n\n// –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Lead Score –∏ urgency\nfunction getEmailPriority(leadScore, urgency) {\n  const score = parseInt(leadScore) || 0;\n  \n  if (score >= 80 || urgency === 'high') {\n    return {\n      priority: 'high',\n      priorityText: '–í—ã—Å–æ–∫–∏–π',\n      priorityIcon: 'üî•',\n      priorityColor: '#dc2626'\n    };\n  }\n  \n  if (score >= 50 || urgency === 'medium') {\n    return {\n      priority: 'medium',\n      priorityText: '–°—Ä–µ–¥–Ω–∏–π',\n      priorityIcon: '‚ö°',\n      priorityColor: '#f59e0b'\n    };\n  }\n  \n  return {\n    priority: 'low',\n    priorityText: '–ù–∏–∑–∫–∏–π',\n    priorityIcon: '‚ùÑÔ∏è',\n    priorityColor: '#3b82f6'\n  };\n}\n\n// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nconst formattedData = items.map(item => {\n    const data = item.json;\n    \n    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (—Ç–µ–ø–µ—Ä—å —Å–æ —Å–≤–æ–π—Å—Ç–≤–æ–º daysSince)\n    const conversationStatus = getEmailConversationStatus(data);\n    \n    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç\n    const priority = getEmailPriority(data.lead_score, data.urgency);\n    \n    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –ª–∏–¥–∞\n    const leadScore = parseInt(data.lead_score) || 0;\n    const leadTemperature = leadScore >= 80 ? 'hot' : \n                           leadScore >= 50 ? 'warm' : 'cold';\n    \n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º daysSince –∏–∑ conversationStatus\n    const daysSinceActivity = conversationStatus.daysSince || 0;\n    \n    return {\n        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n        email: data.email,\n        threadId: data.thread_id,\n        userName: data.user_name || 'Unknown',\n        subject: data.subject || 'No subject',\n        \n        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏\n        firstContact: data.first_contact,\n        lastActivity: data.last_activity,\n        \n        // –ú–µ—Ç—Ä–∏–∫–∏\n        messageCount: parseInt(data.messages) || parseInt(data.message_count) || 0,\n        leadScore: leadScore,\n        satisfactionPercentage: parseInt(data.satisfaction_percentage) || 0,\n        \n        // –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (–æ—Å–Ω–æ–≤–Ω–æ–π)\n        conversationStatus: conversationStatus.status,\n        conversationStatusText: conversationStatus.statusText,\n        conversationStatusIcon: conversationStatus.statusIcon,\n        conversationStatusColor: conversationStatus.statusColor,\n        \n        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç\n        priority: priority.priority,\n        priorityText: priority.priorityText,\n        priorityIcon: priority.priorityIcon,\n        priorityColor: priority.priorityColor,\n        \n        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\n        language: data.language || 'ru',\n        intent: data.intent || 'information',\n        urgency: data.urgency || 'medium',\n        leadTemperature: leadTemperature,\n        \n        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\n        status: conversationStatus.status,\n        activityStatus: data.activity_status || conversationStatus.status,\n        followUpDate: data.follow_up_date,\n        \n        // –§–ª–∞–≥–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞\n        needsAttention: conversationStatus.status === 'awaiting_reply' || \n                        priority.priority === 'high',\n        isHotLead: leadTemperature === 'hot',\n        isInactive: daysSinceActivity > 7\n    };\n});\n\nreturn [{\n    json: {\n        data: formattedData,\n        totalCount: formattedData.length,\n        timestamp: new Date().toISOString()\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        -160
      ],
      "id": "5aa08342-1d76-4502-be27-09725a156922",
      "name": "üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        496,
        -160
      ],
      "id": "63f7ae3a-2374-4ca1-bcf3-96e352a79c10",
      "name": "‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
    },
    {
      "parameters": {
        "path": "email-dialogs",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -720,
        208
      ],
      "id": "16a98d5a-723a-4a4d-a3a8-95118b55aa68",
      "name": "üåê Webhook: Get Email Dialog",
      "webhookId": "get-email-dialog-webhook"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"api_key\": \"24fs-$r4d-defd-77ds-7eds\",\n  \"rate_limit_window_ms\": 60000,\n  \"rate_limit_max\": 60,\n  \"table_gmail_conversations\": \"gmail_conversations\"\n}",
        "options": {}
      },
      "id": "config-get-dialog",
      "name": "‚öôÔ∏è CONFIG (Dialog)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -512,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üîê SECURITY CHECK: API KEY + RATE LIMITING\n// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ —É–∑–ª–∞ CONFIG\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst config = $('‚öôÔ∏è CONFIG (Dialog)').item.json;\nconst API_KEY = config.api_key;\nconst RATE_LIMIT_WINDOW_MS = config.rate_limit_window_ms;\nconst RATE_LIMIT_MAX_REQUESTS = config.rate_limit_max;\n\nconst inputData = $('üåê Webhook: Get Email Dialog').item.json;\nconst body = inputData.body || {};\nconst headers = inputData.headers || {};\nconst query = inputData.query || {};\nconst clientIP = headers['x-real-ip'] || headers['x-forwarded-for'] || headers['cf-connecting-ip'] || 'unknown';\nconst now = Date.now();\n\n// RATE LIMITING\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.rateLimits) { staticData.rateLimits = {}; }\nfor (const ip in staticData.rateLimits) {\n  if (now - staticData.rateLimits[ip].firstRequest > RATE_LIMIT_WINDOW_MS) {\n    delete staticData.rateLimits[ip];\n  }\n}\nif (!staticData.rateLimits[clientIP]) {\n  staticData.rateLimits[clientIP] = { count: 1, firstRequest: now };\n} else {\n  staticData.rateLimits[clientIP].count++;\n  if (staticData.rateLimits[clientIP].count > RATE_LIMIT_MAX_REQUESTS) {\n    return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Too many requests', details: `Limit: ${RATE_LIMIT_MAX_REQUESTS} requests per minute`, status: 429, retryAfter: Math.ceil((staticData.rateLimits[clientIP].firstRequest + RATE_LIMIT_WINDOW_MS - now) / 1000) } } }];\n  }\n}\n\n// API KEY CHECK\nconst providedKey = headers['x-api-key'] || body.apiKey || query.apiKey || '';\nif (!providedKey) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'API key not provided', status: 401 } } }];\n}\nif (providedKey !== API_KEY) {\n  return [{ json: { ...inputData, authorized: false, error: { success: false, error: 'Invalid API key', status: 401 } } }];\n}\n\nreturn [{ json: { ...inputData, authorized: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        208
      ],
      "id": "196229fe-e8d5-4566-a558-2a15f35e4259",
      "name": "üîê Security Check (Dialog)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "auth-condition",
              "leftValue": "={{ $json.authorized }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -96,
        208
      ],
      "id": "48e6ff5d-1d38-4b13-8f72-f96a26f72257",
      "name": "‚ùì Auth OK? (Dialog)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.error }}",
        "options": {
          "responseCode": "={{ $json.error.status }}"
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        112,
        336
      ],
      "id": "285e6c11-8e53-42f1-a1c1-4e1c34aa3756",
      "name": "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Dialog)"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìù –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–ü–†–û–°–ê –î–ò–ê–õ–û–ì–ê\n// –ü–æ–ª—É—á–∞–µ–º email –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst webhookData = $('üåê Webhook: Get Email Dialog').item.json;\nconst email = webhookData.query?.email;\nconst threadId = webhookData.query?.thread_id;\n\nif (!email && !threadId) {\n    throw new Error('email or thread_id parameter is required');\n}\n\nreturn [{\n    json: {\n        email: email,\n        thread_id: threadId\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        144
      ],
      "id": "07f8e81f-7456-42e3-8801-5a8897784eef",
      "name": "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–∏–∞–ª–æ–≥–∞"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n-- üí¨ –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏–∑ gmail_conversations\n-- –¢–∞–±–ª–∏—Ü–∞: {{ $('‚öôÔ∏è CONFIG (Dialog)').item.json.table_gmail_conversations }}\n-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nSELECT \n    email,\n    thread_id,\n    subject,\n    messages,\n    status,\n    lead_score,\n    language,\n    message_count,\n    created_at,\n    updated_at\nFROM {{ $('‚öôÔ∏è CONFIG (Dialog)').item.json.table_gmail_conversations }}\nWHERE \n    {{ $json.email ? \"email = '\" + $json.email + \"'\" : \"1=1\" }}\n    {{ $json.thread_id ? \"AND thread_id = '\" + $json.thread_id + \"'\" : \"\" }}\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        320,
        144
      ],
      "id": "768cb3d3-e7d1-4f10-a8b0-650a8066b7dc",
      "name": "üêò –ü–æ–ª—É—á–µ–Ω–∏–µ Gmail –ø–µ—Ä–µ–ø–∏—Å–∫–∏",
      "credentials": {
        "postgres": {
          "id": "dPjh4Kdb4nIbCTQG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üìß –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï EMAIL –î–ò–ê–õ–û–ì–ê\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ\nif (!items || items.length === 0 || !items[0].json) {\n    return [{\n        json: {\n            dialogs: [],\n            message: \"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ email\"\n        }\n    }];\n}\n\nconst conversation = items[0].json;\n\n// –ü–∞—Ä—Å–∏–º JSON —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏\nlet messages = [];\ntry {\n    messages = typeof conversation.messages === 'string' \n        ? JSON.parse(conversation.messages) \n        : conversation.messages;\n} catch (e) {\n    messages = [];\n}\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞\nconst formattedDialogs = messages.map((msg, index) => {\n    return {\n        id: `${conversation.thread_id}_${index}`,\n        email: conversation.email,\n        thread_id: conversation.thread_id,\n        message_type: msg.type === 'incoming' ? 'user' : 'bot',\n        message_text: msg.content || '',\n        timestamp: msg.date || conversation.created_at,\n        language: conversation.language || 'unknown',\n        language_flag: conversation.language === 'ru' ? 'üá∑üá∫' : 'üá¨üáß',\n        subject: conversation.subject\n    };\n});\n\nreturn [{json: {dialogs: formattedDialogs}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        144
      ],
      "id": "f03888a0-8e76-4ede-8146-663a609e7197",
      "name": "üìß –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        736,
        144
      ],
      "id": "cc457f1b-6ad2-46ca-ac5c-5ca79462420b",
      "name": "‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∏–∞–ª–æ–≥–∞"
    }
  ],
  "pinData": {},
  "connections": {
    "üåê Webhook: Save Monitoring": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è CONFIG (Save)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è CONFIG (Save)": {
      "main": [
        [
          {
            "node": "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Email": {
      "main": [
        [
          {
            "node": "üêò –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞": {
      "main": [
        [
          {
            "node": "‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üåê Webhook: Get Monitoring Data": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è CONFIG (Monitoring)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è CONFIG (Monitoring)": {
      "main": [
        [
          {
            "node": "üîê Security Check (Monitoring)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê Security Check (Monitoring)": {
      "main": [
        [
          {
            "node": "‚ùì Auth OK? (Monitoring)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Auth OK? (Monitoring)": {
      "main": [
        [
          {
            "node": "üêò –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Monitoring)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö Email": {
      "main": [
        [
          {
            "node": "üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö": {
      "main": [
        [
          {
            "node": "‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üåê Webhook: Get Email Dialog": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è CONFIG (Dialog)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è CONFIG (Dialog)": {
      "main": [
        [
          {
            "node": "üîê Security Check (Dialog)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê Security Check (Dialog)": {
      "main": [
        [
          {
            "node": "‚ùì Auth OK? (Dialog)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì Auth OK? (Dialog)": {
      "main": [
        [
          {
            "node": "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–∏–∞–ª–æ–≥–∞",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Dialog)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–∏–∞–ª–æ–≥–∞": {
      "main": [
        [
          {
            "node": "üêò –ü–æ–ª—É—á–µ–Ω–∏–µ Gmail –ø–µ—Ä–µ–ø–∏—Å–∫–∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üêò –ü–æ–ª—É—á–µ–Ω–∏–µ Gmail –ø–µ—Ä–µ–ø–∏—Å–∫–∏": {
      "main": [
        [
          {
            "node": "üìß –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìß –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞": {
      "main": [
        [
          {
            "node": "‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∏–∞–ª–æ–≥–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "production-ru-v1",
  "meta": {
    "instanceId": "9a2a948e1b1119e76dce477f4f08641c41898f344f4216cb90098437b1dcaf00"
  },
  "id": "email-monitoring-production-ru",
  "tags": []
}
